import{createRequire as w}from"node:module";var M=Object.create;var{getPrototypeOf:V,defineProperty:Q,getOwnPropertyNames:S}=Object;var b=Object.prototype.hasOwnProperty;var y=(A,B,E)=>{E=A!=null?M(V(A)):{};let H=B||!A||!A.__esModule?Q(E,"default",{value:A,enumerable:!0}):E;for(let J of S(A))if(!b.call(H,J))Q(H,J,{get:()=>A[J],enumerable:!0});return H};var p=(A,B)=>()=>(B||A((B={exports:{}}).exports,B),B.exports);var k=(A,B)=>{for(var E in B)Q(A,E,{get:B[E],enumerable:!0,configurable:!0,set:(H)=>B[E]=()=>H})};var T=w(import.meta.url);class W{options;technicalTerms;stopWords;contextModel;ngramFrequency;static PRECOMPILED_PATTERNS={camelCase:/\b[a-z]+[A-Z][a-zA-Z0-9]*\b/g,snakeCase:/\b[a-z][a-z0-9]*_[a-z0-9_]*\b/g,kebabCase:/\b[a-z][a-z0-9]*-[a-z0-9-]*\b/g,pascalCase:/\b[A-Z][a-zA-Z0-9]*[A-Z][a-zA-Z0-9]*\b/g,version:/\bv?(?:\d+\.)+\d+(?:-[a-zA-Z0-9]+)?\b/g,technical:/\b[A-Z]{2,}\b/g,numbers:/\b\d+(?:\.\d+)?[kmg]?b?\b/gi,filePath:/\b(?:\/|[a-zA-Z]:\\)[^\s<>:"|?*]+\b/g,identifiers:/\b[a-zA-Z_][a-zA-Z0-9_]*\b/g,methodCalls:/\b([a-zA-Z_][a-zA-Z0-9_]*)\s*\(/g,urls:/https?:\/\/[^\s<>"{}|\\^`\[\]]+/g,email:/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g,unicode:/[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]/gu};constructor(A={}){this.options={language:"en",preserveCase:!1,extractCamelCase:!0,extractTechnicalTerms:!0,useNgrams:!0,extractCompoundWords:!0,useContextualScoring:!0,codeAware:!0,minTokenLength:1,maxTokenLength:100,...A},this.initialize()}initialize(){this.technicalTerms=new Set(["function","class","const","let","var","import","export","default","async","await","promise","callback","interface","type","enum","react","vue","angular","component","hook","state","props","api","http","https","json","xml","yaml","config","env","database","query","index","cache","server","client","get","set","is","has","can","should","will","dir","file","path"]),this.stopWords=new Set(["the","be","to","of","and","a","in","that","have","i","it","for","not","on","with","he","as","you","do","at","this","but","his","by","from"]),this.contextModel=new Map,this.ngramFrequency=new Map,this.buildContextModel(),this.loadPretrainedNGrams()}tokenize(A){if(!A||A.trim().length===0)return[];let B=[],E=0;if(this.options.codeAware)B.push(...this.extractCodeTokens(A));if(B.push(...this.extractWordTokens(A)),this.options.extractTechnicalTerms)B.push(...this.extractTechnicalTokens(A));if(this.options.useNgrams)B.push(...this.extractNGrams(A));if(this.options.extractCompoundWords)B.push(...this.extractCompoundWords(A));return this.postProcessTokens(B)}extractCodeTokens(A){let B=[],E=[{regex:W.PRECOMPILED_PATTERNS.camelCase,type:"identifier"},{regex:W.PRECOMPILED_PATTERNS.snakeCase,type:"identifier"},{regex:W.PRECOMPILED_PATTERNS.pascalCase,type:"identifier"},{regex:W.PRECOMPILED_PATTERNS.version,type:"version"},{regex:W.PRECOMPILED_PATTERNS.technical,type:"technical"},{regex:W.PRECOMPILED_PATTERNS.methodCalls,type:"method"},{regex:W.PRECOMPILED_PATTERNS.urls,type:"url"},{regex:W.PRECOMPILED_PATTERNS.email,type:"email"}];for(let{regex:H,type:J}of E){let K;H.lastIndex=0;while((K=H.exec(A))!==null){let O=K[1]||K[0];if(O.length>=this.options.minTokenLength){let U=this.processCodeToken(O,K.index,J);B.push(...U)}}}return B}processCodeToken(A,B,E){let H=[];if(E==="identifier"&&/[a-z][A-Z]/.test(A)){let J=A.split(/(?=[A-Z])/);for(let K of J){if(K.length>=this.options.minTokenLength)H.push(this.createToken(K,"identifier",B));B+=K.length}}else H.push(this.createToken(A,E,B));return H}extractWordTokens(A){let B=[],E=A.match(/\b[a-zA-Z]+\b/g)||[];for(let H of E)if(H.length>=this.options.minTokenLength&&H.length<=this.options.maxTokenLength&&!this.stopWords.has(H.toLowerCase()))B.push(this.createToken(H,"word",A.indexOf(H)));return B}extractTechnicalTokens(A){let B=[];for(let E of this.technicalTerms){let H=new RegExp(`\\b${E}\\b`,"gi"),J;while((J=H.exec(A))!==null)B.push(this.createToken(J[0],"technical",J.index))}return B}extractNGrams(A){let B=[],E=A.toLowerCase().split(/\s+/).filter((H)=>H.length>2);for(let H=2;H<=3;H++)for(let J=0;J<=E.length-H;J++){let K=E.slice(J,J+H).join("");if((this.ngramFrequency.get(K)||0)>0.1){let U=A.toLowerCase().indexOf(K);B.push(this.createToken(K,"ngram",U))}}return B}extractCompoundWords(A){let B=[],E=[/\b([a-z]+)([A-Z][a-z]+)\b/g,/\b(get|set|is|has|can|should|will)([A-Z][a-z]+)\b/gi];for(let H of E){let J;while((J=H.exec(A))!==null){let K=J[0],O=J.index;B.push(this.createToken(K.toLowerCase(),"compound",O))}}return B}createToken(A,B,E){let H=this.options.preserveCase?A:A.toLowerCase(),J={hasNumbers:/\d/.test(H),hasSymbols:/[^a-zA-Z0-9]/.test(H),caseType:this.detectCaseType(H),frequency:this.getWordFrequency(H),confidence:this.calculateConfidence(H,B)},K=this.calculateTokenScore(H,B,J);return{text:H,type:B,score:K,position:E,length:A.length,features:J}}detectCaseType(A){if(A===A.toUpperCase())return"upper";if(A===A.toLowerCase())return"lower";if(A.includes("_"))return"snake";if(/[A-Z]/.test(A)&&/[a-z]/.test(A))return"camel";return"mixed"}calculateConfidence(A,B){let E=0.5;if(A.length>=4&&A.length<=12)E+=0.2;if(B==="technical"||B==="identifier")E+=0.3;if(B==="keyword")E+=0.2;if(this.technicalTerms.has(A.toLowerCase()))E+=0.2;return Math.min(1,E)}calculateTokenScore(A,B,E){let H=0.5;if(A.length>6)H+=0.1;if(A.length>10)H+=0.1;if(B==="technical")H+=0.3;if(B==="identifier")H+=0.2;if(B==="version"||B==="url")H+=0.2;if(E.hasNumbers)H+=0.1;if(E.hasSymbols&&B!=="url")H+=0.1;if(E.frequency<10)H+=0.2;return Math.min(1,H)}getWordFrequency(A){return Math.floor(Math.random()*100)}postProcessTokens(A){let B=new Map;for(let E of A){let H=B.get(E.text);if(!H||E.score>H.score)B.set(E.text,E)}return Array.from(B.values()).sort((E,H)=>{if(H.score!==E.score)return H.score-E.score;return E.position-H.position}).filter((E)=>E.score>0.1)}buildContextModel(){let A={function:["(",")","{"],class:["{","constructor"],import:["from","as"],const:["=",";"],get:["(",")"],set:["(",")"],is:["(",")"],has:["(",")"]};for(let[B,E]of Object.entries(A))this.contextModel.set(B,E)}loadPretrainedNGrams(){let A={getuser:0.8,setstate:0.7,useeffect:0.9,componentdidmount:0.8,onclick:0.9};for(let[B,E]of Object.entries(A))this.ngramFrequency.set(B,E)}}async function f(A,B){try{let E=await A.getAllCodebaseFiles();if(B){if(B.file_extensions&&B.file_extensions.length>0)E=E.filter((O)=>B.file_extensions?.some((U)=>O.path.endsWith(U)));if(B.path_filter)E=E.filter((O)=>O.path.includes(B.path_filter));if(B.exclude_paths&&B.exclude_paths.length>0)E=E.filter((O)=>!B.exclude_paths?.some((U)=>O.path.includes(U)))}if(E.length===0)return null;let H=[];for(let O of E){let U=await A.getTFIDFDocument(O.path);if(U){let R=U.rawTerms||{},$=new Map,G=new Map;for(let[Y,C]of Object.entries(R))$.set(Y,C),G.set(Y,C);H.push({uri:`file://${O.path}`,terms:$,rawTerms:G,magnitude:U.magnitude})}}if(H.length===0)return null;let J=await A.getIDFValues(),K=new Map;for(let[O,U]of Object.entries(J))K.set(O,U);return{documents:H,idf:K,totalDocuments:H.length,metadata:{generatedAt:new Date().toISOString(),version:"1.0.0"}}}catch(E){return console.error("[ERROR] Failed to build search index from database:",E),null}}function j(A){let B=Array.from(A.values()).reduce((H,J)=>H+J,0),E=new Map;for(let[H,J]of A.entries())E.set(H,J/B);return E}function g(A,B){let E=new Map;for(let J of A){let K=new Set(J.keys());for(let O of K)E.set(O,(E.get(O)||0)+1)}let H=new Map;for(let[J,K]of E.entries())H.set(J,Math.log(B/K));return H}function I(A,B){let E=new Map;for(let[H,J]of A.entries()){let K=B.get(H)||0;E.set(H,J*K)}return E}function v(A){let B=0;for(let E of A.values())B+=E*E;return Math.sqrt(B)}function D(A){let E=new W({language:"en",extractCamelCase:!0,extractTechnicalTerms:!0,useNgrams:!0,extractCompoundWords:!0,useContextualScoring:!0,codeAware:!0}).tokenize(A),H=new Map;for(let J of E){let K=J.text.toLowerCase(),O=H.get(K)||0;H.set(K,O+J.score)}return H}function h(A){let E=new W({language:"en",extractCamelCase:!0,extractTechnicalTerms:!0,useNgrams:!1,extractCompoundWords:!1,useContextualScoring:!1,codeAware:!0}).tokenize(A),H=new Map;for(let J of E){let K=J.text.toLowerCase();if(!H.has(K)||J.score>0.8)H.set(K,J.text)}return Array.from(H.values())}function d(A){let B=A.map((J)=>({uri:J.uri,terms:D(J.content)})),E=g(B.map((J)=>J.terms),A.length);return{documents:B.map((J)=>{let K=j(J.terms),O=I(K,E),U=v(O);return{uri:J.uri,terms:O,rawTerms:J.terms,magnitude:U}}),idf:E,totalDocuments:A.length,metadata:{generatedAt:new Date().toISOString(),version:"2.0.0"}}}function F(A,B){let E=0;for(let[J,K]of A.entries()){let O=B.terms.get(J)||0;E+=K*O}let H=v(A);if(H===0||B.magnitude===0)return 0;return E/(H*B.magnitude)}function z(A,B){let E=D(A),H=j(E);return I(H,B)}function a(A,B,E={}){let{limit:H=10,minScore:J=0,boostFactors:K={}}=E,{exactMatch:O=1.5,phraseMatch:U=2,technicalMatch:R=1.8,identifierMatch:$=1.3}=K,G=z(A,B.idf),Y=h(A).map((X)=>X.toLowerCase());return B.documents.map((X)=>{let Z=F(G,X),L=[];for(let N of Y)if(X.rawTerms.has(N)){let _=O;if(P(N))_=Math.max(_,R);if(q(N))_=Math.max(_,$);Z*=_,L.push(N)}if(L.length===Y.length&&Y.length>1)Z*=U;if(Y.length>3&&L.length>=Y.length*0.7)Z*=1.2;return{uri:X.uri,score:Z,matchedTerms:L}}).filter((X)=>X.score>=J).sort((X,Z)=>Z.score-X.score).slice(0,H)}function P(A){return[/\b[A-Z]{2,}\b/,/\b[A-Z][a-z]+(?:[A-Z][a-z]+)+\b/,/\b[a-z]+[A-Z][a-z]*\b/,/\b\w+(?:Dir|Config|File|Path|Data|Service|Manager|Handler)\b/,/\b(?:get|set|is|has|can|should|will|do)[A-Z]\w*\b/,/\b(?:http|https|json|xml|yaml|sql|api|url|uri)\b/].some((E)=>E.test(A))}function q(A){return/^[a-zA-Z][a-zA-Z0-9_]*$/.test(A)&&A.length>1}function c(A){let B={documents:A.documents.map((E)=>({uri:E.uri,terms:Array.from(E.terms.entries()),rawTerms:Array.from(E.rawTerms.entries()),magnitude:E.magnitude})),idf:Array.from(A.idf.entries()),totalDocuments:A.totalDocuments,metadata:A.metadata};return JSON.stringify(B,null,2)}function i(A){let B=JSON.parse(A);return{documents:B.documents.map((E)=>({uri:E.uri,terms:new Map(E.terms),rawTerms:new Map(E.rawTerms),magnitude:E.magnitude})),idf:new Map(B.idf),totalDocuments:B.totalDocuments,metadata:B.metadata}}export{c as serializeIndex,a as searchDocuments,z as processQuery,i as deserializeIndex,F as calculateCosineSimilarity,f as buildSearchIndexFromDB,d as buildSearchIndex};
export{y as a,p as b,k as c,T as d,d as e,a as f};
