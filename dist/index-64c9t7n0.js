import{y as Z4}from"./paths-msn59g0z.js";import{C as v8}from"./index-57rg6dr5.js";import{S as p1,T as d,U as O5,V as h}from"./index-5wbetp1c.js";var mX=d((R1)=>{var n5=R1&&R1.__createBinding||(Object.create?function(X,$,Z,Y){if(Y===void 0)Y=Z;var G=Object.getOwnPropertyDescriptor($,Z);if(!G||("get"in G?!$.__esModule:G.writable||G.configurable))G={enumerable:!0,get:function(){return $[Z]}};Object.defineProperty(X,Y,G)}:function(X,$,Z,Y){if(Y===void 0)Y=Z;X[Y]=$[Z]}),l5=R1&&R1.__setModuleDefault||(Object.create?function(X,$){Object.defineProperty(X,"default",{enumerable:!0,value:$})}:function(X,$){X.default=$}),dX=R1&&R1.__importStar||function(X){if(X&&X.__esModule)return X;var $={};if(X!=null){for(var Z in X)if(Z!=="default"&&Object.prototype.hasOwnProperty.call(X,Z))n5($,X,Z)}return l5($,X),$};Object.defineProperty(R1,"__esModule",{value:!0});R1.load=R1.currentTarget=void 0;var o5=dX(h("path")),s5=dX(h("fs"));function r5(){let X=null;switch(process.platform){case"android":switch(process.arch){case"arm":return"android-arm-eabi";case"arm64":return"android-arm64"}X="Android";break;case"win32":switch(process.arch){case"x64":return"win32-x64-msvc";case"arm64":return"win32-arm64-msvc";case"ia32":return"win32-ia32-msvc"}X="Windows";break;case"darwin":switch(process.arch){case"x64":return"darwin-x64";case"arm64":return"darwin-arm64"}X="macOS";break;case"linux":switch(process.arch){case"x64":case"arm64":return t5()?`linux-${process.arch}-gnu`:`linux-${process.arch}-musl`;case"arm":return"linux-arm-gnueabihf"}X="Linux";break;case"freebsd":if(process.arch==="x64")return"freebsd-x64";X="FreeBSD";break}if(X)throw Error(`Neon: unsupported ${X} architecture: ${process.arch}`);throw Error(`Neon: unsupported system: ${process.platform}`)}R1.currentTarget=r5;function t5(){let X=process.report?.getReport();if(typeof X!=="object"||!X||!("header"in X))return!1;let $=X.header;return typeof $==="object"&&!!$&&"glibcVersionRuntime"in $}function a5(X){let $=o5.join(X,"index.node");return s5.existsSync($)?h($):null}R1.load=a5});var iX=d((q3,cX)=>{var uX=()=>process.platform==="linux",Q4=null,e5=()=>{if(!Q4)Q4=uX()&&process.report?process.report.getReport():{};return Q4};cX.exports={isLinux:uX,getReport:e5}});var oX=d((h3,lX)=>{var nX=h("fs"),XY=(X)=>nX.readFileSync(X,"utf-8"),$Y=(X)=>new Promise(($,Z)=>{nX.readFile(X,"utf-8",(Y,G)=>{if(Y)Z(Y);else $(G)})});lX.exports={LDD_PATH:"/usr/bin/ldd",readFileSync:XY,readFile:$Y}});var O$=d((S3,A$)=>{var rX=h("child_process"),{isLinux:y2,getReport:tX}=iX(),{LDD_PATH:W6,readFile:aX,readFileSync:eX}=oX(),C1,v1,e1="",X$=()=>{if(!e1)return new Promise((X)=>{rX.exec("getconf GNU_LIBC_VERSION 2>&1 || true; ldd --version 2>&1 || true",($,Z)=>{e1=$?" ":Z,X(e1)})});return e1},$$=()=>{if(!e1)try{e1=rX.execSync("getconf GNU_LIBC_VERSION 2>&1 || true; ldd --version 2>&1 || true",{encoding:"utf8"})}catch(X){e1=" "}return e1},g1="glibc",Z$=/GLIBC\s(\d+\.\d+)/,R2="musl",ZY=g1.toUpperCase(),YY=R2.toLowerCase(),GY=(X)=>X.includes("libc.musl-")||X.includes("ld-musl-"),Y$=()=>{let X=tX();if(X.header&&X.header.glibcVersionRuntime)return g1;if(Array.isArray(X.sharedObjects)){if(X.sharedObjects.some(GY))return R2}return null},G$=(X)=>{let[$,Z]=X.split(/[\r\n]+/);if($&&$.includes(g1))return g1;if(Z&&Z.includes(R2))return R2;return null},J$=(X)=>{if(X.includes(YY))return R2;if(X.includes(ZY))return g1;return null},JY=async()=>{if(C1!==void 0)return C1;C1=null;try{let X=await aX(W6);C1=J$(X)}catch(X){}return C1},_Y=()=>{if(C1!==void 0)return C1;C1=null;try{let X=eX(W6);C1=J$(X)}catch(X){}return C1},_$=async()=>{let X=null;if(y2()){if(X=await JY(),!X)X=Y$();if(!X){let $=await X$();X=G$($)}}return X},z$=()=>{let X=null;if(y2()){if(X=_Y(),!X)X=Y$();if(!X){let $=$$();X=G$($)}}return X},zY=async()=>y2()&&await _$()!==g1,HY=()=>y2()&&z$()!==g1,WY=async()=>{if(v1!==void 0)return v1;v1=null;try{let $=(await aX(W6)).match(Z$);if($)v1=$[1]}catch(X){}return v1},AY=()=>{if(v1!==void 0)return v1;v1=null;try{let $=eX(W6).match(Z$);if($)v1=$[1]}catch(X){}return v1},H$=()=>{let X=tX();if(X.header&&X.header.glibcVersionRuntime)return X.header.glibcVersionRuntime;return null},sX=(X)=>X.trim().split(/\s+/)[1],W$=(X)=>{let[$,Z,Y]=X.split(/[\r\n]+/);if($&&$.includes(g1))return sX($);if(Z&&Y&&Z.includes(R2))return sX(Y);return null},OY=async()=>{let X=null;if(y2()){if(X=await WY(),!X)X=H$();if(!X){let $=await X$();X=W$($)}}return X},KY=()=>{let X=null;if(y2()){if(X=AY(),!X)X=H$();if(!X){let $=$$();X=W$($)}}return X};A$.exports={GLIBC:g1,MUSL:R2,family:_$,familySync:z$,isNonGlibcLinux:zY,isNonGlibcLinuxSync:HY,version:OY,versionSync:KY}});var D$=d((k3,K$)=>{var DY={ALLOW:0,DENY:1};K$.exports=DY});var V$=d((y3,U$)=>{var j4={value:"SqliteError",writable:!0,enumerable:!1,configurable:!0};function I2(X,$,Z){if(new.target!==I2)return new I2(X,$);if(typeof $!=="string")throw TypeError("Expected second argument to be a string");Error.call(this,X),j4.value=""+X,Object.defineProperty(this,"message",j4),Error.captureStackTrace(this,I2),this.code=$,this.rawCode=Z}Object.setPrototypeOf(I2,Error);Object.setPrototypeOf(I2.prototype,Error.prototype);Object.defineProperty(I2.prototype,"name",j4);U$.exports=I2});var P$=d((f3,A6)=>{var __dirname="/Users/kyle/rules/node_modules/libsql",{load:UY,currentTarget:VY}=mX(),{familySync:R$,GLIBC:RY,MUSL:IY}=O$();function FY(){if(process.env.LIBSQL_JS_DEV)return UY(__dirname);let X=VY();if(R$()==RY)switch(X){case"linux-x64-musl":X="linux-x64-gnu";break;case"linux-arm64-musl":X="linux-arm64-gnu";break}if(X==="linux-arm-gnueabihf"&&R$()==IY)X="linux-arm-musleabihf";return h(`@libsql/${X}`)}var{databaseOpen:NY,databaseOpenWithSync:MY,databaseInTransaction:EY,databaseInterrupt:xY,databaseClose:PY,databaseSyncSync:QY,databaseSyncUntilSync:jY,databaseExecSync:BY,databasePrepareSync:TY,databaseDefaultSafeIntegers:wY,databaseAuthorizer:LY,databaseLoadExtension:CY,databaseMaxWriteReplicationIndex:vY,statementRaw:qY,statementIsReader:hY,statementGet:I$,statementRun:F$,statementInterrupt:SY,statementRowsSync:N$,statementColumns:kY,statementSafeIntegers:yY,rowsNext:fY}=FY(),gY=D$(),M$=V$();function f2(X){if(X.libsqlError)return new M$(X.message,X.code,X.rawCode);return X}class E${constructor(X,$){let Z=$?.encryptionCipher??"aes256cbc";if($&&$.syncUrl){var Y="";if($.syncAuth)console.warn("Warning: The `syncAuth` option is deprecated, please use `authToken` option instead."),Y=$.syncAuth;else if($.authToken)Y=$.authToken;let J=$?.encryptionKey??"",_=$?.syncPeriod??0,z=$?.readYourWrites??!0,H=$?.offline??!1,W=$?.remoteEncryptionKey??"";this.db=MY(X,$.syncUrl,Y,Z,J,_,z,H,W)}else{let J=$?.authToken??"",_=$?.encryptionKey??"",z=$?.timeout??0,H=$?.remoteEncryptionKey??"";this.db=NY(X,J,Z,_,z,H)}this.memory=X===":memory:",this.readonly=!1,this.name="",this.open=!0;let G=this.db;Object.defineProperties(this,{inTransaction:{get(){return EY(G)}}})}sync(){return QY.call(this.db)}syncUntil(X){return jY.call(this.db,X)}prepare(X){try{let $=TY.call(this.db,X);return new x$($)}catch($){throw f2($)}}transaction(X){if(typeof X!=="function")throw TypeError("Expected first argument to be a function");let $=this,Z=(G)=>{return(...J)=>{$.exec("BEGIN "+G);try{let _=X(...J);return $.exec("COMMIT"),_}catch(_){throw $.exec("ROLLBACK"),_}}},Y={default:{value:Z("")},deferred:{value:Z("DEFERRED")},immediate:{value:Z("IMMEDIATE")},exclusive:{value:Z("EXCLUSIVE")},database:{value:this,enumerable:!0}};return Object.defineProperties(Y.default.value,Y),Object.defineProperties(Y.deferred.value,Y),Object.defineProperties(Y.immediate.value,Y),Object.defineProperties(Y.exclusive.value,Y),Y.default.value}pragma(X,$){if($==null)$={};if(typeof X!=="string")throw TypeError("Expected first argument to be a string");if(typeof $!=="object")throw TypeError("Expected second argument to be an options object");let Z=$.simple,Y=this.prepare(`PRAGMA ${X}`,this,!0);return Z?Y.pluck().get():Y.all()}backup(X,$){throw Error("not implemented")}serialize(X){throw Error("not implemented")}function(X,$,Z){if($==null)$={};if(typeof $==="function")Z=$,$={};if(typeof X!=="string")throw TypeError("Expected first argument to be a string");if(typeof Z!=="function")throw TypeError("Expected last argument to be a function");if(typeof $!=="object")throw TypeError("Expected second argument to be an options object");if(!X)throw TypeError("User-defined function name cannot be an empty string");throw Error("not implemented")}aggregate(X,$){if(typeof X!=="string")throw TypeError("Expected first argument to be a string");if(typeof $!=="object"||$===null)throw TypeError("Expected second argument to be an options object");if(!X)throw TypeError("User-defined function name cannot be an empty string");throw Error("not implemented")}table(X,$){if(typeof X!=="string")throw TypeError("Expected first argument to be a string");if(!X)throw TypeError("Virtual table module name cannot be an empty string");throw Error("not implemented")}authorizer(X){LY.call(this.db,X)}loadExtension(...X){CY.call(this.db,...X)}maxWriteReplicationIndex(){return vY.call(this.db)}exec(X){try{BY.call(this.db,X)}catch($){throw f2($)}}interrupt(){xY.call(this.db)}close(){PY.call(this.db),this.open=!1}defaultSafeIntegers(X){return wY.call(this.db,X??!0),this}unsafeMode(...X){throw Error("not implemented")}}class x${constructor(X){this.stmt=X,this.pluckMode=!1}raw(X){return qY.call(this.stmt,X??!0),this}pluck(X){return this.pluckMode=X??!0,this}get reader(){return hY.call(this.stmt)}run(...X){try{if(X.length==1&&typeof X[0]==="object")return F$.call(this.stmt,X[0]);else return F$.call(this.stmt,X.flat())}catch($){throw f2($)}}get(...X){try{if(X.length==1&&typeof X[0]==="object")return I$.call(this.stmt,X[0]);else return I$.call(this.stmt,X.flat())}catch($){throw f2($)}}iterate(...X){var $=void 0;if(X.length==1&&typeof X[0]==="object")$=N$.call(this.stmt,X[0]);else $=N$.call(this.stmt,X.flat());return{nextRows:Array(100),nextRowIndex:100,next(){try{if(this.nextRowIndex===100)fY.call($,this.nextRows),this.nextRowIndex=0;let Y=this.nextRows[this.nextRowIndex];if(this.nextRows[this.nextRowIndex]=void 0,!Y)return{done:!0};return this.nextRowIndex++,{value:Y,done:!1}}catch(Y){throw f2(Y)}},[Symbol.iterator](){return this}}}all(...X){try{let $=[];for(let Z of this.iterate(...X))if(this.pluckMode)$.push(Z[Object.keys(Z)[0]]);else $.push(Z);return $}catch($){throw f2($)}}interrupt(){SY.call(this.stmt)}columns(){return kY.call(this.stmt)}safeIntegers(X){return yY.call(this.stmt,X??!0),this}}A6.exports=E$;A6.exports.Authorization=gY;A6.exports.SqliteError=M$});var b1=d((i3,h$)=>{var v$=["nodebuffer","arraybuffer","fragments"],q$=typeof Blob<"u";if(q$)v$.push("blob");h$.exports={BINARY_TYPES:v$,EMPTY_BUFFER:Buffer.alloc(0),GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",hasBlob:q$,kForOnEventAttribute:Symbol("kIsForOnEventAttribute"),kListener:Symbol("kListener"),kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),NOOP:()=>{}}});var Q0=d((n3,O6)=>{var{EMPTY_BUFFER:iY}=b1(),B4=Buffer[Symbol.species];function nY(X,$){if(X.length===0)return iY;if(X.length===1)return X[0];let Z=Buffer.allocUnsafe($),Y=0;for(let G=0;G<X.length;G++){let J=X[G];Z.set(J,Y),Y+=J.length}if(Y<$)return new B4(Z.buffer,Z.byteOffset,Y);return Z}function S$(X,$,Z,Y,G){for(let J=0;J<G;J++)Z[Y+J]=X[J]^$[J&3]}function k$(X,$){for(let Z=0;Z<X.length;Z++)X[Z]^=$[Z&3]}function lY(X){if(X.length===X.buffer.byteLength)return X.buffer;return X.buffer.slice(X.byteOffset,X.byteOffset+X.length)}function T4(X){if(T4.readOnly=!0,Buffer.isBuffer(X))return X;let $;if(X instanceof ArrayBuffer)$=new B4(X);else if(ArrayBuffer.isView(X))$=new B4(X.buffer,X.byteOffset,X.byteLength);else $=Buffer.from(X),T4.readOnly=!1;return $}O6.exports={concat:nY,mask:S$,toArrayBuffer:lY,toBuffer:T4,unmask:k$};if(!process.env.WS_NO_BUFFER_UTIL)try{let X=(()=>{throw new Error("Cannot require module "+"bufferutil");})();O6.exports.mask=function($,Z,Y,G,J){if(J<48)S$($,Z,Y,G,J);else X.mask($,Z,Y,G,J)},O6.exports.unmask=function($,Z){if($.length<32)k$($,Z);else X.unmask($,Z)}}catch(X){}});var p$=d((l3,g$)=>{var y$=Symbol("kDone"),w4=Symbol("kRun");class f${constructor(X){this[y$]=()=>{this.pending--,this[w4]()},this.concurrency=X||1/0,this.jobs=[],this.pending=0}add(X){this.jobs.push(X),this[w4]()}[w4](){if(this.pending===this.concurrency)return;if(this.jobs.length){let X=this.jobs.shift();this.pending++,X(this[y$])}}}g$.exports=f$});var B0=d((o3,c$)=>{var j0=h("zlib"),b$=Q0(),oY=p$(),{kStatusCode:d$}=b1(),sY=Buffer[Symbol.species],rY=Buffer.from([0,0,255,255]),D6=Symbol("permessage-deflate"),d1=Symbol("total-length"),g2=Symbol("callback"),X2=Symbol("buffers"),p2=Symbol("error"),K6;class m${constructor(X,$,Z){if(this._maxPayload=Z|0,this._options=X||{},this._threshold=this._options.threshold!==void 0?this._options.threshold:1024,this._isServer=!!$,this._deflate=null,this._inflate=null,this.params=null,!K6){let Y=this._options.concurrencyLimit!==void 0?this._options.concurrencyLimit:10;K6=new oY(Y)}}static get extensionName(){return"permessage-deflate"}offer(){let X={};if(this._options.serverNoContextTakeover)X.server_no_context_takeover=!0;if(this._options.clientNoContextTakeover)X.client_no_context_takeover=!0;if(this._options.serverMaxWindowBits)X.server_max_window_bits=this._options.serverMaxWindowBits;if(this._options.clientMaxWindowBits)X.client_max_window_bits=this._options.clientMaxWindowBits;else if(this._options.clientMaxWindowBits==null)X.client_max_window_bits=!0;return X}accept(X){return X=this.normalizeParams(X),this.params=this._isServer?this.acceptAsServer(X):this.acceptAsClient(X),this.params}cleanup(){if(this._inflate)this._inflate.close(),this._inflate=null;if(this._deflate){let X=this._deflate[g2];if(this._deflate.close(),this._deflate=null,X)X(Error("The deflate stream was closed while data was being processed"))}}acceptAsServer(X){let $=this._options,Z=X.find((Y)=>{if($.serverNoContextTakeover===!1&&Y.server_no_context_takeover||Y.server_max_window_bits&&($.serverMaxWindowBits===!1||typeof $.serverMaxWindowBits==="number"&&$.serverMaxWindowBits>Y.server_max_window_bits)||typeof $.clientMaxWindowBits==="number"&&!Y.client_max_window_bits)return!1;return!0});if(!Z)throw Error("None of the extension offers can be accepted");if($.serverNoContextTakeover)Z.server_no_context_takeover=!0;if($.clientNoContextTakeover)Z.client_no_context_takeover=!0;if(typeof $.serverMaxWindowBits==="number")Z.server_max_window_bits=$.serverMaxWindowBits;if(typeof $.clientMaxWindowBits==="number")Z.client_max_window_bits=$.clientMaxWindowBits;else if(Z.client_max_window_bits===!0||$.clientMaxWindowBits===!1)delete Z.client_max_window_bits;return Z}acceptAsClient(X){let $=X[0];if(this._options.clientNoContextTakeover===!1&&$.client_no_context_takeover)throw Error('Unexpected parameter "client_no_context_takeover"');if(!$.client_max_window_bits){if(typeof this._options.clientMaxWindowBits==="number")$.client_max_window_bits=this._options.clientMaxWindowBits}else if(this._options.clientMaxWindowBits===!1||typeof this._options.clientMaxWindowBits==="number"&&$.client_max_window_bits>this._options.clientMaxWindowBits)throw Error('Unexpected or invalid parameter "client_max_window_bits"');return $}normalizeParams(X){return X.forEach(($)=>{Object.keys($).forEach((Z)=>{let Y=$[Z];if(Y.length>1)throw Error(`Parameter "${Z}" must have only a single value`);if(Y=Y[0],Z==="client_max_window_bits"){if(Y!==!0){let G=+Y;if(!Number.isInteger(G)||G<8||G>15)throw TypeError(`Invalid value for parameter "${Z}": ${Y}`);Y=G}else if(!this._isServer)throw TypeError(`Invalid value for parameter "${Z}": ${Y}`)}else if(Z==="server_max_window_bits"){let G=+Y;if(!Number.isInteger(G)||G<8||G>15)throw TypeError(`Invalid value for parameter "${Z}": ${Y}`);Y=G}else if(Z==="client_no_context_takeover"||Z==="server_no_context_takeover"){if(Y!==!0)throw TypeError(`Invalid value for parameter "${Z}": ${Y}`)}else throw Error(`Unknown parameter "${Z}"`);$[Z]=Y})}),X}decompress(X,$,Z){K6.add((Y)=>{this._decompress(X,$,(G,J)=>{Y(),Z(G,J)})})}compress(X,$,Z){K6.add((Y)=>{this._compress(X,$,(G,J)=>{Y(),Z(G,J)})})}_decompress(X,$,Z){let Y=this._isServer?"client":"server";if(!this._inflate){let G=`${Y}_max_window_bits`,J=typeof this.params[G]!=="number"?j0.Z_DEFAULT_WINDOWBITS:this.params[G];this._inflate=j0.createInflateRaw({...this._options.zlibInflateOptions,windowBits:J}),this._inflate[D6]=this,this._inflate[d1]=0,this._inflate[X2]=[],this._inflate.on("error",aY),this._inflate.on("data",u$)}if(this._inflate[g2]=Z,this._inflate.write(X),$)this._inflate.write(rY);this._inflate.flush(()=>{let G=this._inflate[p2];if(G){this._inflate.close(),this._inflate=null,Z(G);return}let J=b$.concat(this._inflate[X2],this._inflate[d1]);if(this._inflate._readableState.endEmitted)this._inflate.close(),this._inflate=null;else if(this._inflate[d1]=0,this._inflate[X2]=[],$&&this.params[`${Y}_no_context_takeover`])this._inflate.reset();Z(null,J)})}_compress(X,$,Z){let Y=this._isServer?"server":"client";if(!this._deflate){let G=`${Y}_max_window_bits`,J=typeof this.params[G]!=="number"?j0.Z_DEFAULT_WINDOWBITS:this.params[G];this._deflate=j0.createDeflateRaw({...this._options.zlibDeflateOptions,windowBits:J}),this._deflate[d1]=0,this._deflate[X2]=[],this._deflate.on("data",tY)}this._deflate[g2]=Z,this._deflate.write(X),this._deflate.flush(j0.Z_SYNC_FLUSH,()=>{if(!this._deflate)return;let G=b$.concat(this._deflate[X2],this._deflate[d1]);if($)G=new sY(G.buffer,G.byteOffset,G.length-4);if(this._deflate[g2]=null,this._deflate[d1]=0,this._deflate[X2]=[],$&&this.params[`${Y}_no_context_takeover`])this._deflate.reset();Z(null,G)})}}c$.exports=m$;function tY(X){this[X2].push(X),this[d1]+=X.length}function u$(X){if(this[d1]+=X.length,this[D6]._maxPayload<1||this[d1]<=this[D6]._maxPayload){this[X2].push(X);return}this[p2]=RangeError("Max payload size exceeded"),this[p2].code="WS_ERR_UNSUPPORTED_MESSAGE_LENGTH",this[p2][d$]=1009,this.removeListener("data",u$),this.reset()}function aY(X){if(this[D6]._inflate=null,this[p2]){this[g2](this[p2]);return}X[d$]=1007,this[g2](X)}});var b2=d((s3,U6)=>{var{isUtf8:i$}=h("buffer"),{hasBlob:eY}=b1(),XG=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0];function $G(X){return X>=1000&&X<=1014&&X!==1004&&X!==1005&&X!==1006||X>=3000&&X<=4999}function L4(X){let $=X.length,Z=0;while(Z<$)if((X[Z]&128)===0)Z++;else if((X[Z]&224)===192){if(Z+1===$||(X[Z+1]&192)!==128||(X[Z]&254)===192)return!1;Z+=2}else if((X[Z]&240)===224){if(Z+2>=$||(X[Z+1]&192)!==128||(X[Z+2]&192)!==128||X[Z]===224&&(X[Z+1]&224)===128||X[Z]===237&&(X[Z+1]&224)===160)return!1;Z+=3}else if((X[Z]&248)===240){if(Z+3>=$||(X[Z+1]&192)!==128||(X[Z+2]&192)!==128||(X[Z+3]&192)!==128||X[Z]===240&&(X[Z+1]&240)===128||X[Z]===244&&X[Z+1]>143||X[Z]>244)return!1;Z+=4}else return!1;return!0}function ZG(X){return eY&&typeof X==="object"&&typeof X.arrayBuffer==="function"&&typeof X.type==="string"&&typeof X.stream==="function"&&(X[Symbol.toStringTag]==="Blob"||X[Symbol.toStringTag]==="File")}U6.exports={isBlob:ZG,isValidStatusCode:$G,isValidUTF8:L4,tokenChars:XG};if(i$)U6.exports.isValidUTF8=function(X){return X.length<24?L4(X):i$(X)};else if(!process.env.WS_NO_UTF_8_VALIDATE)try{let X=(()=>{throw new Error("Cannot require module "+"utf-8-validate");})();U6.exports.isValidUTF8=function($){return $.length<32?L4($):X($)}}catch(X){}});var v4=d((r3,r$)=>{var{Writable:YG}=h("stream"),n$=B0(),{BINARY_TYPES:GG,EMPTY_BUFFER:l$,kStatusCode:JG,kWebSocket:_G}=b1(),{concat:C4,toArrayBuffer:zG,unmask:HG}=Q0(),{isValidStatusCode:WG,isValidUTF8:o$}=b2(),V6=Buffer[Symbol.species];class s$ extends YG{constructor(X={}){super();this._allowSynchronousEvents=X.allowSynchronousEvents!==void 0?X.allowSynchronousEvents:!0,this._binaryType=X.binaryType||GG[0],this._extensions=X.extensions||{},this._isServer=!!X.isServer,this._maxPayload=X.maxPayload|0,this._skipUTF8Validation=!!X.skipUTF8Validation,this[_G]=void 0,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._errored=!1,this._loop=!1,this._state=0}_write(X,$,Z){if(this._opcode===8&&this._state==0)return Z();this._bufferedBytes+=X.length,this._buffers.push(X),this.startLoop(Z)}consume(X){if(this._bufferedBytes-=X,X===this._buffers[0].length)return this._buffers.shift();if(X<this._buffers[0].length){let Z=this._buffers[0];return this._buffers[0]=new V6(Z.buffer,Z.byteOffset+X,Z.length-X),new V6(Z.buffer,Z.byteOffset,X)}let $=Buffer.allocUnsafe(X);do{let Z=this._buffers[0],Y=$.length-X;if(X>=Z.length)$.set(this._buffers.shift(),Y);else $.set(new Uint8Array(Z.buffer,Z.byteOffset,X),Y),this._buffers[0]=new V6(Z.buffer,Z.byteOffset+X,Z.length-X);X-=Z.length}while(X>0);return $}startLoop(X){this._loop=!0;do switch(this._state){case 0:this.getInfo(X);break;case 1:this.getPayloadLength16(X);break;case 2:this.getPayloadLength64(X);break;case 3:this.getMask();break;case 4:this.getData(X);break;case 5:case 6:this._loop=!1;return}while(this._loop);if(!this._errored)X()}getInfo(X){if(this._bufferedBytes<2){this._loop=!1;return}let $=this.consume(2);if(($[0]&48)!==0){let Y=this.createError(RangeError,"RSV2 and RSV3 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_2_3");X(Y);return}let Z=($[0]&64)===64;if(Z&&!this._extensions[n$.extensionName]){let Y=this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");X(Y);return}if(this._fin=($[0]&128)===128,this._opcode=$[0]&15,this._payloadLength=$[1]&127,this._opcode===0){if(Z){let Y=this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");X(Y);return}if(!this._fragmented){let Y=this.createError(RangeError,"invalid opcode 0",!0,1002,"WS_ERR_INVALID_OPCODE");X(Y);return}this._opcode=this._fragmented}else if(this._opcode===1||this._opcode===2){if(this._fragmented){let Y=this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE");X(Y);return}this._compressed=Z}else if(this._opcode>7&&this._opcode<11){if(!this._fin){let Y=this.createError(RangeError,"FIN must be set",!0,1002,"WS_ERR_EXPECTED_FIN");X(Y);return}if(Z){let Y=this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");X(Y);return}if(this._payloadLength>125||this._opcode===8&&this._payloadLength===1){let Y=this.createError(RangeError,`invalid payload length ${this._payloadLength}`,!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH");X(Y);return}}else{let Y=this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE");X(Y);return}if(!this._fin&&!this._fragmented)this._fragmented=this._opcode;if(this._masked=($[1]&128)===128,this._isServer){if(!this._masked){let Y=this.createError(RangeError,"MASK must be set",!0,1002,"WS_ERR_EXPECTED_MASK");X(Y);return}}else if(this._masked){let Y=this.createError(RangeError,"MASK must be clear",!0,1002,"WS_ERR_UNEXPECTED_MASK");X(Y);return}if(this._payloadLength===126)this._state=1;else if(this._payloadLength===127)this._state=2;else this.haveLength(X)}getPayloadLength16(X){if(this._bufferedBytes<2){this._loop=!1;return}this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength(X)}getPayloadLength64(X){if(this._bufferedBytes<8){this._loop=!1;return}let $=this.consume(8),Z=$.readUInt32BE(0);if(Z>Math.pow(2,21)-1){let Y=this.createError(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009,"WS_ERR_UNSUPPORTED_DATA_PAYLOAD_LENGTH");X(Y);return}this._payloadLength=Z*Math.pow(2,32)+$.readUInt32BE(4),this.haveLength(X)}haveLength(X){if(this._payloadLength&&this._opcode<8){if(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0){let $=this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");X($);return}}if(this._masked)this._state=3;else this._state=4}getMask(){if(this._bufferedBytes<4){this._loop=!1;return}this._mask=this.consume(4),this._state=4}getData(X){let $=l$;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength){this._loop=!1;return}if($=this.consume(this._payloadLength),this._masked&&(this._mask[0]|this._mask[1]|this._mask[2]|this._mask[3])!==0)HG($,this._mask)}if(this._opcode>7){this.controlMessage($,X);return}if(this._compressed){this._state=5,this.decompress($,X);return}if($.length)this._messageLength=this._totalPayloadLength,this._fragments.push($);this.dataMessage(X)}decompress(X,$){this._extensions[n$.extensionName].decompress(X,this._fin,(Y,G)=>{if(Y)return $(Y);if(G.length){if(this._messageLength+=G.length,this._messageLength>this._maxPayload&&this._maxPayload>0){let J=this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");$(J);return}this._fragments.push(G)}if(this.dataMessage($),this._state===0)this.startLoop($)})}dataMessage(X){if(!this._fin){this._state=0;return}let $=this._messageLength,Z=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],this._opcode===2){let Y;if(this._binaryType==="nodebuffer")Y=C4(Z,$);else if(this._binaryType==="arraybuffer")Y=zG(C4(Z,$));else if(this._binaryType==="blob")Y=new Blob(Z);else Y=Z;if(this._allowSynchronousEvents)this.emit("message",Y,!0),this._state=0;else this._state=6,setImmediate(()=>{this.emit("message",Y,!0),this._state=0,this.startLoop(X)})}else{let Y=C4(Z,$);if(!this._skipUTF8Validation&&!o$(Y)){let G=this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");X(G);return}if(this._state===5||this._allowSynchronousEvents)this.emit("message",Y,!1),this._state=0;else this._state=6,setImmediate(()=>{this.emit("message",Y,!1),this._state=0,this.startLoop(X)})}}controlMessage(X,$){if(this._opcode===8){if(X.length===0)this._loop=!1,this.emit("conclude",1005,l$),this.end();else{let Z=X.readUInt16BE(0);if(!WG(Z)){let G=this.createError(RangeError,`invalid status code ${Z}`,!0,1002,"WS_ERR_INVALID_CLOSE_CODE");$(G);return}let Y=new V6(X.buffer,X.byteOffset+2,X.length-2);if(!this._skipUTF8Validation&&!o$(Y)){let G=this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");$(G);return}this._loop=!1,this.emit("conclude",Z,Y),this.end()}this._state=0;return}if(this._allowSynchronousEvents)this.emit(this._opcode===9?"ping":"pong",X),this._state=0;else this._state=6,setImmediate(()=>{this.emit(this._opcode===9?"ping":"pong",X),this._state=0,this.startLoop($)})}createError(X,$,Z,Y,G){this._loop=!1,this._errored=!0;let J=new X(Z?`Invalid WebSocket frame: ${$}`:$);return Error.captureStackTrace(J,this.createError),J.code=G,J[JG]=Y,J}}r$.exports=s$});var h4=d((a3,e$)=>{var{Duplex:t3}=h("stream"),{randomFillSync:AG}=h("crypto"),t$=B0(),{EMPTY_BUFFER:OG,kWebSocket:KG,NOOP:DG}=b1(),{isBlob:d2,isValidStatusCode:UG}=b2(),{mask:a$,toBuffer:F2}=Q0(),I1=Symbol("kByteLength"),VG=Buffer.alloc(4),N2,m2=8192,E1=0,RG=1,IG=2;class $2{constructor(X,$,Z){if(this._extensions=$||{},Z)this._generateMask=Z,this._maskBuffer=Buffer.alloc(4);this._socket=X,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._queue=[],this._state=E1,this.onerror=DG,this[KG]=void 0}static frame(X,$){let Z,Y=!1,G=2,J=!1;if($.mask){if(Z=$.maskBuffer||VG,$.generateMask)$.generateMask(Z);else{if(m2===8192){if(N2===void 0)N2=Buffer.alloc(8192);AG(N2,0,8192),m2=0}Z[0]=N2[m2++],Z[1]=N2[m2++],Z[2]=N2[m2++],Z[3]=N2[m2++]}J=(Z[0]|Z[1]|Z[2]|Z[3])===0,G=6}let _;if(typeof X==="string")if((!$.mask||J)&&$[I1]!==void 0)_=$[I1];else X=Buffer.from(X),_=X.length;else _=X.length,Y=$.mask&&$.readOnly&&!J;let z=_;if(_>=65536)G+=8,z=127;else if(_>125)G+=2,z=126;let H=Buffer.allocUnsafe(Y?_+G:G);if(H[0]=$.fin?$.opcode|128:$.opcode,$.rsv1)H[0]|=64;if(H[1]=z,z===126)H.writeUInt16BE(_,2);else if(z===127)H[2]=H[3]=0,H.writeUIntBE(_,4,6);if(!$.mask)return[H,X];if(H[1]|=128,H[G-4]=Z[0],H[G-3]=Z[1],H[G-2]=Z[2],H[G-1]=Z[3],J)return[H,X];if(Y)return a$(X,Z,H,G,_),[H];return a$(X,Z,X,0,_),[H,X]}close(X,$,Z,Y){let G;if(X===void 0)G=OG;else if(typeof X!=="number"||!UG(X))throw TypeError("First argument must be a valid error code number");else if($===void 0||!$.length)G=Buffer.allocUnsafe(2),G.writeUInt16BE(X,0);else{let _=Buffer.byteLength($);if(_>123)throw RangeError("The message must not be greater than 123 bytes");if(G=Buffer.allocUnsafe(2+_),G.writeUInt16BE(X,0),typeof $==="string")G.write($,2);else G.set($,2)}let J={[I1]:G.length,fin:!0,generateMask:this._generateMask,mask:Z,maskBuffer:this._maskBuffer,opcode:8,readOnly:!1,rsv1:!1};if(this._state!==E1)this.enqueue([this.dispatch,G,!1,J,Y]);else this.sendFrame($2.frame(G,J),Y)}ping(X,$,Z){let Y,G;if(typeof X==="string")Y=Buffer.byteLength(X),G=!1;else if(d2(X))Y=X.size,G=!1;else X=F2(X),Y=X.length,G=F2.readOnly;if(Y>125)throw RangeError("The data size must not be greater than 125 bytes");let J={[I1]:Y,fin:!0,generateMask:this._generateMask,mask:$,maskBuffer:this._maskBuffer,opcode:9,readOnly:G,rsv1:!1};if(d2(X))if(this._state!==E1)this.enqueue([this.getBlobData,X,!1,J,Z]);else this.getBlobData(X,!1,J,Z);else if(this._state!==E1)this.enqueue([this.dispatch,X,!1,J,Z]);else this.sendFrame($2.frame(X,J),Z)}pong(X,$,Z){let Y,G;if(typeof X==="string")Y=Buffer.byteLength(X),G=!1;else if(d2(X))Y=X.size,G=!1;else X=F2(X),Y=X.length,G=F2.readOnly;if(Y>125)throw RangeError("The data size must not be greater than 125 bytes");let J={[I1]:Y,fin:!0,generateMask:this._generateMask,mask:$,maskBuffer:this._maskBuffer,opcode:10,readOnly:G,rsv1:!1};if(d2(X))if(this._state!==E1)this.enqueue([this.getBlobData,X,!1,J,Z]);else this.getBlobData(X,!1,J,Z);else if(this._state!==E1)this.enqueue([this.dispatch,X,!1,J,Z]);else this.sendFrame($2.frame(X,J),Z)}send(X,$,Z){let Y=this._extensions[t$.extensionName],G=$.binary?2:1,J=$.compress,_,z;if(typeof X==="string")_=Buffer.byteLength(X),z=!1;else if(d2(X))_=X.size,z=!1;else X=F2(X),_=X.length,z=F2.readOnly;if(this._firstFragment){if(this._firstFragment=!1,J&&Y&&Y.params[Y._isServer?"server_no_context_takeover":"client_no_context_takeover"])J=_>=Y._threshold;this._compress=J}else J=!1,G=0;if($.fin)this._firstFragment=!0;let H={[I1]:_,fin:$.fin,generateMask:this._generateMask,mask:$.mask,maskBuffer:this._maskBuffer,opcode:G,readOnly:z,rsv1:J};if(d2(X))if(this._state!==E1)this.enqueue([this.getBlobData,X,this._compress,H,Z]);else this.getBlobData(X,this._compress,H,Z);else if(this._state!==E1)this.enqueue([this.dispatch,X,this._compress,H,Z]);else this.dispatch(X,this._compress,H,Z)}getBlobData(X,$,Z,Y){this._bufferedBytes+=Z[I1],this._state=IG,X.arrayBuffer().then((G)=>{if(this._socket.destroyed){let _=Error("The socket was closed while the blob was being read");process.nextTick(q4,this,_,Y);return}this._bufferedBytes-=Z[I1];let J=F2(G);if(!$)this._state=E1,this.sendFrame($2.frame(J,Z),Y),this.dequeue();else this.dispatch(J,$,Z,Y)}).catch((G)=>{process.nextTick(FG,this,G,Y)})}dispatch(X,$,Z,Y){if(!$){this.sendFrame($2.frame(X,Z),Y);return}let G=this._extensions[t$.extensionName];this._bufferedBytes+=Z[I1],this._state=RG,G.compress(X,Z.fin,(J,_)=>{if(this._socket.destroyed){let z=Error("The socket was closed while data was being compressed");q4(this,z,Y);return}this._bufferedBytes-=Z[I1],this._state=E1,Z.readOnly=!1,this.sendFrame($2.frame(_,Z),Y),this.dequeue()})}dequeue(){while(this._state===E1&&this._queue.length){let X=this._queue.shift();this._bufferedBytes-=X[3][I1],Reflect.apply(X[0],this,X.slice(1))}}enqueue(X){this._bufferedBytes+=X[3][I1],this._queue.push(X)}sendFrame(X,$){if(X.length===2)this._socket.cork(),this._socket.write(X[0]),this._socket.write(X[1],$),this._socket.uncork();else this._socket.write(X[0],$)}}e$.exports=$2;function q4(X,$,Z){if(typeof Z==="function")Z($);for(let Y=0;Y<X._queue.length;Y++){let G=X._queue[Y],J=G[G.length-1];if(typeof J==="function")J($)}}function FG(X,$,Z){q4(X,$,Z),X.onerror($)}});var HZ=d((e3,zZ)=>{var{kForOnEventAttribute:T0,kListener:S4}=b1(),XZ=Symbol("kCode"),$Z=Symbol("kData"),ZZ=Symbol("kError"),YZ=Symbol("kMessage"),GZ=Symbol("kReason"),u2=Symbol("kTarget"),JZ=Symbol("kType"),_Z=Symbol("kWasClean");class Z2{constructor(X){this[u2]=null,this[JZ]=X}get target(){return this[u2]}get type(){return this[JZ]}}Object.defineProperty(Z2.prototype,"target",{enumerable:!0});Object.defineProperty(Z2.prototype,"type",{enumerable:!0});class c2 extends Z2{constructor(X,$={}){super(X);this[XZ]=$.code===void 0?0:$.code,this[GZ]=$.reason===void 0?"":$.reason,this[_Z]=$.wasClean===void 0?!1:$.wasClean}get code(){return this[XZ]}get reason(){return this[GZ]}get wasClean(){return this[_Z]}}Object.defineProperty(c2.prototype,"code",{enumerable:!0});Object.defineProperty(c2.prototype,"reason",{enumerable:!0});Object.defineProperty(c2.prototype,"wasClean",{enumerable:!0});class w0 extends Z2{constructor(X,$={}){super(X);this[ZZ]=$.error===void 0?null:$.error,this[YZ]=$.message===void 0?"":$.message}get error(){return this[ZZ]}get message(){return this[YZ]}}Object.defineProperty(w0.prototype,"error",{enumerable:!0});Object.defineProperty(w0.prototype,"message",{enumerable:!0});class I6 extends Z2{constructor(X,$={}){super(X);this[$Z]=$.data===void 0?null:$.data}get data(){return this[$Z]}}Object.defineProperty(I6.prototype,"data",{enumerable:!0});var NG={addEventListener(X,$,Z={}){for(let G of this.listeners(X))if(!Z[T0]&&G[S4]===$&&!G[T0])return;let Y;if(X==="message")Y=function(J,_){let z=new I6("message",{data:_?J:J.toString()});z[u2]=this,R6($,this,z)};else if(X==="close")Y=function(J,_){let z=new c2("close",{code:J,reason:_.toString(),wasClean:this._closeFrameReceived&&this._closeFrameSent});z[u2]=this,R6($,this,z)};else if(X==="error")Y=function(J){let _=new w0("error",{error:J,message:J.message});_[u2]=this,R6($,this,_)};else if(X==="open")Y=function(){let J=new Z2("open");J[u2]=this,R6($,this,J)};else return;if(Y[T0]=!!Z[T0],Y[S4]=$,Z.once)this.once(X,Y);else this.on(X,Y)},removeEventListener(X,$){for(let Z of this.listeners(X))if(Z[S4]===$&&!Z[T0]){this.removeListener(X,Z);break}}};zZ.exports={CloseEvent:c2,ErrorEvent:w0,Event:Z2,EventTarget:NG,MessageEvent:I6};function R6(X,$,Z){if(typeof X==="object"&&X.handleEvent)X.handleEvent.call(X,Z);else X.call($,Z)}});var k4=d((Xz,WZ)=>{var{tokenChars:L0}=b2();function q1(X,$,Z){if(X[$]===void 0)X[$]=[Z];else X[$].push(Z)}function MG(X){let $=Object.create(null),Z=Object.create(null),Y=!1,G=!1,J=!1,_,z,H=-1,W=-1,K=-1,U=0;for(;U<X.length;U++)if(W=X.charCodeAt(U),_===void 0)if(K===-1&&L0[W]===1){if(H===-1)H=U}else if(U!==0&&(W===32||W===9)){if(K===-1&&H!==-1)K=U}else if(W===59||W===44){if(H===-1)throw SyntaxError(`Unexpected character at index ${U}`);if(K===-1)K=U;let M=X.slice(H,K);if(W===44)q1($,M,Z),Z=Object.create(null);else _=M;H=K=-1}else throw SyntaxError(`Unexpected character at index ${U}`);else if(z===void 0)if(K===-1&&L0[W]===1){if(H===-1)H=U}else if(W===32||W===9){if(K===-1&&H!==-1)K=U}else if(W===59||W===44){if(H===-1)throw SyntaxError(`Unexpected character at index ${U}`);if(K===-1)K=U;if(q1(Z,X.slice(H,K),!0),W===44)q1($,_,Z),Z=Object.create(null),_=void 0;H=K=-1}else if(W===61&&H!==-1&&K===-1)z=X.slice(H,U),H=K=-1;else throw SyntaxError(`Unexpected character at index ${U}`);else if(G){if(L0[W]!==1)throw SyntaxError(`Unexpected character at index ${U}`);if(H===-1)H=U;else if(!Y)Y=!0;G=!1}else if(J)if(L0[W]===1){if(H===-1)H=U}else if(W===34&&H!==-1)J=!1,K=U;else if(W===92)G=!0;else throw SyntaxError(`Unexpected character at index ${U}`);else if(W===34&&X.charCodeAt(U-1)===61)J=!0;else if(K===-1&&L0[W]===1){if(H===-1)H=U}else if(H!==-1&&(W===32||W===9)){if(K===-1)K=U}else if(W===59||W===44){if(H===-1)throw SyntaxError(`Unexpected character at index ${U}`);if(K===-1)K=U;let M=X.slice(H,K);if(Y)M=M.replace(/\\/g,""),Y=!1;if(q1(Z,z,M),W===44)q1($,_,Z),Z=Object.create(null),_=void 0;z=void 0,H=K=-1}else throw SyntaxError(`Unexpected character at index ${U}`);if(H===-1||J||W===32||W===9)throw SyntaxError("Unexpected end of input");if(K===-1)K=U;let F=X.slice(H,K);if(_===void 0)q1($,F,Z);else{if(z===void 0)q1(Z,F,!0);else if(Y)q1(Z,z,F.replace(/\\/g,""));else q1(Z,z,F);q1($,_,Z)}return $}function EG(X){return Object.keys(X).map(($)=>{let Z=X[$];if(!Array.isArray(Z))Z=[Z];return Z.map((Y)=>{return[$].concat(Object.keys(Y).map((G)=>{let J=Y[G];if(!Array.isArray(J))J=[J];return J.map((_)=>_===!0?G:`${G}=${_}`).join("; ")})).join("; ")}).join(", ")}).join(", ")}WZ.exports={format:EG,parse:MG}});var E6=d((Yz,EZ)=>{var xG=h("events"),PG=h("https"),QG=h("http"),KZ=h("net"),jG=h("tls"),{randomBytes:BG,createHash:TG}=h("crypto"),{Duplex:$z,Readable:Zz}=h("stream"),{URL:y4}=h("url"),Y2=B0(),wG=v4(),LG=h4(),{isBlob:CG}=b2(),{BINARY_TYPES:AZ,EMPTY_BUFFER:F6,GUID:vG,kForOnEventAttribute:f4,kListener:qG,kStatusCode:hG,kWebSocket:t,NOOP:DZ}=b1(),{EventTarget:{addEventListener:SG,removeEventListener:kG}}=HZ(),{format:yG,parse:fG}=k4(),{toBuffer:gG}=Q0(),UZ=Symbol("kAborted"),g4=[8,13],m1=["CONNECTING","OPEN","CLOSING","CLOSED"],pG=/^[!#$%&'*+\-.0-9A-Z^_`|a-z~]+$/;class j extends xG{constructor(X,$,Z){super();if(this._binaryType=AZ[0],this._closeCode=1006,this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage=F6,this._closeTimer=null,this._errorEmitted=!1,this._extensions={},this._paused=!1,this._protocol="",this._readyState=j.CONNECTING,this._receiver=null,this._sender=null,this._socket=null,X!==null){if(this._bufferedAmount=0,this._isServer=!1,this._redirects=0,$===void 0)$=[];else if(!Array.isArray($))if(typeof $==="object"&&$!==null)Z=$,$=[];else $=[$];VZ(this,X,$,Z)}else this._autoPong=Z.autoPong,this._isServer=!0}get binaryType(){return this._binaryType}set binaryType(X){if(!AZ.includes(X))return;if(this._binaryType=X,this._receiver)this._receiver._binaryType=X}get bufferedAmount(){if(!this._socket)return this._bufferedAmount;return this._socket._writableState.length+this._sender._bufferedBytes}get extensions(){return Object.keys(this._extensions).join()}get isPaused(){return this._paused}get onclose(){return null}get onerror(){return null}get onopen(){return null}get onmessage(){return null}get protocol(){return this._protocol}get readyState(){return this._readyState}get url(){return this._url}setSocket(X,$,Z){let Y=new wG({allowSynchronousEvents:Z.allowSynchronousEvents,binaryType:this.binaryType,extensions:this._extensions,isServer:this._isServer,maxPayload:Z.maxPayload,skipUTF8Validation:Z.skipUTF8Validation}),G=new LG(X,this._extensions,Z.generateMask);if(this._receiver=Y,this._sender=G,this._socket=X,Y[t]=this,G[t]=this,X[t]=this,Y.on("conclude",mG),Y.on("drain",uG),Y.on("error",cG),Y.on("message",iG),Y.on("ping",nG),Y.on("pong",lG),G.onerror=oG,X.setTimeout)X.setTimeout(0);if(X.setNoDelay)X.setNoDelay();if($.length>0)X.unshift($);X.on("close",FZ),X.on("data",M6),X.on("end",NZ),X.on("error",MZ),this._readyState=j.OPEN,this.emit("open")}emitClose(){if(!this._socket){this._readyState=j.CLOSED,this.emit("close",this._closeCode,this._closeMessage);return}if(this._extensions[Y2.extensionName])this._extensions[Y2.extensionName].cleanup();this._receiver.removeAllListeners(),this._readyState=j.CLOSED,this.emit("close",this._closeCode,this._closeMessage)}close(X,$){if(this.readyState===j.CLOSED)return;if(this.readyState===j.CONNECTING){W1(this,this._req,"WebSocket was closed before the connection was established");return}if(this.readyState===j.CLOSING){if(this._closeFrameSent&&(this._closeFrameReceived||this._receiver._writableState.errorEmitted))this._socket.end();return}this._readyState=j.CLOSING,this._sender.close(X,$,!this._isServer,(Z)=>{if(Z)return;if(this._closeFrameSent=!0,this._closeFrameReceived||this._receiver._writableState.errorEmitted)this._socket.end()}),IZ(this)}pause(){if(this.readyState===j.CONNECTING||this.readyState===j.CLOSED)return;this._paused=!0,this._socket.pause()}ping(X,$,Z){if(this.readyState===j.CONNECTING)throw Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof X==="function")Z=X,X=$=void 0;else if(typeof $==="function")Z=$,$=void 0;if(typeof X==="number")X=X.toString();if(this.readyState!==j.OPEN){p4(this,X,Z);return}if($===void 0)$=!this._isServer;this._sender.ping(X||F6,$,Z)}pong(X,$,Z){if(this.readyState===j.CONNECTING)throw Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof X==="function")Z=X,X=$=void 0;else if(typeof $==="function")Z=$,$=void 0;if(typeof X==="number")X=X.toString();if(this.readyState!==j.OPEN){p4(this,X,Z);return}if($===void 0)$=!this._isServer;this._sender.pong(X||F6,$,Z)}resume(){if(this.readyState===j.CONNECTING||this.readyState===j.CLOSED)return;if(this._paused=!1,!this._receiver._writableState.needDrain)this._socket.resume()}send(X,$,Z){if(this.readyState===j.CONNECTING)throw Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof $==="function")Z=$,$={};if(typeof X==="number")X=X.toString();if(this.readyState!==j.OPEN){p4(this,X,Z);return}let Y={binary:typeof X!=="string",mask:!this._isServer,compress:!0,fin:!0,...$};if(!this._extensions[Y2.extensionName])Y.compress=!1;this._sender.send(X||F6,Y,Z)}terminate(){if(this.readyState===j.CLOSED)return;if(this.readyState===j.CONNECTING){W1(this,this._req,"WebSocket was closed before the connection was established");return}if(this._socket)this._readyState=j.CLOSING,this._socket.destroy()}}Object.defineProperty(j,"CONNECTING",{enumerable:!0,value:m1.indexOf("CONNECTING")});Object.defineProperty(j.prototype,"CONNECTING",{enumerable:!0,value:m1.indexOf("CONNECTING")});Object.defineProperty(j,"OPEN",{enumerable:!0,value:m1.indexOf("OPEN")});Object.defineProperty(j.prototype,"OPEN",{enumerable:!0,value:m1.indexOf("OPEN")});Object.defineProperty(j,"CLOSING",{enumerable:!0,value:m1.indexOf("CLOSING")});Object.defineProperty(j.prototype,"CLOSING",{enumerable:!0,value:m1.indexOf("CLOSING")});Object.defineProperty(j,"CLOSED",{enumerable:!0,value:m1.indexOf("CLOSED")});Object.defineProperty(j.prototype,"CLOSED",{enumerable:!0,value:m1.indexOf("CLOSED")});["binaryType","bufferedAmount","extensions","isPaused","protocol","readyState","url"].forEach((X)=>{Object.defineProperty(j.prototype,X,{enumerable:!0})});["open","error","close","message"].forEach((X)=>{Object.defineProperty(j.prototype,`on${X}`,{enumerable:!0,get(){for(let $ of this.listeners(X))if($[f4])return $[qG];return null},set($){for(let Z of this.listeners(X))if(Z[f4]){this.removeListener(X,Z);break}if(typeof $!=="function")return;this.addEventListener(X,$,{[f4]:!0})}})});j.prototype.addEventListener=SG;j.prototype.removeEventListener=kG;EZ.exports=j;function VZ(X,$,Z,Y){let G={allowSynchronousEvents:!0,autoPong:!0,protocolVersion:g4[1],maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10,...Y,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:"GET",host:void 0,path:void 0,port:void 0};if(X._autoPong=G.autoPong,!g4.includes(G.protocolVersion))throw RangeError(`Unsupported protocol version: ${G.protocolVersion} (supported versions: ${g4.join(", ")})`);let J;if($ instanceof y4)J=$;else try{J=new y4($)}catch(I){throw SyntaxError(`Invalid URL: ${$}`)}if(J.protocol==="http:")J.protocol="ws:";else if(J.protocol==="https:")J.protocol="wss:";X._url=J.href;let _=J.protocol==="wss:",z=J.protocol==="ws+unix:",H;if(J.protocol!=="ws:"&&!_&&!z)H=`The URL's protocol must be one of "ws:", "wss:", "http:", "https:", or "ws+unix:"`;else if(z&&!J.pathname)H="The URL's pathname is empty";else if(J.hash)H="The URL contains a fragment identifier";if(H){let I=SyntaxError(H);if(X._redirects===0)throw I;else{N6(X,I);return}}let W=_?443:80,K=BG(16).toString("base64"),U=_?PG.request:QG.request,F=new Set,M;if(G.createConnection=G.createConnection||(_?dG:bG),G.defaultPort=G.defaultPort||W,G.port=J.port||W,G.host=J.hostname.startsWith("[")?J.hostname.slice(1,-1):J.hostname,G.headers={...G.headers,"Sec-WebSocket-Version":G.protocolVersion,"Sec-WebSocket-Key":K,Connection:"Upgrade",Upgrade:"websocket"},G.path=J.pathname+J.search,G.timeout=G.handshakeTimeout,G.perMessageDeflate)M=new Y2(G.perMessageDeflate!==!0?G.perMessageDeflate:{},!1,G.maxPayload),G.headers["Sec-WebSocket-Extensions"]=yG({[Y2.extensionName]:M.offer()});if(Z.length){for(let I of Z){if(typeof I!=="string"||!pG.test(I)||F.has(I))throw SyntaxError("An invalid or duplicated subprotocol was specified");F.add(I)}G.headers["Sec-WebSocket-Protocol"]=Z.join(",")}if(G.origin)if(G.protocolVersion<13)G.headers["Sec-WebSocket-Origin"]=G.origin;else G.headers.Origin=G.origin;if(J.username||J.password)G.auth=`${J.username}:${J.password}`;if(z){let I=G.path.split(":");G.socketPath=I[0],G.path=I[1]}let R;if(G.followRedirects){if(X._redirects===0){X._originalIpc=z,X._originalSecure=_,X._originalHostOrSocketPath=z?G.socketPath:J.host;let I=Y&&Y.headers;if(Y={...Y,headers:{}},I)for(let[E,S]of Object.entries(I))Y.headers[E.toLowerCase()]=S}else if(X.listenerCount("redirect")===0){let I=z?X._originalIpc?G.socketPath===X._originalHostOrSocketPath:!1:X._originalIpc?!1:J.host===X._originalHostOrSocketPath;if(!I||X._originalSecure&&!_){if(delete G.headers.authorization,delete G.headers.cookie,!I)delete G.headers.host;G.auth=void 0}}if(G.auth&&!Y.headers.authorization)Y.headers.authorization="Basic "+Buffer.from(G.auth).toString("base64");if(R=X._req=U(G),X._redirects)X.emit("redirect",X.url,R)}else R=X._req=U(G);if(G.timeout)R.on("timeout",()=>{W1(X,R,"Opening handshake has timed out")});if(R.on("error",(I)=>{if(R===null||R[UZ])return;R=X._req=null,N6(X,I)}),R.on("response",(I)=>{let E=I.headers.location,S=I.statusCode;if(E&&G.followRedirects&&S>=300&&S<400){if(++X._redirects>G.maxRedirects){W1(X,R,"Maximum redirects exceeded");return}R.abort();let y;try{y=new y4(E,$)}catch(T){let Z1=SyntaxError(`Invalid URL: ${E}`);N6(X,Z1);return}VZ(X,y,Z,Y)}else if(!X.emit("unexpected-response",R,I))W1(X,R,`Unexpected server response: ${I.statusCode}`)}),R.on("upgrade",(I,E,S)=>{if(X.emit("upgrade",I),X.readyState!==j.CONNECTING)return;R=X._req=null;let y=I.headers.upgrade;if(y===void 0||y.toLowerCase()!=="websocket"){W1(X,E,"Invalid Upgrade header");return}let T=TG("sha1").update(K+vG).digest("base64");if(I.headers["sec-websocket-accept"]!==T){W1(X,E,"Invalid Sec-WebSocket-Accept header");return}let Z1=I.headers["sec-websocket-protocol"],r;if(Z1!==void 0){if(!F.size)r="Server sent a subprotocol but none was requested";else if(!F.has(Z1))r="Server sent an invalid subprotocol"}else if(F.size)r="Server sent no subprotocol";if(r){W1(X,E,r);return}if(Z1)X._protocol=Z1;let P=I.headers["sec-websocket-extensions"];if(P!==void 0){if(!M){W1(X,E,"Server sent a Sec-WebSocket-Extensions header but no extension was requested");return}let C;try{C=fG(P)}catch(l1){W1(X,E,"Invalid Sec-WebSocket-Extensions header");return}let K1=Object.keys(C);if(K1.length!==1||K1[0]!==Y2.extensionName){W1(X,E,"Server indicated an extension that was not requested");return}try{M.accept(C[Y2.extensionName])}catch(l1){W1(X,E,"Invalid Sec-WebSocket-Extensions header");return}X._extensions[Y2.extensionName]=M}X.setSocket(E,S,{allowSynchronousEvents:G.allowSynchronousEvents,generateMask:G.generateMask,maxPayload:G.maxPayload,skipUTF8Validation:G.skipUTF8Validation})}),G.finishRequest)G.finishRequest(R,X);else R.end()}function N6(X,$){X._readyState=j.CLOSING,X._errorEmitted=!0,X.emit("error",$),X.emitClose()}function bG(X){return X.path=X.socketPath,KZ.connect(X)}function dG(X){if(X.path=void 0,!X.servername&&X.servername!=="")X.servername=KZ.isIP(X.host)?"":X.host;return jG.connect(X)}function W1(X,$,Z){X._readyState=j.CLOSING;let Y=Error(Z);if(Error.captureStackTrace(Y,W1),$.setHeader){if($[UZ]=!0,$.abort(),$.socket&&!$.socket.destroyed)$.socket.destroy();process.nextTick(N6,X,Y)}else $.destroy(Y),$.once("error",X.emit.bind(X,"error")),$.once("close",X.emitClose.bind(X))}function p4(X,$,Z){if($){let Y=CG($)?$.size:gG($).length;if(X._socket)X._sender._bufferedBytes+=Y;else X._bufferedAmount+=Y}if(Z){let Y=Error(`WebSocket is not open: readyState ${X.readyState} (${m1[X.readyState]})`);process.nextTick(Z,Y)}}function mG(X,$){let Z=this[t];if(Z._closeFrameReceived=!0,Z._closeMessage=$,Z._closeCode=X,Z._socket[t]===void 0)return;if(Z._socket.removeListener("data",M6),process.nextTick(RZ,Z._socket),X===1005)Z.close();else Z.close(X,$)}function uG(){let X=this[t];if(!X.isPaused)X._socket.resume()}function cG(X){let $=this[t];if($._socket[t]!==void 0)$._socket.removeListener("data",M6),process.nextTick(RZ,$._socket),$.close(X[hG]);if(!$._errorEmitted)$._errorEmitted=!0,$.emit("error",X)}function OZ(){this[t].emitClose()}function iG(X,$){this[t].emit("message",X,$)}function nG(X){let $=this[t];if($._autoPong)$.pong(X,!this._isServer,DZ);$.emit("ping",X)}function lG(X){this[t].emit("pong",X)}function RZ(X){X.resume()}function oG(X){let $=this[t];if($.readyState===j.CLOSED)return;if($.readyState===j.OPEN)$._readyState=j.CLOSING,IZ($);if(this._socket.end(),!$._errorEmitted)$._errorEmitted=!0,$.emit("error",X)}function IZ(X){X._closeTimer=setTimeout(X._socket.destroy.bind(X._socket),30000)}function FZ(){let X=this[t];this.removeListener("close",FZ),this.removeListener("data",M6),this.removeListener("end",NZ),X._readyState=j.CLOSING;let $;if(!this._readableState.endEmitted&&!X._closeFrameReceived&&!X._receiver._writableState.errorEmitted&&($=X._socket.read())!==null)X._receiver.write($);if(X._receiver.end(),this[t]=void 0,clearTimeout(X._closeTimer),X._receiver._writableState.finished||X._receiver._writableState.errorEmitted)X.emitClose();else X._receiver.on("error",OZ),X._receiver.on("finish",OZ)}function M6(X){if(!this[t]._receiver.write(X))this.pause()}function NZ(){let X=this[t];X._readyState=j.CLOSING,X._receiver.end(),this.end()}function MZ(){let X=this[t];if(this.removeListener("error",MZ),this.on("error",DZ),X)X._readyState=j.CLOSING,this.destroy()}});var jZ=d((Jz,QZ)=>{var Gz=E6(),{Duplex:sG}=h("stream");function xZ(X){X.emit("close")}function rG(){if(!this.destroyed&&this._writableState.finished)this.destroy()}function PZ(X){if(this.removeListener("error",PZ),this.destroy(),this.listenerCount("error")===0)this.emit("error",X)}function tG(X,$){let Z=!0,Y=new sG({...$,autoDestroy:!1,emitClose:!1,objectMode:!1,writableObjectMode:!1});return X.on("message",function(J,_){let z=!_&&Y._readableState.objectMode?J.toString():J;if(!Y.push(z))X.pause()}),X.once("error",function(J){if(Y.destroyed)return;Z=!1,Y.destroy(J)}),X.once("close",function(){if(Y.destroyed)return;Y.push(null)}),Y._destroy=function(G,J){if(X.readyState===X.CLOSED){J(G),process.nextTick(xZ,Y);return}let _=!1;if(X.once("error",function(H){_=!0,J(H)}),X.once("close",function(){if(!_)J(G);process.nextTick(xZ,Y)}),Z)X.terminate()},Y._final=function(G){if(X.readyState===X.CONNECTING){X.once("open",function(){Y._final(G)});return}if(X._socket===null)return;if(X._socket._writableState.finished){if(G(),Y._readableState.endEmitted)Y.destroy()}else X._socket.once("finish",function(){G()}),X.close()},Y._read=function(){if(X.isPaused)X.resume()},Y._write=function(G,J,_){if(X.readyState===X.CONNECTING){X.once("open",function(){Y._write(G,J,_)});return}X.send(G,_)},Y.on("end",rG),Y.on("error",PZ),Y}QZ.exports=tG});var TZ=d((_z,BZ)=>{var{tokenChars:aG}=b2();function eG(X){let $=new Set,Z=-1,Y=-1,G=0;for(G;G<X.length;G++){let _=X.charCodeAt(G);if(Y===-1&&aG[_]===1){if(Z===-1)Z=G}else if(G!==0&&(_===32||_===9)){if(Y===-1&&Z!==-1)Y=G}else if(_===44){if(Z===-1)throw SyntaxError(`Unexpected character at index ${G}`);if(Y===-1)Y=G;let z=X.slice(Z,Y);if($.has(z))throw SyntaxError(`The "${z}" subprotocol is duplicated`);$.add(z),Z=Y=-1}else throw SyntaxError(`Unexpected character at index ${G}`)}if(Z===-1||Y!==-1)throw SyntaxError("Unexpected end of input");let J=X.slice(Z,G);if($.has(J))throw SyntaxError(`The "${J}" subprotocol is duplicated`);return $.add(J),$}BZ.exports={parse:eG}});var qZ=d((Hz,vZ)=>{var XJ=h("events"),x6=h("http"),{Duplex:zz}=h("stream"),{createHash:$J}=h("crypto"),wZ=k4(),M2=B0(),ZJ=TZ(),YJ=E6(),{GUID:GJ,kWebSocket:JJ}=b1(),_J=/^[+/0-9A-Za-z]{22}==$/;class CZ extends XJ{constructor(X,$){super();if(X={allowSynchronousEvents:!0,autoPong:!0,maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!1,handleProtocols:null,clientTracking:!0,verifyClient:null,noServer:!1,backlog:null,server:null,host:null,path:null,port:null,WebSocket:YJ,...X},X.port==null&&!X.server&&!X.noServer||X.port!=null&&(X.server||X.noServer)||X.server&&X.noServer)throw TypeError('One and only one of the "port", "server", or "noServer" options must be specified');if(X.port!=null)this._server=x6.createServer((Z,Y)=>{let G=x6.STATUS_CODES[426];Y.writeHead(426,{"Content-Length":G.length,"Content-Type":"text/plain"}),Y.end(G)}),this._server.listen(X.port,X.host,X.backlog,$);else if(X.server)this._server=X.server;if(this._server){let Z=this.emit.bind(this,"connection");this._removeListeners=zJ(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(Y,G,J)=>{this.handleUpgrade(Y,G,J,Z)}})}if(X.perMessageDeflate===!0)X.perMessageDeflate={};if(X.clientTracking)this.clients=new Set,this._shouldEmitClose=!1;this.options=X,this._state=0}address(){if(this.options.noServer)throw Error('The server is operating in "noServer" mode');if(!this._server)return null;return this._server.address()}close(X){if(this._state===2){if(X)this.once("close",()=>{X(Error("The server is not running"))});process.nextTick(C0,this);return}if(X)this.once("close",X);if(this._state===1)return;if(this._state=1,this.options.noServer||this.options.server){if(this._server)this._removeListeners(),this._removeListeners=this._server=null;if(this.clients)if(!this.clients.size)process.nextTick(C0,this);else this._shouldEmitClose=!0;else process.nextTick(C0,this)}else{let $=this._server;this._removeListeners(),this._removeListeners=this._server=null,$.close(()=>{C0(this)})}}shouldHandle(X){if(this.options.path){let $=X.url.indexOf("?");if(($!==-1?X.url.slice(0,$):X.url)!==this.options.path)return!1}return!0}handleUpgrade(X,$,Z,Y){$.on("error",LZ);let G=X.headers["sec-websocket-key"],J=X.headers.upgrade,_=+X.headers["sec-websocket-version"];if(X.method!=="GET"){E2(this,X,$,405,"Invalid HTTP method");return}if(J===void 0||J.toLowerCase()!=="websocket"){E2(this,X,$,400,"Invalid Upgrade header");return}if(G===void 0||!_J.test(G)){E2(this,X,$,400,"Missing or invalid Sec-WebSocket-Key header");return}if(_!==13&&_!==8){E2(this,X,$,400,"Missing or invalid Sec-WebSocket-Version header",{"Sec-WebSocket-Version":"13, 8"});return}if(!this.shouldHandle(X)){v0($,400);return}let z=X.headers["sec-websocket-protocol"],H=new Set;if(z!==void 0)try{H=ZJ.parse(z)}catch(U){E2(this,X,$,400,"Invalid Sec-WebSocket-Protocol header");return}let W=X.headers["sec-websocket-extensions"],K={};if(this.options.perMessageDeflate&&W!==void 0){let U=new M2(this.options.perMessageDeflate,!0,this.options.maxPayload);try{let F=wZ.parse(W);if(F[M2.extensionName])U.accept(F[M2.extensionName]),K[M2.extensionName]=U}catch(F){E2(this,X,$,400,"Invalid or unacceptable Sec-WebSocket-Extensions header");return}}if(this.options.verifyClient){let U={origin:X.headers[`${_===8?"sec-websocket-origin":"origin"}`],secure:!!(X.socket.authorized||X.socket.encrypted),req:X};if(this.options.verifyClient.length===2){this.options.verifyClient(U,(F,M,R,I)=>{if(!F)return v0($,M||401,R,I);this.completeUpgrade(K,G,H,X,$,Z,Y)});return}if(!this.options.verifyClient(U))return v0($,401)}this.completeUpgrade(K,G,H,X,$,Z,Y)}completeUpgrade(X,$,Z,Y,G,J,_){if(!G.readable||!G.writable)return G.destroy();if(G[JJ])throw Error("server.handleUpgrade() was called more than once with the same socket, possibly due to a misconfiguration");if(this._state>0)return v0(G,503);let H=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade",`Sec-WebSocket-Accept: ${$J("sha1").update($+GJ).digest("base64")}`],W=new this.options.WebSocket(null,void 0,this.options);if(Z.size){let K=this.options.handleProtocols?this.options.handleProtocols(Z,Y):Z.values().next().value;if(K)H.push(`Sec-WebSocket-Protocol: ${K}`),W._protocol=K}if(X[M2.extensionName]){let K=X[M2.extensionName].params,U=wZ.format({[M2.extensionName]:[K]});H.push(`Sec-WebSocket-Extensions: ${U}`),W._extensions=X}if(this.emit("headers",H,Y),G.write(H.concat(`\r
`).join(`\r
`)),G.removeListener("error",LZ),W.setSocket(G,J,{allowSynchronousEvents:this.options.allowSynchronousEvents,maxPayload:this.options.maxPayload,skipUTF8Validation:this.options.skipUTF8Validation}),this.clients)this.clients.add(W),W.on("close",()=>{if(this.clients.delete(W),this._shouldEmitClose&&!this.clients.size)process.nextTick(C0,this)});_(W,Y)}}vZ.exports=CZ;function zJ(X,$){for(let Z of Object.keys($))X.on(Z,$[Z]);return function(){for(let Y of Object.keys($))X.removeListener(Y,$[Y])}}function C0(X){X._state=2,X.emit("close")}function LZ(){this.destroy()}function v0(X,$,Z,Y){Z=Z||x6.STATUS_CODES[$],Y={Connection:"close","Content-Type":"text/html","Content-Length":Buffer.byteLength(Z),...Y},X.once("finish",X.destroy),X.end(`HTTP/1.1 ${$} ${x6.STATUS_CODES[$]}\r
`+Object.keys(Y).map((G)=>`${G}: ${Y[G]}`).join(`\r
`)+`\r
\r
`+Z)}function E2(X,$,Z,Y,G,J){if(X.listenerCount("wsClientError")){let _=Error(G);Error.captureStackTrace(_,E2),X.emit("wsClientError",_,Z,$)}else v0(Z,Y,G,J)}});var $8=d((zA,O7)=>{function B9(X){var $=0,Z=[];function Y(){if($--,$<X)G()}function G(){var H=Z.shift();if(z.queue=Z.length,H)_(H.fn).then(H.resolve).catch(H.reject)}function J(H){return new Promise(function(W,K){Z.push({fn:H,resolve:W,reject:K}),z.queue=Z.length})}function _(H){$++;try{return Promise.resolve(H()).then(function(W){return Y(),W},function(W){throw Y(),W})}catch(W){return Y(),Promise.reject(W)}}var z=function(H){if($>=X)return J(H);else return _(H)};return z}function T9(X,$){var Z=!1,Y=this;return Promise.all(X.map(function(){var G=arguments;return Y(function(){if(!Z)return $.apply(void 0,G).catch(function(J){throw Z=!0,J})})}))}function A7(X){return X.queue=0,X.map=T9,X}O7.exports=function(X){if(X)return A7(B9(X));else return A7(function($){return $()})}});import e6 from"node:fs";import X4 from"node:path";class s6{config;cachedIndex=null;indexingPromise=null;status={isIndexing:!1,progress:0,totalItems:0,indexedItems:0,startTime:0};constructor(X){this.config=X}getStatus(){return{...this.status}}isReady(){return this.cachedIndex!==null&&!this.status.isIndexing}startBackgroundIndexing(){if(this.status.isIndexing||this.cachedIndex)return;console.error(`[INFO] Starting background ${this.config.name} indexing...`),this.loadIndex().catch((X)=>{console.error(`[ERROR] Background ${this.config.name} indexing failed:`,X)})}async loadIndex(){if(this.cachedIndex)return this.cachedIndex;if(this.indexingPromise)return this.indexingPromise;return this.status.isIndexing=!0,this.status.progress=0,this.status.startTime=Date.now(),this.status.error=void 0,this.indexingPromise=this.buildIndex().then((X)=>{return this.cachedIndex=X,this.status.isIndexing=!1,this.status.progress=100,this.status.totalItems=X.totalDocuments,this.status.indexedItems=X.totalDocuments,console.error(`[INFO] ${this.config.name} indexing complete: ${X.totalDocuments} documents`),X}).catch((X)=>{throw this.status.isIndexing=!1,this.status.error=X instanceof Error?X.message:String(X),console.error(`[ERROR] ${this.config.name} indexing failed:`,X),X}),this.indexingPromise}clearCache(){this.cachedIndex=null,this.indexingPromise=null,this.status={isIndexing:!1,progress:0,totalItems:0,indexedItems:0,startTime:0}}async getStats(){let X=await this.loadIndex();if(!X)return null;return{totalDocuments:X.totalDocuments,uniqueTerms:X.idf.size,generatedAt:X.metadata.generatedAt,version:X.metadata.version}}}class y1{static step1aRules=[{pattern:/sses$/i,replacement:"ss"},{pattern:/ies$/i,replacement:"i"},{pattern:/ss$/i,replacement:"ss"},{pattern:/s$/i,replacement:""}];static step1bRules=[{pattern:/eed$/i,replacement:"ee"},{pattern:/ed$/i,replacement:""},{pattern:/ing$/i,replacement:""}];static step1cRules=[{pattern:/y$/i,replacement:"i"}];static step2Rules=[{pattern:/ational$/i,replacement:"ate"},{pattern:/tional$/i,replacement:"tion"},{pattern:/enci$/i,replacement:"ence"},{pattern:/anci$/i,replacement:"ance"},{pattern:/izer$/i,replacement:"ize"},{pattern:/abli$/i,replacement:"able"},{pattern:/alli$/i,replacement:"al"},{pattern:/entli$/i,replacement:"ent"},{pattern:/eli$/i,replacement:"e"},{pattern:/ousli$/i,replacement:"ous"},{pattern:/ization$/i,replacement:"ize"},{pattern:/ation$/i,replacement:"ate"},{pattern:/ator$/i,replacement:"ate"},{pattern:/alism$/i,replacement:"al"},{pattern:/iveness$/i,replacement:"ive"},{pattern:/fulness$/i,replacement:"ful"},{pattern:/ousness$/i,replacement:"ous"},{pattern:/aliti$/i,replacement:"al"},{pattern:/iviti$/i,replacement:"ive"},{pattern:/biliti$/i,replacement:"ble"}];static step3Rules=[{pattern:/icate$/i,replacement:"ic"},{pattern:/ative$/i,replacement:""},{pattern:/alize$/i,replacement:"al"},{pattern:/iciti$/i,replacement:"ic"},{pattern:/ical$/i,replacement:"ic"},{pattern:/ful$/i,replacement:""},{pattern:/ness$/i,replacement:""}];static step4Rules=[{pattern:/al$/i,replacement:""},{pattern:/ance$/i,replacement:""},{pattern:/ence$/i,replacement:""},{pattern:/er$/i,replacement:""},{pattern:/ic$/i,replacement:""},{pattern:/able$/i,replacement:""},{pattern:/ible$/i,replacement:""},{pattern:/ant$/i,replacement:""},{pattern:/ement$/i,replacement:""},{pattern:/ment$/i,replacement:""},{pattern:/ent$/i,replacement:""},{pattern:/ion$/i,replacement:""},{pattern:/ou$/i,replacement:""},{pattern:/ism$/i,replacement:""},{pattern:/ate$/i,replacement:""},{pattern:/iti$/i,replacement:""},{pattern:/ous$/i,replacement:""},{pattern:/ive$/i,replacement:""},{pattern:/ize$/i,replacement:""}];static step5Rules=[{pattern:/e$/i,replacement:""},{pattern:/ll$/i,replacement:"l"}];static stem(X){if(X.length<3)return X.toLowerCase();let $=X.toLowerCase();for(let Z of y1.step1aRules)if(Z.pattern.test($)){$=$.replace(Z.pattern,Z.replacement);break}for(let Z of y1.step1bRules)if(Z.pattern.test($)){$=$.replace(Z.pattern,Z.replacement);break}for(let Z of y1.step1cRules)if(Z.pattern.test($)&&$.length>2){$=$.replace(Z.pattern,Z.replacement);break}for(let Z of y1.step2Rules)if(Z.pattern.test($)){$=$.replace(Z.pattern,Z.replacement);break}for(let Z of y1.step3Rules)if(Z.pattern.test($)){$=$.replace(Z.pattern,Z.replacement);break}for(let Z of y1.step4Rules)if(Z.pattern.test($)&&$.length>3){$=$.replace(Z.pattern,Z.replacement);break}for(let Z of y1.step5Rules)if(Z.pattern.test($)&&$.length>2){$=$.replace(Z.pattern,Z.replacement);break}return $}}function r6(X){return X.replace(/```[\s\S]*?```/g," ").replace(/`[^`]+`/g," ").replace(/#{1,6}\s/g,"").replace(/[*_~]/g,"").replace(/\[([^\]]+)\]\([^)]+\)/g,"$1").toLowerCase().split(/[^a-z0-9_-]+/).filter((Y)=>Y.length>1)}function t6(X){let $=r6(X),Z=new Map;for(let Y of $){let G=y1.stem(Y);Z.set(G,(Z.get(G)||0)+1)}return Z}var R5=new Set(["a","an","and","are","as","at","be","by","for","from","has","he","in","is","it","its","of","on","that","the","to","was","will","with","this","but","they","have","had","what","when","where","who","which","why","how"]);function B8(X){return X.filter(($)=>!R5.has($.toLowerCase()))}function T8(X){let $=Array.from(X.values()).reduce((Y,G)=>Y+G,0),Z=new Map;for(let[Y,G]of X.entries())Z.set(Y,G/$);return Z}function I5(X,$){let Z=new Map;for(let G of X){let J=new Set(G.keys());for(let _ of J)Z.set(_,(Z.get(_)||0)+1)}let Y=new Map;for(let[G,J]of Z.entries())Y.set(G,Math.log($/J));return Y}function w8(X,$){let Z=new Map;for(let[Y,G]of X.entries()){let J=$.get(Y)||0;Z.set(Y,G*J)}return Z}function L8(X){let $=0;for(let Z of X.values())$+=Z*Z;return Math.sqrt($)}function C8(X){let $=X.map((G)=>({uri:G.uri,terms:t6(G.content)})),Z=I5($.map((G)=>G.terms),X.length);return{documents:$.map((G)=>{let J=T8(G.terms),_=w8(J,Z),z=L8(_);return{uri:G.uri,terms:_,rawTerms:G.terms,magnitude:z}}),idf:Z,totalDocuments:X.length,metadata:{generatedAt:new Date().toISOString(),version:"1.0.0"}}}function F5(X,$){let Z=0;for(let[G,J]of X.entries()){let _=$.terms.get(G)||0;Z+=J*_}let Y=L8(X);if(Y===0||$.magnitude===0)return 0;return Z/(Y*$.magnitude)}function N5(X,$){let Z=t6(X),Y=T8(Z);return w8(Y,$)}function a6(X,$,Z={}){let{limit:Y=10,minScore:G=0,boostFactors:J={}}=Z,{exactMatch:_=1.5,phraseMatch:z=2}=J,H=N5(X,$.idf),W=B8(r6(X));return $.documents.map((U)=>{let F=F5(H,U),M=[];for(let R of W)if(U.rawTerms.has(R))F*=_,M.push(R);if(M.length===W.length&&W.length>1)F*=z;return{uri:U.uri,score:F,matchedTerms:M}}).filter((U)=>U.score>=G).sort((U,F)=>F.score-U.score).slice(0,Y)}class q8 extends s6{embeddingProvider;vectorStorage;constructor(X){super({name:"knowledge",autoStart:!0});this.embeddingProvider=X}scanKnowledgeFiles(X){let $=[],Z=(Y,G)=>{let J=e6.readdirSync(Y,{withFileTypes:!0});for(let _ of J){let z=X4.join(Y,_.name);if(_.isDirectory())Z(z,G);else if(_.isFile()&&_.name.endsWith(".md")){let W=X4.relative(G,z).replace(/\.md$/,"").replace(/\\/g,"/"),K=e6.readFileSync(z,"utf8");$.push({uri:`knowledge://${W}`,content:K})}}};return Z(X,X),$}async buildIndex(){let X=Z4();if(!e6.existsSync(X))throw Error(`Knowledge directory not found: ${X}`);let $=this.scanKnowledgeFiles(X);console.error(`[INFO] Found ${$.length} knowledge files`);let Z=C8($);if(this.embeddingProvider&&$.length>0){console.error("[INFO] Building vector index for knowledge...");try{let Y=X4.join(Z4(),"..",".sylphx-flow","knowledge-vectors.hnsw");this.vectorStorage=new v8(Y,this.embeddingProvider.dimensions||1536),await this.vectorStorage.initialize();let G=10;for(let J=0;J<$.length;J+=G){let _=$.slice(J,J+G),z=await this.embeddingProvider.generateEmbeddings(_.map((H)=>H.content));for(let H=0;H<_.length;H++){let W=_[H],K=z[H];await this.vectorStorage.addDocument({id:W.uri,embedding:K,metadata:{type:"knowledge",content:W.content.slice(0,500),category:"knowledge",language:"markdown"}})}console.error(`[INFO] Processed ${Math.min(J+G,$.length)}/${$.length} knowledge files`)}await this.vectorStorage.save(),console.error("[INFO] Vector index built successfully")}catch(Y){console.error("[ERROR] Failed to build vector index:",Y),this.vectorStorage=void 0}}return Z}}var $4=null;function Y4(X){if(!$4)$4=new q8(X);return $4}var O=Symbol.for("drizzle:entityKind");function D(X,$){if(!X||typeof X!=="object")return!1;if(X instanceof $)return!0;if(!Object.prototype.hasOwnProperty.call($,O))throw Error(`Class "${$.name??"<unknown>"}" doesn't look like a Drizzle entity. If this is incorrect and the class is provided by Drizzle, please report this as a bug.`);let Z=Object.getPrototypeOf(X).constructor;if(Z)while(Z){if(O in Z&&Z[O]===$[O])return!0;Z=Object.getPrototypeOf(Z)}return!1}class v{constructor(X,$){this.table=X,this.config=$,this.name=$.name,this.keyAsName=$.keyAsName,this.notNull=$.notNull,this.default=$.default,this.defaultFn=$.defaultFn,this.onUpdateFn=$.onUpdateFn,this.hasDefault=$.hasDefault,this.primary=$.primaryKey,this.isUnique=$.isUnique,this.uniqueName=$.uniqueName,this.uniqueType=$.uniqueType,this.dataType=$.dataType,this.columnType=$.columnType,this.generated=$.generated,this.generatedIdentity=$.generatedIdentity}static[O]="Column";name;keyAsName;primary;notNull;default;defaultFn;onUpdateFn;hasDefault;isUnique;uniqueName;uniqueType;dataType;columnType;enumValues=void 0;generated=void 0;generatedIdentity=void 0;config;mapFromDriverValue(X){return X}mapToDriverValue(X){return X}shouldDisableInsert(){return this.config.generated!==void 0&&this.config.generated.type!=="byDefault"}}class G4{static[O]="ColumnBuilder";config;constructor(X,$,Z){this.config={name:X,keyAsName:X==="",notNull:!1,default:void 0,hasDefault:!1,primaryKey:!1,isUnique:!1,uniqueName:void 0,uniqueType:void 0,dataType:$,columnType:Z,generated:void 0}}$type(){return this}notNull(){return this.config.notNull=!0,this}default(X){return this.config.default=X,this.config.hasDefault=!0,this}$defaultFn(X){return this.config.defaultFn=X,this.config.hasDefault=!0,this}$default=this.$defaultFn;$onUpdateFn(X){return this.config.onUpdateFn=X,this.config.hasDefault=!0,this}$onUpdate=this.$onUpdateFn;primaryKey(){return this.config.primaryKey=!0,this.config.notNull=!0,this}setName(X){if(this.config.name!=="")return;this.config.name=X}}var z1=Symbol.for("drizzle:Name");function h8(X,...$){return X(...$)}function S8(X,$){return`${X[z1]}_${$.join("_")}_unique`}class A0 extends v{constructor(X,$){if(!$.uniqueName)$.uniqueName=S8(X,[$.name]);super(X,$);this.table=X}static[O]="PgColumn"}class M5 extends A0{static[O]="ExtraConfigColumn";getSQLType(){return this.getSQLType()}indexConfig={order:this.config.order??"asc",nulls:this.config.nulls??"last",opClass:this.config.opClass};defaultConfig={order:"asc",nulls:"last",opClass:void 0};asc(){return this.indexConfig.order="asc",this}desc(){return this.indexConfig.order="desc",this}nullsFirst(){return this.indexConfig.nulls="first",this}nullsLast(){return this.indexConfig.nulls="last",this}op(X){return this.indexConfig.opClass=X,this}}class E5 extends A0{static[O]="PgEnumObjectColumn";enum;enumValues=this.config.enum.enumValues;constructor(X,$){super(X,$);this.enum=$.enum}getSQLType(){return this.enum.enumName}}var k8=Symbol.for("drizzle:isPgEnum");function y8(X){return!!X&&typeof X==="function"&&k8 in X&&X[k8]===!0}class x5 extends A0{static[O]="PgEnumColumn";enum=this.config.enum;enumValues=this.config.enum.enumValues;constructor(X,$){super(X,$);this.enum=$.enum}getSQLType(){return this.enum.enumName}}class c{static[O]="Subquery";constructor(X,$,Z,Y=!1,G=[]){this._={brand:"Subquery",sql:X,selectedFields:$,alias:Z,isWith:Y,usedTables:G}}}class O0 extends c{static[O]="WithSubquery"}var f8="0.44.7";var J4,_4,g8={startActiveSpan(X,$){if(!J4)return $();if(!_4)_4=J4.trace.getTracer("drizzle-orm",f8);return h8((Z,Y)=>Y.startActiveSpan(X,(G)=>{try{return $(G)}catch(J){throw G.setStatus({code:Z.SpanStatusCode.ERROR,message:J instanceof Error?J.message:"Unknown error"}),J}finally{G.end()}}),J4,_4)}};var f=Symbol.for("drizzle:ViewBaseConfig");var $6=Symbol.for("drizzle:Schema"),Z6=Symbol.for("drizzle:Columns"),p8=Symbol.for("drizzle:ExtraConfigColumns"),z4=Symbol.for("drizzle:OriginalName"),H4=Symbol.for("drizzle:BaseName"),K0=Symbol.for("drizzle:IsAlias"),b8=Symbol.for("drizzle:ExtraConfigBuilder"),P5=Symbol.for("drizzle:IsDrizzleTable");class V{static[O]="Table";static Symbol={Name:z1,Schema:$6,OriginalName:z4,Columns:Z6,ExtraConfigColumns:p8,BaseName:H4,IsAlias:K0,ExtraConfigBuilder:b8};[z1];[z4];[$6];[Z6];[p8];[H4];[K0]=!1;[P5]=!0;[b8]=void 0;constructor(X,$,Z){this[z1]=this[z4]=X,this[$6]=$,this[H4]=Z}}function o1(X){return X[z1]}function K2(X){return`${X[$6]??"public"}.${X[z1]}`}function W4(X){return X!==null&&X!==void 0&&typeof X.getSQL==="function"}function Q5(X){let $={sql:"",params:[]};for(let Z of X)if($.sql+=Z.sql,$.params.push(...Z.params),Z.typings?.length){if(!$.typings)$.typings=[];$.typings.push(...Z.typings)}return $}class o{static[O]="StringChunk";value;constructor(X){this.value=Array.isArray(X)?X:[X]}getSQL(){return new N([this])}}class N{constructor(X){this.queryChunks=X;for(let $ of X)if(D($,V)){let Z=$[V.Symbol.Schema];this.usedTables.push(Z===void 0?$[V.Symbol.Name]:Z+"."+$[V.Symbol.Name])}}static[O]="SQL";decoder=m8;shouldInlineParams=!1;usedTables=[];append(X){return this.queryChunks.push(...X.queryChunks),this}toQuery(X){return g8.startActiveSpan("drizzle.buildSQL",($)=>{let Z=this.buildQueryFromSourceParams(this.queryChunks,X);return $?.setAttributes({"drizzle.query.text":Z.sql,"drizzle.query.params":JSON.stringify(Z.params)}),Z})}buildQueryFromSourceParams(X,$){let Z=Object.assign({},$,{inlineParams:$.inlineParams||this.shouldInlineParams,paramStartIndex:$.paramStartIndex||{value:0}}),{casing:Y,escapeName:G,escapeParam:J,prepareTyping:_,inlineParams:z,paramStartIndex:H}=Z;return Q5(X.map((W)=>{if(D(W,o))return{sql:W.value.join(""),params:[]};if(D(W,Y6))return{sql:G(W.value),params:[]};if(W===void 0)return{sql:"",params:[]};if(Array.isArray(W)){let K=[new o("(")];for(let[U,F]of W.entries())if(K.push(F),U<W.length-1)K.push(new o(", "));return K.push(new o(")")),this.buildQueryFromSourceParams(K,Z)}if(D(W,N))return this.buildQueryFromSourceParams(W.queryChunks,{...Z,inlineParams:z||W.shouldInlineParams});if(D(W,V)){let K=W[V.Symbol.Schema],U=W[V.Symbol.Name];return{sql:K===void 0||W[K0]?G(U):G(K)+"."+G(U),params:[]}}if(D(W,v)){let K=Y.getColumnCasing(W);if($.invokeSource==="indexes")return{sql:G(K),params:[]};let U=W.table[V.Symbol.Schema];return{sql:W.table[K0]||U===void 0?G(W.table[V.Symbol.Name])+"."+G(K):G(U)+"."+G(W.table[V.Symbol.Name])+"."+G(K),params:[]}}if(D(W,D1)){let K=W[f].schema,U=W[f].name;return{sql:K===void 0||W[f].isAlias?G(U):G(K)+"."+G(U),params:[]}}if(D(W,H1)){if(D(W.value,s1))return{sql:J(H.value++,W),params:[W],typings:["none"]};let K=W.value===null?null:W.encoder.mapToDriverValue(W.value);if(D(K,N))return this.buildQueryFromSourceParams([K],Z);if(z)return{sql:this.mapInlineParam(K,Z),params:[]};let U=["none"];if(_)U=[_(W.encoder)];return{sql:J(H.value++,K),params:[K],typings:U}}if(D(W,s1))return{sql:J(H.value++,W),params:[W],typings:["none"]};if(D(W,N.Aliased)&&W.fieldAlias!==void 0)return{sql:G(W.fieldAlias),params:[]};if(D(W,c)){if(W._.isWith)return{sql:G(W._.alias),params:[]};return this.buildQueryFromSourceParams([new o("("),W._.sql,new o(") "),new Y6(W._.alias)],Z)}if(y8(W)){if(W.schema)return{sql:G(W.schema)+"."+G(W.enumName),params:[]};return{sql:G(W.enumName),params:[]}}if(W4(W)){if(W.shouldOmitSQLParens?.())return this.buildQueryFromSourceParams([W.getSQL()],Z);return this.buildQueryFromSourceParams([new o("("),W.getSQL(),new o(")")],Z)}if(z)return{sql:this.mapInlineParam(W,Z),params:[]};return{sql:J(H.value++,W),params:[W],typings:["none"]}}))}mapInlineParam(X,{escapeString:$}){if(X===null)return"null";if(typeof X==="number"||typeof X==="boolean")return X.toString();if(typeof X==="string")return $(X);if(typeof X==="object"){let Z=X.toString();if(Z==="[object Object]")return $(JSON.stringify(X));return $(Z)}throw Error("Unexpected param value: "+X)}getSQL(){return this}as(X){if(X===void 0)return this;return new N.Aliased(this,X)}mapWith(X){return this.decoder=typeof X==="function"?{mapFromDriverValue:X}:X,this}inlineParams(){return this.shouldInlineParams=!0,this}if(X){return X?this:void 0}}class Y6{constructor(X){this.value=X}static[O]="Name";brand;getSQL(){return new N([this])}}function d8(X){return typeof X==="object"&&X!==null&&"mapToDriverValue"in X&&typeof X.mapToDriverValue==="function"}var m8={mapFromDriverValue:(X)=>X},u8={mapToDriverValue:(X)=>X},C_={...m8,...u8};class H1{constructor(X,$=u8){this.value=X,this.encoder=$}static[O]="Param";brand;getSQL(){return new N([this])}}function A(X,...$){let Z=[];if($.length>0||X.length>0&&X[0]!=="")Z.push(new o(X[0]));for(let[Y,G]of $.entries())Z.push(G,new o(X[Y+1]));return new N(Z)}((X)=>{function $(){return new N([])}X.empty=$;function Z(H){return new N(H)}X.fromList=Z;function Y(H){return new N([new o(H)])}X.raw=Y;function G(H,W){let K=[];for(let[U,F]of H.entries()){if(U>0&&W!==void 0)K.push(W);K.push(F)}return new N(K)}X.join=G;function J(H){return new Y6(H)}X.identifier=J;function _(H){return new s1(H)}X.placeholder=_;function z(H,W){return new H1(H,W)}X.param=z})(A||(A={}));((X)=>{class ${constructor(Z,Y){this.sql=Z,this.fieldAlias=Y}static[O]="SQL.Aliased";isSelectionField=!1;getSQL(){return this.sql}clone(){return new $(this.sql,this.fieldAlias)}}X.Aliased=$})(N||(N={}));class s1{constructor(X){this.name=X}static[O]="Placeholder";getSQL(){return new N([this])}}function D0(X,$){return X.map((Z)=>{if(D(Z,s1)){if(!(Z.name in $))throw Error(`No value for placeholder "${Z.name}" was provided`);return $[Z.name]}if(D(Z,H1)&&D(Z.value,s1)){if(!(Z.value.name in $))throw Error(`No value for placeholder "${Z.value.name}" was provided`);return Z.encoder.mapToDriverValue($[Z.value.name])}return Z})}var j5=Symbol.for("drizzle:IsDrizzleView");class D1{static[O]="View";[f];[j5]=!0;constructor({name:X,schema:$,selectedFields:Z,query:Y}){this[f]={name:X,originalName:X,schema:$,selectedFields:Z,query:Y,isExisting:!Y,isAlias:!1}}getSQL(){return new N([this])}}v.prototype.getSQL=function(){return new N([this])};V.prototype.getSQL=function(){return new N([this])};c.prototype.getSQL=function(){return new N([this])};class C2{constructor(X){this.table=X}static[O]="ColumnAliasProxyHandler";get(X,$){if($==="table")return this.table;return X[$]}}class U0{constructor(X,$){this.alias=X,this.replaceOriginalName=$}static[O]="TableAliasProxyHandler";get(X,$){if($===V.Symbol.IsAlias)return!0;if($===V.Symbol.Name)return this.alias;if(this.replaceOriginalName&&$===V.Symbol.OriginalName)return this.alias;if($===f)return{...X[f],name:this.alias,isAlias:!0};if($===V.Symbol.Columns){let Y=X[V.Symbol.Columns];if(!Y)return Y;let G={};return Object.keys(Y).map((J)=>{G[J]=new Proxy(Y[J],new C2(new Proxy(X,this)))}),G}let Z=X[$];if(D(Z,v))return new Proxy(Z,new C2(new Proxy(X,this)));return Z}}function G6(X,$){return new Proxy(X,new U0($,!1))}function T1(X,$){return new Proxy(X,new C2(new Proxy(X.table,new U0($,!1))))}function A4(X,$){return new N.Aliased(V0(X.sql,$),X.fieldAlias)}function V0(X,$){return A.join(X.queryChunks.map((Z)=>{if(D(Z,v))return T1(Z,$);if(D(Z,N))return V0(Z,$);if(D(Z,N.Aliased))return A4(Z,$);return Z}))}class v2 extends Error{static[O]="DrizzleError";constructor({message:X,cause:$}){super(X);this.name="DrizzleError",this.cause=$}}class f1 extends Error{constructor(X,$,Z){super(`Failed query: ${X}
params: ${$}`);if(this.query=X,this.params=$,this.cause=Z,Error.captureStackTrace(this,f1),Z)this.cause=Z}}class O4 extends v2{static[O]="TransactionRollbackError";constructor(){super({message:"Rollback"})}}class c8{static[O]="ConsoleLogWriter";write(X){console.log(X)}}class K4{static[O]="DefaultLogger";writer;constructor(X){this.writer=X?.writer??new c8}logQuery(X,$){let Z=$.map((G)=>{try{return JSON.stringify(G)}catch{return String(G)}}),Y=Z.length?` -- params: [${Z.join(", ")}]`:"";this.writer.write(`Query: ${X}${Y}`)}}class D4{static[O]="NoopLogger";logQuery(){}}class G1{static[O]="QueryPromise";[Symbol.toStringTag]="QueryPromise";catch(X){return this.then(void 0,X)}finally(X){return this.then(($)=>{return X?.(),$},($)=>{throw X?.(),$})}then(X,$){return this.execute().then(X,$)}}function U4(X,$,Z){let Y={},G=X.reduce((J,{path:_,field:z},H)=>{let W;if(D(z,v))W=z;else if(D(z,N))W=z.decoder;else W=z.sql.decoder;let K=J;for(let[U,F]of _.entries())if(U<_.length-1){if(!(F in K))K[F]={};K=K[F]}else{let M=$[H],R=K[F]=M===null?null:W.mapFromDriverValue(M);if(Z&&D(z,v)&&_.length===2){let I=_[0];if(!(I in Y))Y[I]=R===null?o1(z.table):!1;else if(typeof Y[I]==="string"&&Y[I]!==o1(z.table))Y[I]=!1}}return J},{});if(Z&&Object.keys(Y).length>0){for(let[J,_]of Object.entries(Y))if(typeof _==="string"&&!Z[_])G[J]=null}return G}function U1(X,$){return Object.entries(X).reduce((Z,[Y,G])=>{if(typeof Y!=="string")return Z;let J=$?[...$,Y]:[Y];if(D(G,v)||D(G,N)||D(G,N.Aliased))Z.push({path:J,field:G});else if(D(G,V))Z.push(...U1(G[V.Symbol.Columns],J));else Z.push(...U1(G,J));return Z},[])}function R0(X,$){let Z=Object.keys(X),Y=Object.keys($);if(Z.length!==Y.length)return!1;for(let[G,J]of Z.entries())if(J!==Y[G])return!1;return!0}function J6(X,$){let Z=Object.entries($).filter(([,Y])=>Y!==void 0).map(([Y,G])=>{if(D(G,N)||D(G,v))return[Y,G];else return[Y,new H1(G,X[V.Symbol.Columns][Y])]});if(Z.length===0)throw Error("No values to set");return Object.fromEntries(Z)}function i8(X,$){for(let Z of $)for(let Y of Object.getOwnPropertyNames(Z.prototype)){if(Y==="constructor")continue;Object.defineProperty(X.prototype,Y,Object.getOwnPropertyDescriptor(Z.prototype,Y)||Object.create(null))}}function n8(X){return X[V.Symbol.Columns]}function I0(X){return D(X,c)?X._.alias:D(X,D1)?X[f].name:D(X,N)?void 0:X[V.Symbol.IsAlias]?X[V.Symbol.Name]:X[V.Symbol.BaseName]}function w1(X,$){return{name:typeof X==="string"&&X.length>0?X:"",config:typeof X==="object"?X:$}}function l8(X){if(typeof X!=="object"||X===null)return!1;if(X.constructor.name!=="Object")return!1;if("logger"in X){let $=typeof X.logger;if($!=="boolean"&&($!=="object"||typeof X.logger.logQuery!=="function")&&$!=="undefined")return!1;return!0}if("schema"in X){let $=typeof X.schema;if($!=="object"&&$!=="undefined")return!1;return!0}if("casing"in X){let $=typeof X.casing;if($!=="string"&&$!=="undefined")return!1;return!0}if("mode"in X){if(X.mode!=="default"||X.mode!=="planetscale"||X.mode!==void 0)return!1;return!0}if("connection"in X){let $=typeof X.connection;if($!=="string"&&$!=="object"&&$!=="undefined")return!1;return!0}if("client"in X){let $=typeof X.client;if($!=="object"&&$!=="function"&&$!=="undefined")return!1;return!0}if(Object.keys(X).length===0)return!0;return!1}var V4=typeof TextDecoder>"u"?null:new TextDecoder;var o8=Symbol.for("drizzle:PgInlineForeignKeys"),s8=Symbol.for("drizzle:EnableRLS");class R4 extends V{static[O]="PgTable";static Symbol=Object.assign({},V.Symbol,{InlineForeignKeys:o8,EnableRLS:s8});[o8]=[];[s8]=!1;[V.Symbol.ExtraConfigBuilder]=void 0;[V.Symbol.ExtraConfigColumns]={}}class I4{static[O]="PgPrimaryKeyBuilder";columns;name;constructor(X,$){this.columns=X,this.name=$}build(X){return new r8(X,this.columns,this.name)}}class r8{constructor(X,$,Z){this.table=X,this.columns=$,this.name=Z}static[O]="PgPrimaryKey";columns;name;getName(){return this.name??`${this.table[R4.Symbol.Name]}_${this.columns.map((X)=>X.name).join("_")}_pk`}}function J1(X,$){if(d8($)&&!W4(X)&&!D(X,H1)&&!D(X,s1)&&!D(X,v)&&!D(X,V)&&!D(X,D1))return new H1(X,$);return X}var w=(X,$)=>{return A`${X} = ${J1($,X)}`},t8=(X,$)=>{return A`${X} <> ${J1($,X)}`};function V1(...X){let $=X.filter((Z)=>Z!==void 0);if($.length===0)return;if($.length===1)return new N($);return new N([new o("("),A.join($,new o(" and ")),new o(")")])}function F0(...X){let $=X.filter((Z)=>Z!==void 0);if($.length===0)return;if($.length===1)return new N($);return new N([new o("("),A.join($,new o(" or ")),new o(")")])}function a8(X){return A`not ${X}`}var e8=(X,$)=>{return A`${X} > ${J1($,X)}`},XX=(X,$)=>{return A`${X} >= ${J1($,X)}`},$X=(X,$)=>{return A`${X} < ${J1($,X)}`},ZX=(X,$)=>{return A`${X} <= ${J1($,X)}`};function YX(X,$){if(Array.isArray($)){if($.length===0)return A`false`;return A`${X} in ${$.map((Z)=>J1(Z,X))}`}return A`${X} in ${J1($,X)}`}function GX(X,$){if(Array.isArray($)){if($.length===0)return A`true`;return A`${X} not in ${$.map((Z)=>J1(Z,X))}`}return A`${X} not in ${J1($,X)}`}function JX(X){return A`${X} is null`}function _X(X){return A`${X} is not null`}function zX(X){return A`exists ${X}`}function HX(X){return A`not exists ${X}`}function WX(X,$,Z){return A`${X} between ${J1($,X)} and ${J1(Z,X)}`}function AX(X,$,Z){return A`${X} not between ${J1($,X)} and ${J1(Z,X)}`}function D2(X,$){return A`${X} like ${$}`}function OX(X,$){return A`${X} not like ${$}`}function KX(X,$){return A`${X} ilike ${$}`}function DX(X,$){return A`${X} not ilike ${$}`}function UX(X){return A`${X} asc`}function U2(X){return A`${X} desc`}class F4{constructor(X,$,Z){this.sourceTable=X,this.referencedTable=$,this.relationName=Z,this.referencedTableName=$[V.Symbol.Name]}static[O]="Relation";referencedTableName;fieldName}class VX{constructor(X,$){this.table=X,this.config=$}static[O]="Relations"}class r1 extends F4{constructor(X,$,Z,Y){super(X,$,Z?.relationName);this.config=Z,this.isNullable=Y}static[O]="One";withFieldName(X){let $=new r1(this.sourceTable,this.referencedTable,this.config,this.isNullable);return $.fieldName=X,$}}class N0 extends F4{constructor(X,$,Z){super(X,$,Z?.relationName);this.config=Z}static[O]="Many";withFieldName(X){let $=new N0(this.sourceTable,this.referencedTable,this.config);return $.fieldName=X,$}}function RX(){return{and:V1,between:WX,eq:w,exists:zX,gt:e8,gte:XX,ilike:KX,inArray:YX,isNull:JX,isNotNull:_X,like:D2,lt:$X,lte:ZX,ne:t8,not:a8,notBetween:AX,notExists:HX,notLike:OX,notIlike:DX,notInArray:GX,or:F0,sql:A}}function IX(){return{sql:A,asc:UX,desc:U2}}function FX(X,$){if(Object.keys(X).length===1&&"default"in X&&!D(X.default,V))X=X.default;let Z={},Y={},G={};for(let[J,_]of Object.entries(X))if(D(_,V)){let z=K2(_),H=Y[z];Z[z]=J,G[J]={tsName:J,dbName:_[V.Symbol.Name],schema:_[V.Symbol.Schema],columns:_[V.Symbol.Columns],relations:H?.relations??{},primaryKey:H?.primaryKey??[]};for(let K of Object.values(_[V.Symbol.Columns]))if(K.primary)G[J].primaryKey.push(K);let W=_[V.Symbol.ExtraConfigBuilder]?.(_[V.Symbol.ExtraConfigColumns]);if(W){for(let K of Object.values(W))if(D(K,I4))G[J].primaryKey.push(...K.columns)}}else if(D(_,VX)){let z=K2(_.table),H=Z[z],W=_.config($(_.table)),K;for(let[U,F]of Object.entries(W))if(H){let M=G[H];if(M.relations[U]=F,K)M.primaryKey.push(...K)}else{if(!(z in Y))Y[z]={relations:{},primaryKey:K};Y[z].relations[U]=F}}return{tables:G,tableNamesMap:Z}}function B5(X){return function(Z,Y){return new r1(X,Z,Y,Y?.fields.reduce((G,J)=>G&&J.notNull,!0)??!1)}}function T5(X){return function(Z,Y){return new N0(X,Z,Y)}}function NX(X,$,Z){if(D(Z,r1)&&Z.config)return{fields:Z.config.fields,references:Z.config.references};let Y=$[K2(Z.referencedTable)];if(!Y)throw Error(`Table "${Z.referencedTable[V.Symbol.Name]}" not found in schema`);let G=X[Y];if(!G)throw Error(`Table "${Y}" not found in schema`);let J=Z.sourceTable,_=$[K2(J)];if(!_)throw Error(`Table "${J[V.Symbol.Name]}" not found in schema`);let z=[];for(let H of Object.values(G.relations))if(Z.relationName&&Z!==H&&H.relationName===Z.relationName||!Z.relationName&&H.referencedTable===Z.sourceTable)z.push(H);if(z.length>1)throw Z.relationName?Error(`There are multiple relations with name "${Z.relationName}" in table "${Y}"`):Error(`There are multiple relations between "${Y}" and "${Z.sourceTable[V.Symbol.Name]}". Please specify relation name`);if(z[0]&&D(z[0],r1)&&z[0].config)return{fields:z[0].config.references,references:z[0].config.fields};throw Error(`There is not enough information to infer relation "${_}.${Z.fieldName}"`)}function MX(X){return{one:B5(X),many:T5(X)}}function _6(X,$,Z,Y,G=(J)=>J){let J={};for(let[_,z]of Y.entries())if(z.isJson){let H=$.relations[z.tsKey],W=Z[_],K=typeof W==="string"?JSON.parse(W):W;J[z.tsKey]=D(H,r1)?K&&_6(X,X[z.relationTableTsKey],K,z.selection,G):K.map((U)=>_6(X,X[z.relationTableTsKey],U,z.selection,G))}else{let H=G(Z[_]),W=z.field,K;if(D(W,v))K=W;else if(D(W,N))K=W.decoder;else K=W.sql.decoder;J[z.tsKey]=H===null?null:K.mapFromDriverValue(H)}return J}function t1(X){return A`count(${X||A.raw("*")})`.mapWith(Number)}import*as N8 from"node:path";class e extends Error{operation;cause;context;constructor(X,$,Z,Y){super(X);this.operation=$;this.cause=Z;this.context=Y;if(this.name="DatabaseError",Error.captureStackTrace)Error.captureStackTrace(this,e)}toJSON(){return{name:this.name,message:this.message,operation:this.operation,context:this.context,cause:this.cause?.message,stack:this.stack}}}class w5 extends e{field;value;constructor(X,$,Z,Y){super(X,"validation",Y,{field:$,value:Z});this.field=$;this.value=Z;this.name="ValidationError"}}class N4 extends e{connectionDetails;constructor(X,$,Z){super(X,"connection",Z,$);this.connectionDetails=$;this.name="ConnectionError"}}async function k(X,$,Z){try{return await $()}catch(Y){if(Y instanceof e)throw Y;throw new e(`Database operation failed: ${X}`,X,Y,Z)}}import*as l6 from"node:fs";import*as a0 from"node:path";class Q extends Error{code;rawCode;constructor(X,$,Z,Y){if($!==void 0)X=`${$}: ${X}`;super(X,{cause:Y});this.code=$,this.rawCode=Z,this.name="LibsqlError"}}function EX(X){let $=L5.exec(X);if($===null)throw new Q(`The URL '${X}' is not in a valid format`,"URL_INVALID");let Z=$.groups,Y=Z.scheme,G=Z.authority!==void 0?C5(Z.authority):void 0,J=V2(Z.path),_=Z.query!==void 0?q5(Z.query):void 0,z=Z.fragment!==void 0?V2(Z.fragment):void 0;return{scheme:Y,authority:G,path:J,query:_,fragment:z}}var L5=(()=>{return new RegExp("^(?<scheme>[A-Za-z][A-Za-z.+-]*):(//(?<authority>[^/?#]*))?(?<path>[^?#]*)(\\?(?<query>[^#]*))?(#(?<fragment>.*))?$","su")})();function C5(X){let $=v5.exec(X);if($===null)throw new Q("The authority part of the URL is not in a valid format","URL_INVALID");let Z=$.groups,Y=V2(Z.host_br??Z.host),G=Z.port?parseInt(Z.port,10):void 0,J=Z.username!==void 0?{username:V2(Z.username),password:Z.password!==void 0?V2(Z.password):void 0}:void 0;return{host:Y,port:G,userinfo:J}}var v5=(()=>{return new RegExp("^((?<username>[^:]*)(:(?<password>.*))?@)?((?<host>[^:\\[\\]]*)|(\\[(?<host_br>[^\\[\\]]*)\\]))(:(?<port>[0-9]*))?$","su")})();function q5(X){let $=X.split("&"),Z=[];for(let Y of $){if(Y==="")continue;let G,J,_=Y.indexOf("=");if(_<0)G=Y,J="";else G=Y.substring(0,_),J=Y.substring(_+1);Z.push({key:V2(G.replaceAll("+"," ")),value:V2(J.replaceAll("+"," "))})}return{pairs:Z}}function V2(X){try{return decodeURIComponent(X)}catch($){if($ instanceof URIError)throw new Q(`URL component has invalid percent encoding: ${$}`,"URL_INVALID",void 0,$);throw $}}function M0(X,$,Z){if($===void 0)throw new Q(`URL with scheme ${JSON.stringify(X+":")} requires authority (the "//" part)`,"URL_INVALID");let Y=`${X}:`,G=h5($.host),J=S5($.port),z=`//${k5($.userinfo)}${G}${J}`,H=Z.split("/").map(encodeURIComponent).join("/");if(H!==""&&!H.startsWith("/"))H="/"+H;return new URL(`${Y}${z}${H}`)}function h5(X){return X.includes(":")?`[${encodeURI(X)}]`:encodeURI(X)}function S5(X){return X!==void 0?`:${X}`:""}function k5(X){if(X===void 0)return"";let $=encodeURIComponent(X.username),Z=X.password!==void 0?`:${encodeURIComponent(X.password)}`:"";return`${$}${Z}@`}var h2=typeof Buffer==="function",xX=typeof TextDecoder==="function"?new TextDecoder:void 0,PX=typeof TextEncoder==="function"?new TextEncoder:void 0;var E0=Array.prototype.slice.call("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="),z6=((X)=>{let $={};return X.forEach((Z,Y)=>$[Z]=Y),$})(E0),y5=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/,X1=String.fromCharCode.bind(String),QX=typeof Uint8Array.from==="function"?Uint8Array.from.bind(Uint8Array):(X)=>new Uint8Array(Array.prototype.slice.call(X,0)),TX=(X)=>X.replace(/=/g,"").replace(/[+\/]/g,($)=>$=="+"?"-":"_"),wX=(X)=>X.replace(/[^A-Za-z0-9\+\/]/g,""),LX=(X)=>{let $,Z,Y,G,J="",_=X.length%3;for(let z=0;z<X.length;){if((Z=X.charCodeAt(z++))>255||(Y=X.charCodeAt(z++))>255||(G=X.charCodeAt(z++))>255)throw TypeError("invalid character found");$=Z<<16|Y<<8|G,J+=E0[$>>18&63]+E0[$>>12&63]+E0[$>>6&63]+E0[$&63]}return _?J.slice(0,_-3)+"===".substring(_):J},x4=typeof btoa==="function"?(X)=>btoa(X):h2?(X)=>Buffer.from(X,"binary").toString("base64"):LX,M4=h2?(X)=>Buffer.from(X).toString("base64"):(X)=>{let Z=[];for(let Y=0,G=X.length;Y<G;Y+=4096)Z.push(X1.apply(null,X.subarray(Y,Y+4096)));return x4(Z.join(""))},H6=(X,$=!1)=>$?TX(M4(X)):M4(X),f5=(X)=>{if(X.length<2){var $=X.charCodeAt(0);return $<128?X:$<2048?X1(192|$>>>6)+X1(128|$&63):X1(224|$>>>12&15)+X1(128|$>>>6&63)+X1(128|$&63)}else{var $=65536+(X.charCodeAt(0)-55296)*1024+(X.charCodeAt(1)-56320);return X1(240|$>>>18&7)+X1(128|$>>>12&63)+X1(128|$>>>6&63)+X1(128|$&63)}},g5=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g,CX=(X)=>X.replace(g5,f5),jX=h2?(X)=>Buffer.from(X,"utf8").toString("base64"):PX?(X)=>M4(PX.encode(X)):(X)=>x4(CX(X)),q2=(X,$=!1)=>$?TX(jX(X)):jX(X),BX=(X)=>q2(X,!0),p5=/[\xC0-\xDF][\x80-\xBF]|[\xE0-\xEF][\x80-\xBF]{2}|[\xF0-\xF7][\x80-\xBF]{3}/g,b5=(X)=>{switch(X.length){case 4:var $=(7&X.charCodeAt(0))<<18|(63&X.charCodeAt(1))<<12|(63&X.charCodeAt(2))<<6|63&X.charCodeAt(3),Z=$-65536;return X1((Z>>>10)+55296)+X1((Z&1023)+56320);case 3:return X1((15&X.charCodeAt(0))<<12|(63&X.charCodeAt(1))<<6|63&X.charCodeAt(2));default:return X1((31&X.charCodeAt(0))<<6|63&X.charCodeAt(1))}},vX=(X)=>X.replace(p5,b5),qX=(X)=>{if(X=X.replace(/\s+/g,""),!y5.test(X))throw TypeError("malformed base64.");X+="==".slice(2-(X.length&3));let $,Z,Y,G=[];for(let J=0;J<X.length;)if($=z6[X.charAt(J++)]<<18|z6[X.charAt(J++)]<<12|(Z=z6[X.charAt(J++)])<<6|(Y=z6[X.charAt(J++)]),Z===64)G.push(X1($>>16&255));else if(Y===64)G.push(X1($>>16&255,$>>8&255));else G.push(X1($>>16&255,$>>8&255,$&255));return G.join("")},P4=typeof atob==="function"?(X)=>atob(wX(X)):h2?(X)=>Buffer.from(X,"base64").toString("binary"):qX,hX=h2?(X)=>QX(Buffer.from(X,"base64")):(X)=>QX(P4(X).split("").map(($)=>$.charCodeAt(0))),SX=(X)=>hX(kX(X)),d5=h2?(X)=>Buffer.from(X,"base64").toString("utf8"):xX?(X)=>xX.decode(hX(X)):(X)=>vX(P4(X)),kX=(X)=>wX(X.replace(/[-_]/g,($)=>$=="-"?"+":"/")),E4=(X)=>d5(kX(X)),m5=(X)=>{if(typeof X!=="string")return!1;let $=X.replace(/\s+/g,"").replace(/={0,2}$/,"");return!/[^\s0-9a-zA-Z\+/]/.test($)||!/[^\s0-9a-zA-Z\-_]/.test($)},yX=(X)=>{return{value:X,enumerable:!1,writable:!0,configurable:!0}},fX=function(){let X=($,Z)=>Object.defineProperty(String.prototype,$,yX(Z));X("fromBase64",function(){return E4(this)}),X("toBase64",function($){return q2(this,$)}),X("toBase64URI",function(){return q2(this,!0)}),X("toBase64URL",function(){return q2(this,!0)}),X("toUint8Array",function(){return SX(this)})},gX=function(){let X=($,Z)=>Object.defineProperty(Uint8Array.prototype,$,yX(Z));X("toBase64",function($){return H6(this,$)}),X("toBase64URI",function(){return H6(this,!0)}),X("toBase64URL",function(){return H6(this,!0)})},u5=()=>{fX(),gX()},S2={version:"3.7.8",VERSION:"3.7.8",atob:P4,atobPolyfill:qX,btoa:x4,btoaPolyfill:LX,fromBase64:E4,toBase64:q2,encode:q2,encodeURI:BX,encodeURL:BX,utob:CX,btou:vX,decode:E4,isValid:m5,fromUint8Array:H6,toUint8Array:SX,extendString:fX,extendUint8Array:gX,extendBuiltins:u5};var L1="https://github.com/libsql/libsql-client-ts#supported-urls";function a1(X){if(X==="write")return"BEGIN IMMEDIATE";else if(X==="read")return"BEGIN TRANSACTION READONLY";else if(X==="deferred")return"BEGIN DEFERRED";else throw RangeError('Unknown transaction mode, supported values are "write", "read" and "deferred"')}class k2{columns;columnTypes;rows;rowsAffected;lastInsertRowid;constructor(X,$,Z,Y,G){this.columns=X,this.columnTypes=$,this.rows=Z,this.rowsAffected=Y,this.lastInsertRowid=G}toJSON(){return{columns:this.columns,columnTypes:this.columnTypes,rows:this.rows.map(c5),rowsAffected:this.rowsAffected,lastInsertRowid:this.lastInsertRowid!==void 0?""+this.lastInsertRowid:null}}}function c5(X){return Array.prototype.map.call(X,i5)}function i5(X){if(typeof X==="bigint")return""+X;else if(X instanceof ArrayBuffer)return S2.fromUint8Array(new Uint8Array(X));else return X}var pX=":memory:";function bX(X){return X.scheme==="file"&&(X.path===":memory:"||X.path.startsWith(":memory:?"))}function x0(X,$){if(typeof X!=="object")throw TypeError(`Expected client configuration as object, got ${typeof X}`);let{url:Z,authToken:Y,tls:G,intMode:J,concurrency:_}=X;_=Math.max(0,_||20),J??="number";let z=[];if(Z===pX)Z="file::memory:";let H=EX(Z),W=H.scheme.toLowerCase(),K=W==="file"&&H.path===pX&&H.authority===void 0,U;if(K)U={cache:{values:["shared","private"],update:(I,E)=>z.push(`${I}=${E}`)}};else U={tls:{values:["0","1"],update:(I,E)=>G=E==="1"},authToken:{update:(I,E)=>Y=E}};for(let{key:I,value:E}of H.query?.pairs??[]){if(!Object.hasOwn(U,I))throw new Q(`Unsupported URL query parameter ${JSON.stringify(I)}`,"URL_PARAM_NOT_SUPPORTED");let S=U[I];if(S.values!==void 0&&!S.values.includes(E))throw new Q(`Unknown value for the "${I}" query argument: ${JSON.stringify(E)}. Supported values are: [${S.values.map((y)=>'"'+y+'"').join(", ")}]`,"URL_INVALID");if(S.update!==void 0)S?.update(I,E)}let F=z.length===0?"":`?${z.join("&")}`,M=H.path+F,R;if(W==="libsql")if(G===!1){if(H.authority?.port===void 0)throw new Q('A "libsql:" URL with ?tls=0 must specify an explicit port',"URL_INVALID");R=$?"http":"ws"}else R=$?"https":"wss";else R=W;if(R==="http"||R==="ws")G??=!1;else G??=!0;if(R!=="http"&&R!=="ws"&&R!=="https"&&R!=="wss"&&R!=="file")throw new Q(`The client supports only "libsql:", "wss:", "ws:", "https:", "http:" and "file:" URLs, got ${JSON.stringify(H.scheme+":")}. For more information, please read ${L1}`,"URL_SCHEME_NOT_SUPPORTED");if(J!=="number"&&J!=="bigint"&&J!=="string")throw TypeError(`Invalid value for intMode, expected "number", "bigint" or "string", got ${JSON.stringify(J)}`);if(H.fragment!==void 0)throw new Q(`URL fragments are not supported: ${JSON.stringify("#"+H.fragment)}`,"URL_INVALID");if(K)return{scheme:"file",tls:!1,path:M,intMode:J,concurrency:_,syncUrl:X.syncUrl,syncInterval:X.syncInterval,readYourWrites:X.readYourWrites,offline:X.offline,fetch:X.fetch,authToken:void 0,encryptionKey:void 0,authority:void 0};return{scheme:R,tls:G,authority:H.authority,path:M,authToken:Y,intMode:J,concurrency:_,encryptionKey:X.encryptionKey,syncUrl:X.syncUrl,syncInterval:X.syncInterval,readYourWrites:X.readYourWrites,offline:X.offline,fetch:X.fetch}}var P0=p1(P$(),1);import{Buffer as j$}from"node:buffer";function B$(X){if(X.scheme!=="file")throw new Q(`URL scheme ${JSON.stringify(X.scheme+":")} is not supported by the local sqlite3 client. For more information, please read ${L1}`,"URL_SCHEME_NOT_SUPPORTED");let $=X.authority;if($!==void 0){let _=$.host.toLowerCase();if(_!==""&&_!=="localhost")throw new Q(`Invalid host in file URL: ${JSON.stringify($.host)}. A "file:" URL with an absolute path should start with one slash ("file:/absolute/path.db") or with three slashes ("file:///absolute/path.db"). For more information, please read ${L1}`,"URL_INVALID");if($.port!==void 0)throw new Q("File URL cannot have a port","URL_INVALID");if($.userinfo!==void 0)throw new Q("File URL cannot have username and password","URL_INVALID")}let Z=bX(X);if(Z&&X.syncUrl)throw new Q(`Embedded replica must use file for local db but URI with in-memory mode were provided instead: ${X.path}`,"URL_INVALID");let Y=X.path;if(Z)Y=`${X.scheme}:${X.path}`;let G={authToken:X.authToken,encryptionKey:X.encryptionKey,syncUrl:X.syncUrl,syncPeriod:X.syncInterval,readYourWrites:X.readYourWrites,offline:X.offline},J=new P0.default(Y,G);return s(J,"SELECT 1 AS checkThatTheDatabaseCanBeOpened",X.intMode),new T$(Y,G,J,X.intMode)}class T${#X;#$;#Z;#Y;closed;protocol;constructor(X,$,Z,Y){this.#X=X,this.#$=$,this.#Z=Z,this.#Y=Y,this.closed=!1,this.protocol="file"}async execute(X,$){let Z;if(typeof X==="string")Z={sql:X,args:$||[]};else Z=X;return this.#G(),s(this.#J(),Z,this.#Y)}async batch(X,$="deferred"){this.#G();let Z=this.#J();try{s(Z,a1($),this.#Y);let Y=X.map((G)=>{if(!Z.inTransaction)throw new Q("The transaction has been rolled back","TRANSACTION_CLOSED");let J=Array.isArray(G)?{sql:G[0],args:G[1]||[]}:G;return s(Z,J,this.#Y)});return s(Z,"COMMIT",this.#Y),Y}finally{if(Z.inTransaction)s(Z,"ROLLBACK",this.#Y)}}async migrate(X){this.#G();let $=this.#J();try{s($,"PRAGMA foreign_keys=off",this.#Y),s($,a1("deferred"),this.#Y);let Z=X.map((Y)=>{if(!$.inTransaction)throw new Q("The transaction has been rolled back","TRANSACTION_CLOSED");return s($,Y,this.#Y)});return s($,"COMMIT",this.#Y),Z}finally{if($.inTransaction)s($,"ROLLBACK",this.#Y);s($,"PRAGMA foreign_keys=on",this.#Y)}}async transaction(X="write"){let $=this.#J();return s($,a1(X),this.#Y),this.#Z=null,new w$($,this.#Y)}async executeMultiple(X){this.#G();let $=this.#J();try{return L$($,X)}finally{if($.inTransaction)s($,"ROLLBACK",this.#Y)}}async sync(){this.#G();let X=await this.#J().sync();return{frames_synced:X.frames_synced,frame_no:X.frame_no}}async reconnect(){try{if(!this.closed&&this.#Z!==null)this.#Z.close()}finally{this.#Z=new P0.default(this.#X,this.#$),this.closed=!1}}close(){if(this.closed=!0,this.#Z!==null)this.#Z.close(),this.#Z=null}#G(){if(this.closed)throw new Q("The client is closed","CLIENT_CLOSED")}#J(){if(this.#Z===null)this.#Z=new P0.default(this.#X,this.#$);return this.#Z}}class w${#X;#$;constructor(X,$){this.#X=X,this.#$=$}async execute(X,$){let Z;if(typeof X==="string")Z={sql:X,args:$||[]};else Z=X;return this.#Z(),s(this.#X,Z,this.#$)}async batch(X){return X.map(($)=>{this.#Z();let Z=Array.isArray($)?{sql:$[0],args:$[1]||[]}:$;return s(this.#X,Z,this.#$)})}async executeMultiple(X){return this.#Z(),L$(this.#X,X)}async rollback(){if(!this.#X.open)return;this.#Z(),s(this.#X,"ROLLBACK",this.#$)}async commit(){this.#Z(),s(this.#X,"COMMIT",this.#$)}close(){if(this.#X.inTransaction)s(this.#X,"ROLLBACK",this.#$)}get closed(){return!this.#X.inTransaction}#Z(){if(this.closed)throw new Q("The transaction is closed","TRANSACTION_CLOSED")}}function s(X,$,Z){let Y,G;if(typeof $==="string")Y=$,G=[];else if(Y=$.sql,Array.isArray($.args))G=$.args.map((J)=>Q$(J,Z));else{G={};for(let J in $.args){let _=J[0]==="@"||J[0]==="$"||J[0]===":"?J.substring(1):J;G[_]=Q$($.args[J],Z)}}try{let J=X.prepare(Y);J.safeIntegers(!0);let _=!0;try{J.raw(!0)}catch{_=!1}if(_){let z=Array.from(J.columns().map((F)=>F.name)),H=Array.from(J.columns().map((F)=>F.type??"")),W=J.all(G).map((F)=>{return pY(F,z,Z)}),K=0,U=void 0;return new k2(z,H,W,0,void 0)}else{let z=J.run(G),H=z.changes,W=BigInt(z.lastInsertRowid);return new k2([],[],[],H,W)}}catch(J){throw C$(J)}}function pY(X,$,Z){let Y={};Object.defineProperty(Y,"length",{value:X.length});for(let G=0;G<X.length;++G){let J=bY(X[G],Z);Object.defineProperty(Y,G,{value:J});let _=$[G];if(!Object.hasOwn(Y,_))Object.defineProperty(Y,_,{value:J,enumerable:!0,configurable:!0,writable:!0})}return Y}function bY(X,$){if(typeof X==="bigint")if($==="number"){if(X<dY||X>mY)throw RangeError("Received integer which cannot be safely represented as a JavaScript number");return Number(X)}else if($==="bigint")return X;else if($==="string")return""+X;else throw Error("Invalid value for IntMode");else if(X instanceof j$)return X.buffer;return X}var dY=-9007199254740991n,mY=9007199254740991n;function Q$(X,$){if(typeof X==="number"){if(!Number.isFinite(X))throw RangeError("Only finite numbers (not Infinity or NaN) can be passed as arguments");return X}else if(typeof X==="bigint"){if(X<uY||X>cY)throw RangeError("bigint is too large to be represented as a 64-bit integer and passed as argument");return X}else if(typeof X==="boolean")switch($){case"bigint":return X?1n:0n;case"string":return X?"1":"0";default:return X?1:0}else if(X instanceof ArrayBuffer)return j$.from(X);else if(X instanceof Date)return X.valueOf();else if(X===void 0)throw TypeError("undefined cannot be passed as argument to the database");else return X}var uY=-9223372036854775808n,cY=9223372036854775807n;function L$(X,$){try{X.exec($)}catch(Z){throw C$(Z)}}function C$(X){if(X instanceof P0.default.SqliteError)return new Q(X.message,X.code,X.rawCode,X);return X}var HJ=p1(jZ(),1),WJ=p1(v4(),1),AJ=p1(h4(),1),i2=p1(E6(),1),OJ=p1(qZ(),1);class n2{constructor(){this.intMode="number"}intMode}class q extends Error{constructor(X){super(X);this.name="ClientError"}}class x extends q{constructor(X){super(X);this.name="ProtoError"}}class q0 extends q{code;proto;constructor(X,$){super(X);this.name="ResponseError",this.code=$.code,this.proto=$,this.stack=void 0}}class m extends q{constructor(X,$){if($!==void 0){super(`${X}: ${$}`);this.cause=$}else super(X);this.name="ClosedError"}}class h0 extends q{constructor(X){super(X);this.name="WebSocketUnsupportedError"}}class l2 extends q{constructor(X){super(X);this.name="WebSocketError"}}class x2 extends q{status;constructor(X,$){super(X);this.status=$,this.name="HttpServerError"}}class x1 extends q{constructor(X){super(X);this.name="ProtocolVersionError"}}class Y1 extends q{constructor(X){super(X);this.name="InternalError"}}class h1 extends q{constructor(X){super(X);this.name="MisuseError"}}function _1(X){if(typeof X==="string")return X;throw o2(X,"string")}function A1(X){if(X===null||X===void 0)return;else if(typeof X==="string")return X;throw o2(X,"string or null")}function u1(X){if(typeof X==="number")return X;throw o2(X,"number")}function G2(X){if(typeof X==="boolean")return X;throw o2(X,"boolean")}function S0(X){if(Array.isArray(X))return X;throw o2(X,"array")}function i(X){if(X!==null&&typeof X==="object"&&!Array.isArray(X))return X;throw o2(X,"object")}function P1(X,$){return S0(X).map((Z)=>$(i(Z)))}function o2(X,$){if(X===void 0)return new x(`Expected ${$}, but the property was missing`);let Z=typeof X;if(X===null)Z="null";else if(Array.isArray(X))Z="array";return new x(`Expected ${$}, received ${Z}`)}function P2(X,$){return $(i(X))}class hZ{#X;#$;constructor(X){this.#X=X,this.#$=!1}begin(){this.#X.push("{"),this.#$=!0}end(){this.#X.push("}"),this.#$=!1}#Z(X){if(this.#$)this.#X.push('"'),this.#$=!1;else this.#X.push(',"');this.#X.push(X),this.#X.push('":')}string(X,$){this.#Z(X),this.#X.push(JSON.stringify($))}stringRaw(X,$){this.#Z(X),this.#X.push('"'),this.#X.push($),this.#X.push('"')}number(X,$){this.#Z(X),this.#X.push(""+$)}boolean(X,$){this.#Z(X),this.#X.push($?"true":"false")}object(X,$,Z){this.#Z(X),this.begin(),Z(this,$),this.end()}arrayObjects(X,$,Z){this.#Z(X),this.#X.push("[");for(let Y=0;Y<$.length;++Y){if(Y!==0)this.#X.push(",");this.begin(),Z(this,$[Y]),this.end()}this.#X.push("]")}}function k0(X,$){let Z=[],Y=new hZ(Z);return Y.begin(),$(Y,X),Y.end(),Z.join("")}var Q2=0,y0=1,f0=2;var SZ=5;class kZ{#X;#$;#Z;constructor(X){this.#X=X,this.#$=new DataView(X.buffer,X.byteOffset,X.byteLength),this.#Z=0}varint(){let X=0;for(let $=0;;$+=7){let Z=this.#X[this.#Z++];if(X|=(Z&127)<<$,!(Z&128))break}return X}varintBig(){let X=0n;for(let $=0n;;$+=7n){let Z=this.#X[this.#Z++];if(X|=BigInt(Z&127)<<$,!(Z&128))break}return X}bytes(X){let $=new Uint8Array(this.#X.buffer,this.#X.byteOffset+this.#Z,X);return this.#Z+=X,$}double(){let X=this.#$.getFloat64(this.#Z,!0);return this.#Z+=8,X}skipVarint(){for(;;)if(!(this.#X[this.#Z++]&128))break}skip(X){this.#Z+=X}eof(){return this.#Z>=this.#X.byteLength}}class yZ{#X;#$;constructor(X){this.#X=X,this.#$=-1}setup(X){this.#$=X}#Z(X){if(this.#$!==X)throw new x(`Expected wire type ${X}, got ${this.#$}`);this.#$=-1}bytes(){this.#Z(f0);let X=this.#X.varint();return this.#X.bytes(X)}string(){return new TextDecoder().decode(this.bytes())}message(X){return J2(this.bytes(),X)}int32(){return this.#Z(Q2),this.#X.varint()}uint32(){return this.int32()}bool(){return this.int32()!==0}uint64(){return this.#Z(Q2),this.#X.varintBig()}sint64(){let X=this.uint64();return X>>1n^-(X&1n)}double(){return this.#Z(y0),this.#X.double()}maybeSkip(){if(this.#$<0)return;else if(this.#$===Q2)this.#X.skipVarint();else if(this.#$===y0)this.#X.skip(8);else if(this.#$===f0){let X=this.#X.varint();this.#X.skip(X)}else if(this.#$===SZ)this.#X.skip(4);else throw new x(`Unexpected wire type ${this.#$}`);this.#$=-1}}function J2(X,$){let Z=new kZ(X),Y=new yZ(Z),G=$.default();while(!Z.eof()){let J=Z.varint(),_=J>>3,z=J&7;Y.setup(z);let H=$[_];if(H!==void 0){let W=H(Y,G);if(W!==void 0)G=W}Y.maybeSkip()}return G}class b4{#X;#$;#Z;#Y;constructor(){this.#X=new ArrayBuffer(256),this.#$=new Uint8Array(this.#X),this.#Z=new DataView(this.#X),this.#Y=0}#G(X){if(this.#Y+X<=this.#X.byteLength)return;let $=this.#X.byteLength;while($<this.#Y+X)$*=2;let Z=new ArrayBuffer($),Y=new Uint8Array(Z),G=new DataView(Z);Y.set(new Uint8Array(this.#X,0,this.#Y)),this.#X=Z,this.#$=Y,this.#Z=G}#J(X){this.#G(5),X=0|X;do{let $=X&127;X>>>=7,$|=X?128:0,this.#$[this.#Y++]=$}while(X)}#z(X){this.#G(10),X=X&0xffffffffffffffffn;do{let $=Number(X&0x7fn);X>>=7n,$|=X?128:0,this.#$[this.#Y++]=$}while(X)}#_(X,$){this.#J(X<<3|$)}bytes(X,$){this.#_(X,f0),this.#J($.byteLength),this.#G($.byteLength),this.#$.set($,this.#Y),this.#Y+=$.byteLength}string(X,$){this.bytes(X,new TextEncoder().encode($))}message(X,$,Z){let Y=new b4;Z(Y,$),this.bytes(X,Y.data())}int32(X,$){this.#_(X,Q2),this.#J($)}uint32(X,$){this.int32(X,$)}bool(X,$){this.int32(X,$?1:0)}sint64(X,$){this.#_(X,Q2),this.#z($<<1n^$>>63n)}double(X,$){this.#_(X,y0),this.#G(8),this.#Z.setFloat64(this.#Y,$,!0),this.#Y+=8}data(){return new Uint8Array(this.#X,0,this.#Y)}}function g0(X,$){let Z=new b4;return $(Z,X),Z.data()}class _2{#X;#$;constructor(){this.#X=new Set,this.#$=new Set}alloc(){for(let $ of this.#$){if(this.#$.delete($),this.#X.add($),!this.#X.has(this.#X.size-1))this.#$.add(this.#X.size-1);return $}let X=this.#X.size;return this.#X.add(X),X}free(X){if(!this.#X.delete(X))throw new Y1("Freeing an id that is not allocated");if(this.#$.delete(this.#X.size),X<this.#X.size)this.#$.add(X)}}function L(X,$){throw new Y1($)}function s2(X){if(X===null)return null;else if(typeof X==="string")return X;else if(typeof X==="number"){if(!Number.isFinite(X))throw RangeError("Only finite numbers (not Infinity or NaN) can be passed as arguments");return X}else if(typeof X==="bigint"){if(X<DJ||X>UJ)throw RangeError("This bigint value is too large to be represented as a 64-bit integer and passed as argument");return X}else if(typeof X==="boolean")return X?1n:0n;else if(X instanceof ArrayBuffer)return new Uint8Array(X);else if(X instanceof Uint8Array)return X;else if(X instanceof Date)return+X.valueOf();else if(typeof X==="object")return""+X.toString();else throw TypeError("Unsupported type of value")}var DJ=-9223372036854775808n,UJ=9223372036854775807n;function d4(X,$){if(X===null)return null;else if(typeof X==="number")return X;else if(typeof X==="string")return X;else if(typeof X==="bigint")if($==="number"){let Z=Number(X);if(!Number.isSafeInteger(Z))throw RangeError("Received integer which is too large to be safely represented as a JavaScript number");return Z}else if($==="bigint")return X;else if($==="string")return""+X;else throw new h1("Invalid value for IntMode");else if(X instanceof Uint8Array)return X.slice().buffer;else if(X===void 0)throw new x("Received unrecognized type of Value");else throw L(X,"Impossible type of Value")}function j2(X){return{affectedRowCount:X.affectedRowCount,lastInsertRowid:X.lastInsertRowid,columnNames:X.cols.map(($)=>$.name),columnDecltypes:X.cols.map(($)=>$.decltype)}}function Q6(X,$){let Z=j2(X),Y=X.rows.map((G)=>fZ(Z.columnNames,G,$));return{...Z,rows:Y}}function j6(X,$){let Z=j2(X),Y;if(X.rows.length>0)Y=fZ(Z.columnNames,X.rows[0],$);return{...Z,row:Y}}function B6(X,$){let Z=j2(X),Y;if(X.rows.length>0&&Z.columnNames.length>0)Y=d4(X.rows[0][0],$);return{...Z,value:Y}}function fZ(X,$,Z){let Y={};Object.defineProperty(Y,"length",{value:$.length});for(let G=0;G<$.length;++G){let J=d4($[G],Z);Object.defineProperty(Y,G,{value:J});let _=X[G];if(_!==void 0&&!Object.hasOwn(Y,_))Object.defineProperty(Y,_,{value:J,enumerable:!0,configurable:!0,writable:!0})}return Y}function c1(X){return new q0(X.message,X)}class B2{#X;#$;#Z;constructor(X,$){this.#X=X,this.#$=$,this.#Z=void 0}_getSqlId(X){if(this.#X!==X)throw new h1("Attempted to use SQL text opened with other object");else if(this.#Z!==void 0)throw new m("SQL text is closed",this.#Z);return this.#$}close(){this._setClosed(new q("SQL text was manually closed"))}_setClosed(X){if(this.#Z===void 0)this.#Z=X,this.#X._closeSql(this.#$)}get closed(){return this.#Z!==void 0}}function p0(X,$){if($ instanceof B2)return{sqlId:$._getSqlId(X)};else return{sql:""+$}}class z2{#X;#$;constructor(){this.#X=[],this.#$=[]}get length(){return this.#X.length+this.#$.length}push(X){this.#X.push(X)}shift(){if(this.#$.length===0&&this.#X.length>0)this.#$=this.#X.reverse(),this.#X=[];return this.#$.pop()}first(){return this.#$.length!==0?this.#$[this.#$.length-1]:this.#X[0]}}class b0{sql;_args;_namedArgs;constructor(X){this.sql=X,this._args=[],this._namedArgs=new Map}bindIndexes(X){this._args.length=0;for(let $ of X)this._args.push(s2($));return this}bindIndex(X,$){if(X!==(X|0)||X<=0)throw RangeError("Index of a positional argument must be positive integer");while(this._args.length<X)this._args.push(null);return this._args[X-1]=s2($),this}bindName(X,$){return this._namedArgs.set(X,s2($)),this}unbindAll(){return this._args.length=0,this._namedArgs.clear(),this}}function T6(X,$,Z){let Y,G=[],J=[];if($ instanceof b0){Y=$.sql,G=$._args;for(let[H,W]of $._namedArgs.entries())J.push({name:H,value:W})}else if(Array.isArray($))if(Y=$[0],Array.isArray($[1]))G=$[1].map((H)=>s2(H));else J=Object.entries($[1]).map(([H,W])=>{return{name:H,value:s2(W)}});else Y=$;let{sql:_,sqlId:z}=p0(X,Y);return{sql:_,sqlId:z,args:G,namedArgs:J,wantRows:Z}}class w6{_stream;#X;_steps;#$;constructor(X,$){this._stream=X,this.#X=$,this._steps=[],this.#$=!1}step(){return new m4(this)}execute(){if(this.#$)throw new h1("This batch has already been executed");this.#$=!0;let X={steps:this._steps.map(($)=>$.proto)};if(this.#X)return RJ(this._stream,this._steps,X);else return VJ(this._stream,this._steps,X)}}function VJ(X,$,Z){return X._batch(Z).then((Y)=>{for(let G=0;G<$.length;++G){let J=Y.stepResults.get(G),_=Y.stepErrors.get(G);$[G].callback(J,_)}})}async function RJ(X,$,Z){let Y=await X._openCursor(Z);try{let G=0,J=void 0,_=[];for(;;){let z=await Y.next();if(z===void 0)break;if(z.type==="step_begin"){if(z.step<G||z.step>=$.length)throw new x("Server produced StepBeginEntry for unexpected step");else if(J!==void 0)throw new x("Server produced StepBeginEntry before terminating previous step");for(let H=G;H<z.step;++H)$[H].callback(void 0,void 0);G=z.step+1,J=z,_=[]}else if(z.type==="step_end"){if(J===void 0)throw new x("Server produced StepEndEntry but no step is active");let H={cols:J.cols,rows:_,affectedRowCount:z.affectedRowCount,lastInsertRowid:z.lastInsertRowid};$[J.step].callback(H,void 0),J=void 0,_=[]}else if(z.type==="step_error"){if(J===void 0){if(z.step>=$.length)throw new x("Server produced StepErrorEntry for unexpected step");for(let H=G;H<z.step;++H)$[H].callback(void 0,void 0)}else{if(z.step!==J.step)throw new x("Server produced StepErrorEntry for unexpected step");J=void 0,_=[]}$[z.step].callback(void 0,z.error),G=z.step+1}else if(z.type==="row"){if(J===void 0)throw new x("Server produced RowEntry but no step is active");_.push(z.row)}else if(z.type==="error")throw c1(z.error);else if(z.type==="none")throw new x("Server produced unrecognized CursorEntry");else throw L(z,"Impossible CursorEntry")}if(J!==void 0)throw new x("Server closed Cursor before terminating active step");for(let z=G;z<$.length;++z)$[z].callback(void 0,void 0)}finally{Y.close()}}class m4{_batch;#X;_index;constructor(X){this._batch=X,this.#X=[],this._index=void 0}condition(X){return this.#X.push(X._proto),this}query(X){return this.#$(X,!0,Q6)}queryRow(X){return this.#$(X,!0,j6)}queryValue(X){return this.#$(X,!0,B6)}run(X){return this.#$(X,!1,j2)}#$(X,$,Z){if(this._index!==void 0)throw new h1("This BatchStep has already been added to the batch");let Y=T6(this._batch._stream._sqlOwner(),X,$),G;if(this.#X.length===0)G=void 0;else if(this.#X.length===1)G=this.#X[0];else G={type:"and",conds:this.#X.slice()};let J={stmt:Y,condition:G};return new Promise((_,z)=>{let H=(W,K)=>{if(W!==void 0&&K!==void 0)z(new x("Server returned both result and error"));else if(K!==void 0)z(c1(K));else if(W!==void 0)_(Z(W,this._batch._stream.intMode));else _(void 0)};this._index=this._batch._steps.length,this._batch._steps.push({proto:J,callback:H})})}}class g{_batch;_proto;constructor(X,$){this._batch=X,this._proto=$}static ok(X){return new g(X._batch,{type:"ok",step:gZ(X)})}static error(X){return new g(X._batch,{type:"error",step:gZ(X)})}static not(X){return new g(X._batch,{type:"not",cond:X._proto})}static and(X,$){for(let Z of $)pZ(X,Z);return new g(X,{type:"and",conds:$.map((Z)=>Z._proto)})}static or(X,$){for(let Z of $)pZ(X,Z);return new g(X,{type:"or",conds:$.map((Z)=>Z._proto)})}static isAutocommit(X){return X._stream.client()._ensureVersion(3,"BatchCond.isAutocommit()"),new g(X,{type:"is_autocommit"})}}function gZ(X){if(X._index===void 0)throw new h1("Cannot add a condition referencing a step that has not been added to the batch");return X._index}function pZ(X,$){if($._batch!==X)throw new h1("Cannot mix BatchCond objects for different Batch objects")}function bZ(X){return{paramNames:X.params.map(($)=>$.name),columns:X.cols,isExplain:X.isExplain,isReadonly:X.isReadonly}}class r2{constructor(X){this.intMode=X}query(X){return this.#X(X,!0,Q6)}queryRow(X){return this.#X(X,!0,j6)}queryValue(X){return this.#X(X,!0,B6)}run(X){return this.#X(X,!1,j2)}#X(X,$,Z){let Y=T6(this._sqlOwner(),X,$);return this._execute(Y).then((G)=>Z(G,this.intMode))}batch(X=!1){return new w6(this,X)}describe(X){let $=p0(this._sqlOwner(),X);return this._describe($).then(bZ)}sequence(X){let $=p0(this._sqlOwner(),X);return this._sequence($)}intMode}class d0{}var IJ=1000,FJ=10;class u4 extends d0{#X;#$;#Z;#Y;#G;#J;#z;constructor(X,$,Z){super();this.#X=X,this.#$=$,this.#Z=Z,this.#Y=new z2,this.#G=new z2,this.#J=void 0,this.#z=!1}async next(){for(;;){if(this.#J!==void 0)throw new m("Cursor is closed",this.#J);while(!this.#z&&this.#G.length<FJ)this.#G.push(this.#_());let X=this.#Y.shift();if(this.#z||X!==void 0)return X;await this.#G.shift().then(($)=>{if($===void 0)return;for(let Z of $.entries)this.#Y.push(Z);this.#z||=$.done})}}#_(){return this.#$._sendCursorRequest(this,{type:"fetch_cursor",cursorId:this.#Z,maxCount:IJ}).then((X)=>X,(X)=>{this._setClosed(X);return})}_setClosed(X){if(this.#J!==void 0)return;this.#J=X,this.#$._sendCursorRequest(this,{type:"close_cursor",cursorId:this.#Z}).catch(()=>{return}),this.#$._cursorClosed(this)}close(){this._setClosed(new q("Cursor was manually closed"))}get closed(){return this.#J!==void 0}}class m0 extends r2{#X;#$;#Z;#Y;#G;#J;static open(X){let $=X._streamIdAlloc.alloc(),Z=new m0(X,$),Y=()=>{return},G=(_)=>Z.#W(_),J={type:"open_stream",streamId:$};return X._sendRequest(J,{responseCallback:Y,errorCallback:G}),Z}constructor(X,$){super(X.intMode);this.#X=X,this.#$=$,this.#Z=new z2,this.#Y=void 0,this.#G=!1,this.#J=void 0}client(){return this.#X}_sqlOwner(){return this.#X}_execute(X){return this.#z({type:"execute",streamId:this.#$,stmt:X}).then(($)=>{return $.result})}_batch(X){return this.#z({type:"batch",streamId:this.#$,batch:X}).then(($)=>{return $.result})}_describe(X){return this.#X._ensureVersion(2,"describe()"),this.#z({type:"describe",streamId:this.#$,sql:X.sql,sqlId:X.sqlId}).then(($)=>{return $.result})}_sequence(X){return this.#X._ensureVersion(2,"sequence()"),this.#z({type:"sequence",streamId:this.#$,sql:X.sql,sqlId:X.sqlId}).then(($)=>{return})}getAutocommit(){return this.#X._ensureVersion(3,"getAutocommit()"),this.#z({type:"get_autocommit",streamId:this.#$}).then((X)=>{return X.isAutocommit})}#z(X){return new Promise(($,Z)=>{this.#_({type:"request",request:X,responseCallback:$,errorCallback:Z})})}_openCursor(X){return this.#X._ensureVersion(3,"cursor"),new Promise(($,Z)=>{this.#_({type:"cursor",batch:X,cursorCallback:$,errorCallback:Z})})}_sendCursorRequest(X,$){if(X!==this.#Y)throw new Y1("Cursor not associated with the stream attempted to execute a request");return new Promise((Z,Y)=>{if(this.#J!==void 0)Y(new m("Stream is closed",this.#J));else this.#X._sendRequest($,{responseCallback:Z,errorCallback:Y})})}_cursorClosed(X){if(X!==this.#Y)throw new Y1("Cursor was closed, but it was not associated with the stream");this.#Y=void 0,this.#H()}#_(X){if(this.#J!==void 0)X.errorCallback(new m("Stream is closed",this.#J));else if(this.#G)X.errorCallback(new m("Stream is closing",void 0));else this.#Z.push(X),this.#H()}#H(){for(;;){let X=this.#Z.first();if(X===void 0&&this.#Y===void 0&&this.#G){this.#W(new q("Stream was gracefully closed"));break}else if(X?.type==="request"&&this.#Y===void 0){let{request:$,responseCallback:Z,errorCallback:Y}=X;this.#Z.shift(),this.#X._sendRequest($,{responseCallback:Z,errorCallback:Y})}else if(X?.type==="cursor"&&this.#Y===void 0){let{batch:$,cursorCallback:Z}=X;this.#Z.shift();let Y=this.#X._cursorIdAlloc.alloc(),G=new u4(this.#X,this,Y),J={type:"open_cursor",streamId:this.#$,cursorId:Y,batch:$},_=()=>{return},z=(H)=>G._setClosed(H);this.#X._sendRequest(J,{responseCallback:_,errorCallback:z}),this.#Y=G,Z(G)}else break}}#W(X){if(this.#J!==void 0)return;if(this.#J=X,this.#Y!==void 0)this.#Y._setClosed(X);for(;;){let G=this.#Z.shift();if(G!==void 0)G.errorCallback(X);else break}let $={type:"close_stream",streamId:this.#$},Z=()=>this.#X._streamIdAlloc.free(this.#$),Y=()=>{return};this.#X._sendRequest($,{responseCallback:Z,errorCallback:Y})}close(){this.#W(new q("Stream was manually closed"))}closeGracefully(){this.#G=!0,this.#H()}get closed(){return this.#J!==void 0||this.#G}}function u0(X,$){if($.sql!==void 0)X.string("sql",$.sql);if($.sqlId!==void 0)X.number("sql_id",$.sqlId);X.arrayObjects("args",$.args,dZ),X.arrayObjects("named_args",$.namedArgs,NJ),X.boolean("want_rows",$.wantRows)}function NJ(X,$){X.string("name",$.name),X.object("value",$.value,dZ)}function t2(X,$){X.arrayObjects("steps",$.steps,MJ)}function MJ(X,$){if($.condition!==void 0)X.object("condition",$.condition,c4);X.object("stmt",$.stmt,u0)}function c4(X,$){if(X.stringRaw("type",$.type),$.type==="ok"||$.type==="error")X.number("step",$.step);else if($.type==="not")X.object("cond",$.cond,c4);else if($.type==="and"||$.type==="or")X.arrayObjects("conds",$.conds,c4);else if($.type==="is_autocommit");else throw L($,"Impossible type of BatchCond")}function dZ(X,$){if($===null)X.stringRaw("type","null");else if(typeof $==="bigint")X.stringRaw("type","integer"),X.stringRaw("value",""+$);else if(typeof $==="number")X.stringRaw("type","float"),X.number("value",$);else if(typeof $==="string")X.stringRaw("type","text"),X.string("value",$);else if($ instanceof Uint8Array)X.stringRaw("type","blob"),X.stringRaw("base64",S2.fromUint8Array($));else if($===void 0);else throw L($,"Impossible type of Value")}function mZ(X,$){if(X.stringRaw("type",$.type),$.type==="hello"){if($.jwt!==void 0)X.string("jwt",$.jwt)}else if($.type==="request")X.number("request_id",$.requestId),X.object("request",$.request,EJ);else throw L($,"Impossible type of ClientMsg")}function EJ(X,$){if(X.stringRaw("type",$.type),$.type==="open_stream")X.number("stream_id",$.streamId);else if($.type==="close_stream")X.number("stream_id",$.streamId);else if($.type==="execute")X.number("stream_id",$.streamId),X.object("stmt",$.stmt,u0);else if($.type==="batch")X.number("stream_id",$.streamId),X.object("batch",$.batch,t2);else if($.type==="open_cursor")X.number("stream_id",$.streamId),X.number("cursor_id",$.cursorId),X.object("batch",$.batch,t2);else if($.type==="close_cursor")X.number("cursor_id",$.cursorId);else if($.type==="fetch_cursor")X.number("cursor_id",$.cursorId),X.number("max_count",$.maxCount);else if($.type==="sequence"){if(X.number("stream_id",$.streamId),$.sql!==void 0)X.string("sql",$.sql);if($.sqlId!==void 0)X.number("sql_id",$.sqlId)}else if($.type==="describe"){if(X.number("stream_id",$.streamId),$.sql!==void 0)X.string("sql",$.sql);if($.sqlId!==void 0)X.number("sql_id",$.sqlId)}else if($.type==="store_sql")X.number("sql_id",$.sqlId),X.string("sql",$.sql);else if($.type==="close_sql")X.number("sql_id",$.sqlId);else if($.type==="get_autocommit")X.number("stream_id",$.streamId);else throw L($,"Impossible type of Request")}function c0(X,$){if($.sql!==void 0)X.string(1,$.sql);if($.sqlId!==void 0)X.int32(2,$.sqlId);for(let Z of $.args)X.message(3,Z,cZ);for(let Z of $.namedArgs)X.message(4,Z,xJ);X.bool(5,$.wantRows)}function xJ(X,$){X.string(1,$.name),X.message(2,$.value,cZ)}function a2(X,$){for(let Z of $.steps)X.message(1,Z,PJ)}function PJ(X,$){if($.condition!==void 0)X.message(1,$.condition,i4);X.message(2,$.stmt,c0)}function i4(X,$){if($.type==="ok")X.uint32(1,$.step);else if($.type==="error")X.uint32(2,$.step);else if($.type==="not")X.message(3,$.cond,i4);else if($.type==="and")X.message(4,$.conds,uZ);else if($.type==="or")X.message(5,$.conds,uZ);else if($.type==="is_autocommit")X.message(6,void 0,iZ);else throw L($,"Impossible type of BatchCond")}function uZ(X,$){for(let Z of $)X.message(1,Z,i4)}function cZ(X,$){if($===null)X.message(1,void 0,iZ);else if(typeof $==="bigint")X.sint64(2,$);else if(typeof $==="number")X.double(3,$);else if(typeof $==="string")X.string(4,$);else if($ instanceof Uint8Array)X.bytes(5,$);else if($===void 0);else throw L($,"Impossible type of Value")}function iZ(X,$){}function nZ(X,$){if($.type==="hello")X.message(1,$,QJ);else if($.type==="request")X.message(2,$,jJ);else throw L($,"Impossible type of ClientMsg")}function QJ(X,$){if($.jwt!==void 0)X.string(1,$.jwt)}function jJ(X,$){X.int32(1,$.requestId);let Z=$.request;if(Z.type==="open_stream")X.message(2,Z,BJ);else if(Z.type==="close_stream")X.message(3,Z,TJ);else if(Z.type==="execute")X.message(4,Z,wJ);else if(Z.type==="batch")X.message(5,Z,LJ);else if(Z.type==="open_cursor")X.message(6,Z,CJ);else if(Z.type==="close_cursor")X.message(7,Z,vJ);else if(Z.type==="fetch_cursor")X.message(8,Z,qJ);else if(Z.type==="sequence")X.message(9,Z,hJ);else if(Z.type==="describe")X.message(10,Z,SJ);else if(Z.type==="store_sql")X.message(11,Z,kJ);else if(Z.type==="close_sql")X.message(12,Z,yJ);else if(Z.type==="get_autocommit")X.message(13,Z,fJ);else throw L(Z,"Impossible type of Request")}function BJ(X,$){X.int32(1,$.streamId)}function TJ(X,$){X.int32(1,$.streamId)}function wJ(X,$){X.int32(1,$.streamId),X.message(2,$.stmt,c0)}function LJ(X,$){X.int32(1,$.streamId),X.message(2,$.batch,a2)}function CJ(X,$){X.int32(1,$.streamId),X.int32(2,$.cursorId),X.message(3,$.batch,a2)}function vJ(X,$){X.int32(1,$.cursorId)}function qJ(X,$){X.int32(1,$.cursorId),X.uint32(2,$.maxCount)}function hJ(X,$){if(X.int32(1,$.streamId),$.sql!==void 0)X.string(2,$.sql);if($.sqlId!==void 0)X.int32(3,$.sqlId)}function SJ(X,$){if(X.int32(1,$.streamId),$.sql!==void 0)X.string(2,$.sql);if($.sqlId!==void 0)X.int32(3,$.sqlId)}function kJ(X,$){X.int32(1,$.sqlId),X.string(2,$.sql)}function yJ(X,$){X.int32(1,$.sqlId)}function fJ(X,$){X.int32(1,$.streamId)}function H2(X){let $=_1(X.message),Z=A1(X.code);return{message:$,code:Z}}function i0(X){let $=P1(X.cols,lZ),Z=S0(X.rows).map((_)=>P1(_,oZ)),Y=u1(X.affected_row_count),G=A1(X.last_insert_rowid),J=G!==void 0?BigInt(G):void 0;return{cols:$,rows:Z,affectedRowCount:Y,lastInsertRowid:J}}function lZ(X){let $=A1(X.name),Z=A1(X.decltype);return{name:$,decltype:Z}}function L6(X){let $=new Map;S0(X.step_results).forEach((Y,G)=>{if(Y!==null)$.set(G,i0(i(Y)))});let Z=new Map;return S0(X.step_errors).forEach((Y,G)=>{if(Y!==null)Z.set(G,H2(i(Y)))}),{stepResults:$,stepErrors:Z}}function C6(X){let $=_1(X.type);if($==="step_begin"){let Z=u1(X.step),Y=P1(X.cols,lZ);return{type:"step_begin",step:Z,cols:Y}}else if($==="step_end"){let Z=u1(X.affected_row_count),Y=A1(X.last_insert_rowid),G=Y!==void 0?BigInt(Y):void 0;return{type:"step_end",affectedRowCount:Z,lastInsertRowid:G}}else if($==="step_error"){let Z=u1(X.step),Y=H2(i(X.error));return{type:"step_error",step:Z,error:Y}}else if($==="row")return{type:"row",row:P1(X.row,oZ)};else if($==="error")return{type:"error",error:H2(i(X.error))};else throw new x("Unexpected type of CursorEntry")}function v6(X){let $=P1(X.params,gJ),Z=P1(X.cols,pJ),Y=G2(X.is_explain),G=G2(X.is_readonly);return{params:$,cols:Z,isExplain:Y,isReadonly:G}}function gJ(X){return{name:A1(X.name)}}function pJ(X){let $=_1(X.name),Z=A1(X.decltype);return{name:$,decltype:Z}}function oZ(X){let $=_1(X.type);if($==="null")return null;else if($==="integer"){let Z=_1(X.value);return BigInt(Z)}else if($==="float")return u1(X.value);else if($==="text")return _1(X.value);else if($==="blob")return S2.toUint8Array(_1(X.base64));else throw new x("Unexpected type of Value")}function sZ(X){let $=_1(X.type);if($==="hello_ok")return{type:"hello_ok"};else if($==="hello_error")return{type:"hello_error",error:H2(i(X.error))};else if($==="response_ok"){let Z=u1(X.request_id),Y=bJ(i(X.response));return{type:"response_ok",requestId:Z,response:Y}}else if($==="response_error"){let Z=u1(X.request_id),Y=H2(i(X.error));return{type:"response_error",requestId:Z,error:Y}}else throw new x("Unexpected type of ServerMsg")}function bJ(X){let $=_1(X.type);if($==="open_stream")return{type:"open_stream"};else if($==="close_stream")return{type:"close_stream"};else if($==="execute")return{type:"execute",result:i0(i(X.result))};else if($==="batch")return{type:"batch",result:L6(i(X.result))};else if($==="open_cursor")return{type:"open_cursor"};else if($==="close_cursor")return{type:"close_cursor"};else if($==="fetch_cursor"){let Z=P1(X.entries,C6),Y=G2(X.done);return{type:"fetch_cursor",entries:Z,done:Y}}else if($==="sequence")return{type:"sequence"};else if($==="describe")return{type:"describe",result:v6(i(X.result))};else if($==="store_sql")return{type:"store_sql"};else if($==="close_sql")return{type:"close_sql"};else if($==="get_autocommit")return{type:"get_autocommit",isAutocommit:G2(X.is_autocommit)};else throw new x("Unexpected type of Response")}var F1={default(){return{message:"",code:void 0}},1(X,$){$.message=X.string()},2(X,$){$.code=X.string()}},W2={default(){return{cols:[],rows:[],affectedRowCount:0,lastInsertRowid:void 0}},1(X,$){$.cols.push(X.message(rZ))},2(X,$){$.rows.push(X.message(tZ))},3(X,$){$.affectedRowCount=Number(X.uint64())},4(X,$){$.lastInsertRowid=X.sint64()}},rZ={default(){return{name:void 0,decltype:void 0}},1(X,$){$.name=X.string()},2(X,$){$.decltype=X.string()}},tZ={default(){return[]},1(X,$){$.push(X.message(oJ))}},e2={default(){return{stepResults:new Map,stepErrors:new Map}},1(X,$){let[Z,Y]=X.message(dJ);$.stepResults.set(Z,Y)},2(X,$){let[Z,Y]=X.message(mJ);$.stepErrors.set(Z,Y)}},dJ={default(){return[0,W2.default()]},1(X,$){$[0]=X.uint32()},2(X,$){$[1]=X.message(W2)}},mJ={default(){return[0,F1.default()]},1(X,$){$[0]=X.uint32()},2(X,$){$[1]=X.message(F1)}},q6={default(){return{type:"none"}},1(X){return X.message(uJ)},2(X){return X.message(cJ)},3(X){return X.message(iJ)},4(X){return{type:"row",row:X.message(tZ)}},5(X){return{type:"error",error:X.message(F1)}}},uJ={default(){return{type:"step_begin",step:0,cols:[]}},1(X,$){$.step=X.uint32()},2(X,$){$.cols.push(X.message(rZ))}},cJ={default(){return{type:"step_end",affectedRowCount:0,lastInsertRowid:void 0}},1(X,$){$.affectedRowCount=X.uint32()},2(X,$){$.lastInsertRowid=X.uint64()}},iJ={default(){return{type:"step_error",step:0,error:F1.default()}},1(X,$){$.step=X.uint32()},2(X,$){$.error=X.message(F1)}},X0={default(){return{params:[],cols:[],isExplain:!1,isReadonly:!1}},1(X,$){$.params.push(X.message(nJ))},2(X,$){$.cols.push(X.message(lJ))},3(X,$){$.isExplain=X.bool()},4(X,$){$.isReadonly=X.bool()}},nJ={default(){return{name:void 0}},1(X,$){$.name=X.string()}},lJ={default(){return{name:"",decltype:void 0}},1(X,$){$.name=X.string()},2(X,$){$.decltype=X.string()}},oJ={default(){return},1(X){return null},2(X){return X.sint64()},3(X){return X.double()},4(X){return X.string()},5(X){return X.bytes()}};var aZ={default(){return{type:"none"}},1(X){return{type:"hello_ok"}},2(X){return X.message(sJ)},3(X){return X.message(tJ)},4(X){return X.message(rJ)}},sJ={default(){return{type:"hello_error",error:F1.default()}},1(X,$){$.error=X.message(F1)}},rJ={default(){return{type:"response_error",requestId:0,error:F1.default()}},1(X,$){$.requestId=X.int32()},2(X,$){$.error=X.message(F1)}},tJ={default(){return{type:"response_ok",requestId:0,response:{type:"none"}}},1(X,$){$.requestId=X.int32()},2(X,$){$.response={type:"open_stream"}},3(X,$){$.response={type:"close_stream"}},4(X,$){$.response=X.message(aJ)},5(X,$){$.response=X.message(eJ)},6(X,$){$.response={type:"open_cursor"}},7(X,$){$.response={type:"close_cursor"}},8(X,$){$.response=X.message(X9)},9(X,$){$.response={type:"sequence"}},10(X,$){$.response=X.message($9)},11(X,$){$.response={type:"store_sql"}},12(X,$){$.response={type:"close_sql"}},13(X,$){$.response=X.message(Z9)}},aJ={default(){return{type:"execute",result:W2.default()}},1(X,$){$.result=X.message(W2)}},eJ={default(){return{type:"batch",result:e2.default()}},1(X,$){$.result=X.message(e2)}},X9={default(){return{type:"fetch_cursor",entries:[],done:!1}},1(X,$){$.entries.push(X.message(q6))},2(X,$){$.done=X.bool()}},$9={default(){return{type:"describe",result:X0.default()}},1(X,$){$.result=X.message(X0)}},Z9={default(){return{type:"get_autocommit",isAutocommit:!1}},1(X,$){$.isAutocommit=X.bool()}};var eZ=new Map([["hrana2",{version:2,encoding:"json"}],["hrana1",{version:1,encoding:"json"}]]),n4=new Map([["hrana3-protobuf",{version:3,encoding:"protobuf"}],["hrana3",{version:3,encoding:"json"}],["hrana2",{version:2,encoding:"json"}],["hrana1",{version:1,encoding:"json"}]]);class h6 extends n2{#X;#$;#Z;#Y;#G;#J;#z;#_;#H;_streamIdAlloc;_cursorIdAlloc;#W;constructor(X,$){super();this.#X=X,this.#$=[],this.#Z=!1,this.#Y=void 0,this.#G=!1,this.#J=void 0,this.#z=!1,this.#_=new Map,this.#H=new _2,this._streamIdAlloc=new _2,this._cursorIdAlloc=new _2,this.#W=new _2,this.#X.binaryType="arraybuffer",this.#X.addEventListener("open",()=>this.#U()),this.#X.addEventListener("close",(Z)=>this.#D(Z)),this.#X.addEventListener("error",(Z)=>this.#V(Z)),this.#X.addEventListener("message",(Z)=>this.#I(Z)),this.#O({type:"hello",jwt:$})}#O(X){if(this.#Y!==void 0)throw new Y1("Trying to send a message on a closed client");if(this.#Z)this.#K(X);else{let $=()=>this.#K(X),Z=()=>{return};this.#$.push({openCallback:$,errorCallback:Z})}}#U(){let X=this.#X.protocol;if(X===void 0){this.#A(new q("The `WebSocket.protocol` property is undefined. This most likely means that the WebSocket implementation provided by the environment is broken. If you are using Miniflare 2, please update to Miniflare 3, which fixes this problem."));return}else if(X==="")this.#J={version:1,encoding:"json"};else if(this.#J=n4.get(X),this.#J===void 0){this.#A(new x(`Unrecognized WebSocket subprotocol: ${JSON.stringify(X)}`));return}for(let $ of this.#$)$.openCallback();this.#$.length=0,this.#Z=!0}#K(X){let $=this.#J.encoding;if($==="json"){let Z=k0(X,mZ);this.#X.send(Z)}else if($==="protobuf"){let Z=g0(X,nZ);this.#X.send(Z)}else throw L($,"Impossible encoding")}getVersion(){return new Promise((X,$)=>{if(this.#z=!0,this.#Y!==void 0)$(this.#Y);else if(!this.#Z){let Z=()=>X(this.#J.version);this.#$.push({openCallback:Z,errorCallback:$})}else X(this.#J.version)})}_ensureVersion(X,$){if(this.#J===void 0||!this.#z)throw new x1(`${$} is supported only on protocol version ${X} and higher, but the version supported by the WebSocket server is not yet known. Use Client.getVersion() to wait until the version is available.`);else if(this.#J.version<X)throw new x1(`${$} is supported on protocol version ${X} and higher, but the WebSocket server only supports version ${this.#J.version}`)}_sendRequest(X,$){if(this.#Y!==void 0){$.errorCallback(new m("Client is closed",this.#Y));return}let Z=this.#H.alloc();this.#_.set(Z,{...$,type:X.type}),this.#O({type:"request",requestId:Z,request:X})}#V(X){let Z=X.message??"WebSocket was closed due to an error";this.#A(new l2(Z))}#D(X){let $=`WebSocket was closed with code ${X.code}`;if(X.reason)$+=`: ${X.reason}`;this.#A(new l2($))}#A(X){if(this.#Y!==void 0)return;this.#Y=X;for(let $ of this.#$)$.errorCallback(X);this.#$.length=0;for(let[$,Z]of this.#_.entries())Z.errorCallback(X),this.#H.free($);this.#_.clear(),this.#X.close()}#I(X){if(this.#Y!==void 0)return;try{let $,Z=this.#J.encoding;if(Z==="json"){if(typeof X.data!=="string"){this.#X.close(3003,"Only text messages are accepted with JSON encoding"),this.#A(new x("Received non-text message from server with JSON encoding"));return}$=P2(JSON.parse(X.data),sZ)}else if(Z==="protobuf"){if(!(X.data instanceof ArrayBuffer)){this.#X.close(3003,"Only binary messages are accepted with Protobuf encoding"),this.#A(new x("Received non-binary message from server with Protobuf encoding"));return}$=J2(new Uint8Array(X.data),aZ)}else throw L(Z,"Impossible encoding");this.#R($)}catch($){this.#X.close(3007,"Could not handle message"),this.#A($)}}#R(X){if(X.type==="none")throw new x("Received an unrecognized ServerMsg");else if(X.type==="hello_ok"||X.type==="hello_error"){if(this.#G)throw new x("Received a duplicated hello response");if(this.#G=!0,X.type==="hello_error")throw c1(X.error);return}else if(!this.#G)throw new x("Received a non-hello message before a hello response");if(X.type==="response_ok"){let $=X.requestId,Z=this.#_.get($);if(this.#_.delete($),Z===void 0)throw new x("Received unexpected OK response");this.#H.free($);try{if(Z.type!==X.response.type)throw console.dir({responseState:Z,msg:X}),new x("Received unexpected type of response");Z.responseCallback(X.response)}catch(Y){throw Z.errorCallback(Y),Y}}else if(X.type==="response_error"){let $=X.requestId,Z=this.#_.get($);if(this.#_.delete($),Z===void 0)throw new x("Received unexpected error response");this.#H.free($),Z.errorCallback(c1(X.error))}else throw L(X,"Impossible ServerMsg type")}openStream(){return m0.open(this)}storeSql(X){this._ensureVersion(2,"storeSql()");let $=this.#W.alloc(),Z=new B2(this,$),Y=()=>{return},G=(_)=>Z._setClosed(_),J={type:"store_sql",sqlId:$,sql:X};return this._sendRequest(J,{responseCallback:Y,errorCallback:G}),Z}_closeSql(X){if(this.#Y!==void 0)return;let $=()=>this.#W.free(X),Z=(G)=>this.#A(G),Y={type:"close_sql",sqlId:X};this._sendRequest(Y,{responseCallback:$,errorCallback:Z})}close(){this.#A(new q("Client was manually closed"))}get closed(){return this.#Y!==void 0}}var n0=Request,l4=Headers,o4=fetch;var T2;if(typeof queueMicrotask<"u")T2=queueMicrotask;else{let X=Promise.resolve();T2=($)=>{X.then($)}}class s4{#X;#$;#Z;constructor(X){this.#X=new Uint8Array(new ArrayBuffer(X)),this.#$=0,this.#Z=0}get length(){return this.#Z-this.#$}data(){return this.#X.slice(this.#$,this.#Z)}push(X){this.#Y(X.byteLength),this.#X.set(X,this.#Z),this.#Z+=X.byteLength}#Y(X){if(this.#Z+X<=this.#X.byteLength)return;let $=this.#Z-this.#$;if($+X<=this.#X.byteLength&&2*this.#Z>=this.#X.byteLength)this.#X.copyWithin(0,this.#$,this.#Z);else{let Z=this.#X.byteLength;do Z*=2;while($+X>Z);let Y=new Uint8Array(new ArrayBuffer(Z));Y.set(this.#X.slice(this.#$,this.#Z),0),this.#X=Y}this.#Z=$,this.#$=0}shift(X){this.#$+=X}}function X7(X){let $=A1(X.baton),Z=A1(X.base_url),Y=P1(X.results,Y9);return{baton:$,baseUrl:Z,results:Y}}function Y9(X){let $=_1(X.type);if($==="ok")return{type:"ok",response:G9(i(X.response))};else if($==="error")return{type:"error",error:H2(i(X.error))};else throw new x("Unexpected type of StreamResult")}function G9(X){let $=_1(X.type);if($==="close")return{type:"close"};else if($==="execute")return{type:"execute",result:i0(i(X.result))};else if($==="batch")return{type:"batch",result:L6(i(X.result))};else if($==="sequence")return{type:"sequence"};else if($==="describe")return{type:"describe",result:v6(i(X.result))};else if($==="store_sql")return{type:"store_sql"};else if($==="close_sql")return{type:"close_sql"};else if($==="get_autocommit")return{type:"get_autocommit",isAutocommit:G2(X.is_autocommit)};else throw new x("Unexpected type of StreamResponse")}function $7(X){let $=A1(X.baton),Z=A1(X.base_url);return{baton:$,baseUrl:Z}}var Z7={default(){return{baton:void 0,baseUrl:void 0,results:[]}},1(X,$){$.baton=X.string()},2(X,$){$.baseUrl=X.string()},3(X,$){$.results.push(X.message(J9))}},J9={default(){return{type:"none"}},1(X){return{type:"ok",response:X.message(_9)}},2(X){return{type:"error",error:X.message(F1)}}},_9={default(){return{type:"none"}},1(X){return{type:"close"}},2(X){return X.message(z9)},3(X){return X.message(H9)},4(X){return{type:"sequence"}},5(X){return X.message(W9)},6(X){return{type:"store_sql"}},7(X){return{type:"close_sql"}},8(X){return X.message(A9)}},z9={default(){return{type:"execute",result:W2.default()}},1(X,$){$.result=X.message(W2)}},H9={default(){return{type:"batch",result:e2.default()}},1(X,$){$.result=X.message(e2)}},W9={default(){return{type:"describe",result:X0.default()}},1(X,$){$.result=X.message(X0)}},A9={default(){return{type:"get_autocommit",isAutocommit:!1}},1(X,$){$.isAutocommit=X.bool()}},Y7={default(){return{baton:void 0,baseUrl:void 0}},1(X,$){$.baton=X.string()},2(X,$){$.baseUrl=X.string()}};class r4 extends d0{#X;#$;#Z;#Y;#G;#J;constructor(X,$){super();this.#X=X,this.#$=$,this.#Z=void 0,this.#Y=new s4(16384),this.#G=void 0,this.#J=!1}async open(X){if(X.body===null)throw new x("No response body for cursor request");this.#Z=X.body.getReader();let $=await this.#z($7,Y7);if($===void 0)throw new x("Empty response to cursor request");return $}next(){return this.#z(C6,q6)}close(){this._setClosed(new q("Cursor was manually closed"))}_setClosed(X){if(this.#G!==void 0)return;if(this.#G=X,this.#X._cursorClosed(this),this.#Z!==void 0)this.#Z.cancel()}get closed(){return this.#G!==void 0}async#z(X,$){for(;;){if(this.#J)return;else if(this.#G!==void 0)throw new m("Cursor is closed",this.#G);if(this.#$==="json"){let G=this.#_();if(G!==void 0){let J=new TextDecoder().decode(G),_=JSON.parse(J);return P2(_,X)}}else if(this.#$==="protobuf"){let G=this.#H();if(G!==void 0)return J2(G,$)}else throw L(this.#$,"Impossible encoding");if(this.#Z===void 0)throw new Y1("Attempted to read from HTTP cursor before it was opened");let{value:Z,done:Y}=await this.#Z.read();if(Y&&this.#Y.length===0)this.#J=!0;else if(Y)throw new x("Unexpected end of cursor stream");else this.#Y.push(Z)}}#_(){let X=this.#Y.data(),$=10,Z=X.indexOf(10);if(Z<0)return;let Y=X.slice(0,Z);return this.#Y.shift(Z+1),Y}#H(){let X=this.#Y.data(),$=0,Z=0;for(;;){if(Z>=X.byteLength)return;let G=X[Z];if($|=(G&127)<<7*Z,Z+=1,!(G&128))break}if(X.byteLength<Z+$)return;let Y=X.slice(Z,Z+$);return this.#Y.shift(Z+$),Y}}function G7(X,$){if($.baton!==void 0)X.string("baton",$.baton);X.arrayObjects("requests",$.requests,O9)}function O9(X,$){if(X.stringRaw("type",$.type),$.type==="close");else if($.type==="execute")X.object("stmt",$.stmt,u0);else if($.type==="batch")X.object("batch",$.batch,t2);else if($.type==="sequence"){if($.sql!==void 0)X.string("sql",$.sql);if($.sqlId!==void 0)X.number("sql_id",$.sqlId)}else if($.type==="describe"){if($.sql!==void 0)X.string("sql",$.sql);if($.sqlId!==void 0)X.number("sql_id",$.sqlId)}else if($.type==="store_sql")X.number("sql_id",$.sqlId),X.string("sql",$.sql);else if($.type==="close_sql")X.number("sql_id",$.sqlId);else if($.type==="get_autocommit");else throw L($,"Impossible type of StreamRequest")}function J7(X,$){if($.baton!==void 0)X.string("baton",$.baton);X.object("batch",$.batch,t2)}function _7(X,$){if($.baton!==void 0)X.string(1,$.baton);for(let Z of $.requests)X.message(2,Z,K9)}function K9(X,$){if($.type==="close")X.message(1,$,D9);else if($.type==="execute")X.message(2,$,U9);else if($.type==="batch")X.message(3,$,V9);else if($.type==="sequence")X.message(4,$,R9);else if($.type==="describe")X.message(5,$,I9);else if($.type==="store_sql")X.message(6,$,F9);else if($.type==="close_sql")X.message(7,$,N9);else if($.type==="get_autocommit")X.message(8,$,M9);else throw L($,"Impossible type of StreamRequest")}function D9(X,$){}function U9(X,$){X.message(1,$.stmt,c0)}function V9(X,$){X.message(1,$.batch,a2)}function R9(X,$){if($.sql!==void 0)X.string(1,$.sql);if($.sqlId!==void 0)X.int32(2,$.sqlId)}function I9(X,$){if($.sql!==void 0)X.string(1,$.sql);if($.sqlId!==void 0)X.int32(2,$.sqlId)}function F9(X,$){X.int32(1,$.sqlId),X.string(2,$.sql)}function N9(X,$){X.int32(1,$.sqlId)}function M9(X,$){}function z7(X,$){if($.baton!==void 0)X.string(1,$.baton);X.message(2,$.batch,a2)}class S6 extends r2{#X;#$;#Z;#Y;#G;#J;#z;#_;#H;#W;#O;#U;constructor(X,$,Z,Y){super(X.intMode);this.#X=X,this.#$=$.toString(),this.#Z=Z,this.#Y=Y,this.#G=void 0,this.#J=new z2,this.#z=!1,this.#H=!1,this.#W=!1,this.#O=void 0,this.#U=new _2}client(){return this.#X}_sqlOwner(){return this}storeSql(X){let $=this.#U.alloc();return this.#K({type:"store_sql",sqlId:$,sql:X}).then(()=>{return},(Z)=>this._setClosed(Z)),new B2(this,$)}_closeSql(X){if(this.#O!==void 0)return;this.#K({type:"close_sql",sqlId:X}).then(()=>this.#U.free(X),($)=>this._setClosed($))}_execute(X){return this.#K({type:"execute",stmt:X}).then(($)=>{return $.result})}_batch(X){return this.#K({type:"batch",batch:X}).then(($)=>{return $.result})}_describe(X){return this.#K({type:"describe",sql:X.sql,sqlId:X.sqlId}).then(($)=>{return $.result})}_sequence(X){return this.#K({type:"sequence",sql:X.sql,sqlId:X.sqlId}).then(($)=>{return})}getAutocommit(){return this.#X._ensureVersion(3,"getAutocommit()"),this.#K({type:"get_autocommit"}).then((X)=>{return X.isAutocommit})}#K(X){return new Promise(($,Z)=>{this.#V({type:"pipeline",request:X,responseCallback:$,errorCallback:Z})})}_openCursor(X){return new Promise(($,Z)=>{this.#V({type:"cursor",batch:X,cursorCallback:$,errorCallback:Z})})}_cursorClosed(X){if(X!==this.#_)throw new Y1("Cursor was closed, but it was not associated with the stream");this.#_=void 0,T2(()=>this.#D())}close(){this._setClosed(new q("Stream was manually closed"))}closeGracefully(){this.#H=!0,T2(()=>this.#D())}get closed(){return this.#O!==void 0||this.#H}_setClosed(X){if(this.#O!==void 0)return;if(this.#O=X,this.#_!==void 0)this.#_._setClosed(X);this.#X._streamClosed(this);for(;;){let $=this.#J.shift();if($!==void 0)$.errorCallback(X);else break}if((this.#G!==void 0||this.#z)&&!this.#W)this.#J.push({type:"pipeline",request:{type:"close"},responseCallback:()=>{return},errorCallback:()=>{return}}),this.#W=!0,T2(()=>this.#D())}#V(X){if(this.#O!==void 0)throw new m("Stream is closed",this.#O);else if(this.#H)throw new m("Stream is closing",void 0);else this.#J.push(X),T2(()=>this.#D())}#D(){if(this.#z||this.#_!==void 0)return;if(this.#H&&this.#J.length===0){this._setClosed(new q("Stream was gracefully closed"));return}let X=this.#X._endpoint;if(X===void 0){this.#X._endpointPromise.then(()=>this.#D(),(Z)=>this._setClosed(Z));return}let $=this.#J.shift();if($===void 0)return;else if($.type==="pipeline"){let Z=[$];for(;;){let Y=this.#J.first();if(Y!==void 0&&Y.type==="pipeline")Z.push(Y),this.#J.shift();else if(Y===void 0&&this.#H&&!this.#W){Z.push({type:"pipeline",request:{type:"close"},responseCallback:()=>{return},errorCallback:()=>{return}}),this.#W=!0;break}else break}this.#A(X,Z)}else if($.type==="cursor")this.#I(X,$);else throw L($,"Impossible type of QueueEntry")}#A(X,$){this.#R(()=>this.#N($,X),(Z)=>x9(Z,X.encoding),(Z)=>Z.baton,(Z)=>Z.baseUrl,(Z)=>E9($,Z),(Z)=>$.forEach((Y)=>Y.errorCallback(Z)))}#I(X,$){let Z=new r4(this,X.encoding);this.#_=Z,this.#R(()=>this.#M($,X),(Y)=>Z.open(Y),(Y)=>Y.baton,(Y)=>Y.baseUrl,(Y)=>$.cursorCallback(Z),(Y)=>$.errorCallback(Y))}#R(X,$,Z,Y,G,J){let _;try{let z=X(),H=this.#Y;_=H(z)}catch(z){_=Promise.reject(z)}this.#z=!0,_.then((z)=>{if(!z.ok)return P9(z).then((H)=>{throw H});return $(z)}).then((z)=>{this.#G=Z(z),this.#$=Y(z)??this.#$,G(z)}).catch((z)=>{this._setClosed(z),J(z)}).finally(()=>{this.#z=!1,this.#D()})}#N(X,$){return this.#F(new URL($.pipelinePath,this.#$),{baton:this.#G,requests:X.map((Z)=>Z.request)},$.encoding,G7,_7)}#M(X,$){if($.cursorPath===void 0)throw new x1(`Cursors are supported only on protocol version 3 and higher, but the HTTP server only supports version ${$.version}.`);return this.#F(new URL($.cursorPath,this.#$),{baton:this.#G,batch:X.batch},$.encoding,J7,z7)}#F(X,$,Z,Y,G){let J,_;if(Z==="json")J=k0($,Y),_="application/json";else if(Z==="protobuf")J=g0($,G),_="application/x-protobuf";else throw L(Z,"Impossible encoding");let z=new l4;if(z.set("content-type",_),this.#Z!==void 0)z.set("authorization",`Bearer ${this.#Z}`);return new n0(X.toString(),{method:"POST",headers:z,body:J})}}function E9(X,$){if($.results.length!==X.length)throw new x("Server returned unexpected number of pipeline results");for(let Z=0;Z<X.length;++Z){let Y=$.results[Z],G=X[Z];if(Y.type==="ok"){if(Y.response.type!==G.request.type)throw new x("Received unexpected type of response");G.responseCallback(Y.response)}else if(Y.type==="error")G.errorCallback(c1(Y.error));else if(Y.type==="none")throw new x("Received unrecognized type of StreamResult");else throw L(Y,"Received impossible type of StreamResult")}}async function x9(X,$){if($==="json"){let Z=await X.json();return P2(Z,X7)}if($==="protobuf"){let Z=await X.arrayBuffer();return J2(new Uint8Array(Z),Z7)}throw await X.body?.cancel(),L($,"Impossible encoding")}async function P9(X){let $=X.headers.get("content-type")??"text/plain",Z=`Server returned HTTP status ${X.status}`;if($==="application/json"){let Y=await X.json();if("message"in Y)return c1(Y);return new x2(Z,X.status)}if($==="text/plain"){let Y=(await X.text()).trim();if(Y!=="")Z+=`: ${Y}`;return new x2(Z,X.status)}return await X.body?.cancel(),new x2(Z,X.status)}var Q9=[{versionPath:"v3-protobuf",pipelinePath:"v3-protobuf/pipeline",cursorPath:"v3-protobuf/cursor",version:3,encoding:"protobuf"}],t4={versionPath:"v2",pipelinePath:"v2/pipeline",cursorPath:void 0,version:2,encoding:"json"};class k6 extends n2{#X;#$;#Z;#Y;#G;_endpointPromise;_endpoint;constructor(X,$,Z,Y=2){super();if(this.#X=X,this.#$=$,this.#Z=Z??o4,this.#Y=void 0,this.#G=new Set,Y==3)this._endpointPromise=j9(this.#Z,this.#X),this._endpointPromise.then((G)=>this._endpoint=G,(G)=>this.#J(G));else this._endpointPromise=Promise.resolve(t4),this._endpointPromise.then((G)=>this._endpoint=G,(G)=>this.#J(G))}async getVersion(){if(this._endpoint!==void 0)return this._endpoint.version;return(await this._endpointPromise).version}_ensureVersion(X,$){if(X<=t4.version)return;else if(this._endpoint===void 0)throw new x1(`${$} is supported only on protocol version ${X} and higher, but the version supported by the HTTP server is not yet known. Use Client.getVersion() to wait until the version is available.`);else if(this._endpoint.version<X)throw new x1(`${$} is supported only on protocol version ${X} and higher, but the HTTP server only supports version ${this._endpoint.version}.`)}openStream(){if(this.#Y!==void 0)throw new m("Client is closed",this.#Y);let X=new S6(this,this.#X,this.#$,this.#Z);return this.#G.add(X),X}_streamClosed(X){this.#G.delete(X)}close(){this.#J(new q("Client was manually closed"))}get closed(){return this.#Y!==void 0}#J(X){if(this.#Y!==void 0)return;this.#Y=X;for(let $ of Array.from(this.#G))$._setClosed(new m("Client was closed",X))}}async function j9(X,$){let Z=X;for(let Y of Q9){let G=new URL(Y.versionPath,$),J=new n0(G.toString(),{method:"GET"}),_=await Z(J);if(await _.arrayBuffer(),_.ok)return Y}return t4}function a4(X,$,Z=2){if(typeof i2.default>"u")throw new h0("WebSockets are not supported in this environment");var Y=void 0;if(Z==3)Y=Array.from(n4.keys());else Y=Array.from(eZ.keys());let G=new i2.default(X,Y);return new h6(G,$)}function e4(X,$,Z,Y=2){return new k6(X instanceof URL?X:new URL(X),$,Z,Y)}class l0{#X;#$;#Z;constructor(X,$){this.#X=X,this.#$=$,this.#Z=void 0}execute(X){return this.batch([X]).then(($)=>$[0])}async batch(X){let $=this._getStream();if($.closed)throw new Q("Cannot execute statements because the transaction is closed","TRANSACTION_CLOSED");try{let Z=X.map(i1),Y;if(this.#Z===void 0){this._getSqlCache().apply(Z);let J=$.batch(this.#$>=3),_=J.step(),z=_.run(a1(this.#X)),H=_;Y=Z.map((W)=>{let K=J.step().condition(g.ok(H));if(this.#$>=3)K.condition(g.not(g.isAutocommit(J)));let U=K.query(W);return U.catch(()=>{return}),H=K,U}),this.#Z=J.execute().then(()=>z).then(()=>{return});try{await this.#Z}catch(W){throw this.close(),W}}else{if(this.#$<3)await this.#Z;this._getSqlCache().apply(Z);let J=$.batch(this.#$>=3),_=void 0;Y=Z.map((z)=>{let H=J.step();if(_!==void 0)H.condition(g.ok(_));if(this.#$>=3)H.condition(g.not(g.isAutocommit(J)));let W=H.query(z);return W.catch(()=>{return}),_=H,W}),await J.execute()}let G=[];for(let J of Y){let _=await J;if(_===void 0)throw new Q("Statement in a transaction was not executed, probably because the transaction has been rolled back","TRANSACTION_CLOSED");G.push(Z0(_))}return G}catch(Z){throw p(Z)}}async executeMultiple(X){let $=this._getStream();if($.closed)throw new Q("Cannot execute statements because the transaction is closed","TRANSACTION_CLOSED");try{if(this.#Z===void 0){this.#Z=$.run(a1(this.#X)).then(()=>{return});try{await this.#Z}catch(Z){throw this.close(),Z}}else await this.#Z;await $.sequence(X)}catch(Z){throw p(Z)}}async rollback(){try{let X=this._getStream();if(X.closed)return;if(this.#Z!==void 0);else return;let $=X.run("ROLLBACK").catch((Z)=>{throw p(Z)});X.closeGracefully(),await $}catch(X){throw p(X)}finally{this.close()}}async commit(){try{let X=this._getStream();if(X.closed)throw new Q("Cannot commit the transaction because it is already closed","TRANSACTION_CLOSED");if(this.#Z!==void 0)await this.#Z;else return;let $=X.run("COMMIT").catch((Z)=>{throw p(Z)});X.closeGracefully(),await $}catch(X){throw p(X)}finally{this.close()}}}async function $0(X,$,Z,Y,G=!1){if(G)Z.step().run("PRAGMA foreign_keys=off");let J=Z.step(),_=J.run(a1(X)),z=J,H=Y.map((M)=>{let R=Z.step().condition(g.ok(z));if($>=3)R.condition(g.not(g.isAutocommit(Z)));let I=R.query(M);return z=R,I}),W=Z.step().condition(g.ok(z));if($>=3)W.condition(g.not(g.isAutocommit(Z)));let K=W.run("COMMIT");if(Z.step().condition(g.not(g.ok(W))).run("ROLLBACK").catch((M)=>{return}),G)Z.step().run("PRAGMA foreign_keys=on");await Z.execute();let F=[];await _;for(let M of H){let R=await M;if(R===void 0)throw new Q("Statement in a batch was not executed, probably because the transaction has been rolled back","TRANSACTION_CLOSED");F.push(Z0(R))}return await K,F}function i1(X){let $,Z;if(Array.isArray(X))[$,Z]=X;else if(typeof X==="string")$=X;else $=X.sql,Z=X.args;let Y=new b0($);if(Z)if(Array.isArray(Z))Y.bindIndexes(Z);else for(let[G,J]of Object.entries(Z))Y.bindName(G,J);return Y}function Z0(X){let $=X.columnNames.map((_)=>_??""),Z=X.columnDecltypes.map((_)=>_??""),Y=X.rows,G=X.affectedRowCount,J=X.lastInsertRowid!==void 0?X.lastInsertRowid:void 0;return new k2($,Z,Y,G,J)}function p(X){if(X instanceof q){let $=H7(X);return new Q(X.message,$,void 0,X)}return X}function H7(X){if(X instanceof q0&&X.code!==void 0)return X.code;else if(X instanceof x)return"HRANA_PROTO_ERROR";else if(X instanceof m)return X.cause instanceof q?H7(X.cause):"HRANA_CLOSED_ERROR";else if(X instanceof l2)return"HRANA_WEBSOCKET_ERROR";else if(X instanceof x2)return"SERVER_ERROR";else if(X instanceof x1)return"PROTOCOL_VERSION_ERROR";else if(X instanceof Y1)return"INTERNAL_ERROR";else return"UNKNOWN"}class Y0{#X;#$;capacity;constructor(X,$){this.#X=X,this.#$=new W7,this.capacity=$}apply(X){if(this.capacity<=0)return;let $=new Set;for(let Z of X){if(typeof Z.sql!=="string")continue;let Y=Z.sql;if(Y.length>=5000)continue;let G=this.#$.get(Y);if(G===void 0){while(this.#$.size+1>this.capacity){let[J,_]=this.#$.peekLru();if($.has(_))break;_.close(),this.#$.delete(J)}if(this.#$.size+1<=this.capacity)G=this.#X.storeSql(Y),this.#$.set(Y,G)}if(G!==void 0)Z.sql=G,$.add(G)}}}class W7{#X;constructor(){this.#X=new Map}get(X){let $=this.#X.get(X);if($!==void 0)this.#X.delete(X),this.#X.set(X,$);return $}set(X,$){this.#X.set(X,$)}peekLru(){for(let X of this.#X.entries())return X;return}delete(X){this.#X.delete(X)}get size(){return this.#X.size}}var D7=p1($8(),1);function U7(X){if(X.scheme!=="wss"&&X.scheme!=="ws")throw new Q(`The WebSocket client supports only "libsql:", "wss:" and "ws:" URLs, got ${JSON.stringify(X.scheme+":")}. For more information, please read ${L1}`,"URL_SCHEME_NOT_SUPPORTED");if(X.encryptionKey!==void 0)throw new Q("Encryption key is not supported by the remote client.","ENCRYPTION_KEY_NOT_SUPPORTED");if(X.scheme==="ws"&&X.tls)throw new Q('A "ws:" URL cannot opt into TLS by using ?tls=1',"URL_INVALID");else if(X.scheme==="wss"&&!X.tls)throw new Q('A "wss:" URL cannot opt out of TLS by using ?tls=0',"URL_INVALID");let $=M0(X.scheme,X.authority,X.path),Z;try{Z=a4($,X.authToken)}catch(Y){if(Y instanceof h0){let G=X.scheme==="wss"?"https":"http",J=M0(G,X.authority,X.path);throw new Q(`This environment does not support WebSockets, please switch to the HTTP client by using a "${G}:" URL (${JSON.stringify(J)}). For more information, please read ${L1}`,"WEBSOCKETS_NOT_SUPPORTED")}throw p(Y)}return new V7(Z,$,X.authToken,X.intMode,X.concurrency)}var w9=60000,K7=100;class V7{#X;#$;#Z;#Y;#G;closed;protocol;#J;#z;constructor(X,$,Z,Y,G){this.#X=$,this.#$=Z,this.#Z=Y,this.#Y=this.#H(X),this.#G=void 0,this.closed=!1,this.protocol="ws",this.#z=D7.default(G)}async limit(X){return this.#z(X)}async execute(X,$){let Z;if(typeof X==="string")Z={sql:X,args:$||[]};else Z=X;return this.limit(async()=>{let Y=await this.#_();try{let G=i1(Z);Y.conn.sqlCache.apply([G]);let J=Y.stream.query(G);Y.stream.closeGracefully();let _=await J;return Z0(_)}catch(G){throw p(G)}finally{this._closeStream(Y)}})}async batch(X,$="deferred"){return this.limit(async()=>{let Z=await this.#_();try{let G=X.map((W)=>{if(Array.isArray(W))return{sql:W[0],args:W[1]||[]};return W}).map(i1),J=await Z.conn.client.getVersion();Z.conn.sqlCache.apply(G);let _=Z.stream.batch(J>=3);return await $0($,J,_,G)}catch(Y){throw p(Y)}finally{this._closeStream(Z)}})}async migrate(X){return this.limit(async()=>{let $=await this.#_();try{let Z=X.map(i1),Y=await $.conn.client.getVersion(),G=$.stream.batch(Y>=3);return await $0("deferred",Y,G,Z,!0)}catch(Z){throw p(Z)}finally{this._closeStream($)}})}async transaction(X="write"){return this.limit(async()=>{let $=await this.#_();try{let Z=await $.conn.client.getVersion();return new R7(this,$,X,Z)}catch(Z){throw this._closeStream($),p(Z)}})}async executeMultiple(X){return this.limit(async()=>{let $=await this.#_();try{let Z=$.stream.sequence(X);$.stream.closeGracefully(),await Z}catch(Z){throw p(Z)}finally{this._closeStream($)}})}sync(){throw new Q("sync not supported in ws mode","SYNC_NOT_SUPPORTED")}async#_(){if(this.closed)throw new Q("The client is closed","CLIENT_CLOSED");if(new Date().valueOf()-this.#Y.openTime.valueOf()>w9&&this.#G===void 0){let Y=this.#H();this.#G=Y,Y.client.getVersion().then((G)=>{if(this.#Y!==Y){if(this.#Y.streamStates.size===0)this.#Y.client.close()}this.#Y=Y,this.#G=void 0},(G)=>{this.#G=void 0})}if(this.#Y.client.closed)try{if(this.#G!==void 0)this.#Y=this.#G;else this.#Y=this.#H()}catch(Y){throw p(Y)}let Z=this.#Y;try{if(Z.useSqlCache===void 0){if(Z.useSqlCache=await Z.client.getVersion()>=2,Z.useSqlCache)Z.sqlCache.capacity=K7}let Y=Z.client.openStream();Y.intMode=this.#Z;let G={conn:Z,stream:Y};return Z.streamStates.add(G),G}catch(Y){throw p(Y)}}#H(X){try{return X??=a4(this.#X,this.#$),{client:X,useSqlCache:void 0,sqlCache:new Y0(X,0),openTime:new Date,streamStates:new Set}}catch($){throw p($)}}async reconnect(){try{for(let Z of Array.from(this.#Y.streamStates))try{Z.stream.close()}catch{}this.#Y.client.close()}catch{}if(this.#G){try{this.#G.client.close()}catch{}this.#G=void 0}let X=this.#H(),$=await X.client.getVersion();if(X.useSqlCache=$>=2,X.useSqlCache)X.sqlCache.capacity=K7;this.#Y=X,this.closed=!1}_closeStream(X){X.stream.close();let $=X.conn;if($.streamStates.delete(X),$.streamStates.size===0&&$!==this.#Y)$.client.close()}close(){if(this.#Y.client.close(),this.closed=!0,this.#G){try{this.#G.client.close()}catch{}this.#G=void 0}this.closed=!0}}class R7 extends l0{#X;#$;constructor(X,$,Z,Y){super(Z,Y);this.#X=X,this.#$=$}_getStream(){return this.#$.stream}_getSqlCache(){return this.#$.conn.sqlCache}close(){this.#X._closeStream(this.#$)}get closed(){return this.#$.stream.closed}}var I7=p1($8(),1);function F7(X){if(X.scheme!=="https"&&X.scheme!=="http")throw new Q(`The HTTP client supports only "libsql:", "https:" and "http:" URLs, got ${JSON.stringify(X.scheme+":")}. For more information, please read ${L1}`,"URL_SCHEME_NOT_SUPPORTED");if(X.encryptionKey!==void 0)throw new Q("Encryption key is not supported by the remote client.","ENCRYPTION_KEY_NOT_SUPPORTED");if(X.scheme==="http"&&X.tls)throw new Q('A "http:" URL cannot opt into TLS by using ?tls=1',"URL_INVALID");else if(X.scheme==="https"&&!X.tls)throw new Q('A "https:" URL cannot opt out of TLS by using ?tls=0',"URL_INVALID");let $=M0(X.scheme,X.authority,X.path);return new M7($,X.authToken,X.intMode,X.fetch,X.concurrency)}var N7=30;class M7{#X;protocol;#$;#Z;#Y;#G;#J;#z;constructor(X,$,Z,Y,G){this.#$=X,this.#J=$,this.#Z=Z,this.#Y=Y,this.#G=G,this.#X=e4(this.#$,this.#J,this.#Y),this.#X.intMode=this.#Z,this.protocol="http",this.#z=I7.default(this.#G)}async limit(X){return this.#z(X)}async execute(X,$){let Z;if(typeof X==="string")Z={sql:X,args:$||[]};else Z=X;return this.limit(async()=>{try{let Y=i1(Z),G,J=this.#X.openStream();try{G=J.query(Y)}finally{J.closeGracefully()}let _=await G;return Z0(_)}catch(Y){throw p(Y)}})}async batch(X,$="deferred"){return this.limit(async()=>{try{let Y=X.map((H)=>{if(Array.isArray(H))return{sql:H[0],args:H[1]||[]};return H}).map(i1),G=await this.#X.getVersion(),J,_=this.#X.openStream();try{new Y0(_,N7).apply(Y);let W=_.batch(!1);J=$0($,G,W,Y)}finally{_.closeGracefully()}return await J}catch(Z){throw p(Z)}})}async migrate(X){return this.limit(async()=>{try{let $=X.map(i1),Z=await this.#X.getVersion(),Y,G=this.#X.openStream();try{let _=G.batch(!1);Y=$0("deferred",Z,_,$,!0)}finally{G.closeGracefully()}return await Y}catch($){throw p($)}})}async transaction(X="write"){return this.limit(async()=>{try{let $=await this.#X.getVersion();return new E7(this.#X.openStream(),X,$)}catch($){throw p($)}})}async executeMultiple(X){return this.limit(async()=>{try{let $,Z=this.#X.openStream();try{$=Z.sequence(X)}finally{Z.closeGracefully()}await $}catch($){throw p($)}})}sync(){throw new Q("sync not supported in http mode","SYNC_NOT_SUPPORTED")}close(){this.#X.close()}async reconnect(){try{if(!this.closed)this.#X.close()}finally{this.#X=e4(this.#$,this.#J,this.#Y),this.#X.intMode=this.#Z}}get closed(){return this.#X.closed}}class E7 extends l0{#X;#$;constructor(X,$,Z){super($,Z);this.#X=X,this.#$=new Y0(X,N7)}_getStream(){return this.#X}_getSqlCache(){return this.#$}close(){this.#X.close()}get closed(){return this.#X.closed}}function G0(X){return L9(x0(X,!0))}function L9(X){if(X.scheme==="wss"||X.scheme==="ws")return U7(X);else if(X.scheme==="https"||X.scheme==="http")return F7(X);else return B$(X)}class n{static[O]="SelectionProxyHandler";config;constructor(X){this.config={...X}}get(X,$){if($==="_")return{...X._,selectedFields:new Proxy(X._.selectedFields,this)};if($===f)return{...X[f],selectedFields:new Proxy(X[f].selectedFields,this)};if(typeof $==="symbol")return X[$];let Y=(D(X,c)?X._.selectedFields:D(X,D1)?X[f].selectedFields:X)[$];if(D(Y,N.Aliased)){if(this.config.sqlAliasedBehavior==="sql"&&!Y.isSelectionField)return Y.sql;let G=Y.clone();return G.isSelectionField=!0,G}if(D(Y,N)){if(this.config.sqlBehavior==="sql")return Y;throw Error(`You tried to reference "${$}" field from a subquery, which is a raw SQL field, but it doesn't have an alias declared. Please add an alias to the field using ".as('alias')" method.`)}if(D(Y,v)){if(this.config.alias)return new Proxy(Y,new C2(new Proxy(Y.table,new U0(this.config.alias,this.config.replaceOriginalName??!1))));return Y}if(typeof Y!=="object"||Y===null)return Y;return new Proxy(Y,new n(this.config))}}class Z8{static[O]="SQLiteForeignKeyBuilder";reference;_onUpdate;_onDelete;constructor(X,$){if(this.reference=()=>{let{name:Z,columns:Y,foreignColumns:G}=X();return{name:Z,columns:Y,foreignTable:G[0].table,foreignColumns:G}},$)this._onUpdate=$.onUpdate,this._onDelete=$.onDelete}onUpdate(X){return this._onUpdate=X,this}onDelete(X){return this._onDelete=X,this}build(X){return new x7(X,this)}}class x7{constructor(X,$){this.table=X,this.reference=$.reference,this.onUpdate=$._onUpdate,this.onDelete=$._onDelete}static[O]="SQLiteForeignKey";reference;onUpdate;onDelete;getName(){let{name:X,columns:$,foreignColumns:Z}=this.reference(),Y=$.map((_)=>_.name),G=Z.map((_)=>_.name),J=[this.table[z1],...Y,Z[0].table[z1],...G];return X??`${J.join("_")}_fk`}}function P7(X,$){return`${X[z1]}_${$.join("_")}_unique`}class a extends G4{static[O]="SQLiteColumnBuilder";foreignKeyConfigs=[];references(X,$={}){return this.foreignKeyConfigs.push({ref:X,actions:$}),this}unique(X){return this.config.isUnique=!0,this.config.uniqueName=X,this}generatedAlwaysAs(X,$){return this.config.generated={as:X,type:"always",mode:$?.mode??"virtual"},this}buildForeignKeys(X,$){return this.foreignKeyConfigs.map(({ref:Z,actions:Y})=>{return((G,J)=>{let _=new Z8(()=>{let z=G();return{columns:[X],foreignColumns:[z]}});if(J.onUpdate)_.onUpdate(J.onUpdate);if(J.onDelete)_.onDelete(J.onDelete);return _.build($)})(Z,Y)})}}class b extends v{constructor(X,$){if(!$.uniqueName)$.uniqueName=P7(X,[$.name]);super(X,$);this.table=X}static[O]="SQLiteColumn"}class Q7 extends a{static[O]="SQLiteBigIntBuilder";constructor(X){super(X,"bigint","SQLiteBigInt")}build(X){return new j7(X,this.config)}}class j7 extends b{static[O]="SQLiteBigInt";getSQLType(){return"blob"}mapFromDriverValue(X){if(typeof Buffer<"u"&&Buffer.from){let $=Buffer.isBuffer(X)?X:X instanceof ArrayBuffer?Buffer.from(X):X.buffer?Buffer.from(X.buffer,X.byteOffset,X.byteLength):Buffer.from(X);return BigInt($.toString("utf8"))}return BigInt(V4.decode(X))}mapToDriverValue(X){return Buffer.from(X.toString())}}class B7 extends a{static[O]="SQLiteBlobJsonBuilder";constructor(X){super(X,"json","SQLiteBlobJson")}build(X){return new T7(X,this.config)}}class T7 extends b{static[O]="SQLiteBlobJson";getSQLType(){return"blob"}mapFromDriverValue(X){if(typeof Buffer<"u"&&Buffer.from){let $=Buffer.isBuffer(X)?X:X instanceof ArrayBuffer?Buffer.from(X):X.buffer?Buffer.from(X.buffer,X.byteOffset,X.byteLength):Buffer.from(X);return JSON.parse($.toString("utf8"))}return JSON.parse(V4.decode(X))}mapToDriverValue(X){return Buffer.from(JSON.stringify(X))}}class w7 extends a{static[O]="SQLiteBlobBufferBuilder";constructor(X){super(X,"buffer","SQLiteBlobBuffer")}build(X){return new L7(X,this.config)}}class L7 extends b{static[O]="SQLiteBlobBuffer";mapFromDriverValue(X){if(Buffer.isBuffer(X))return X;return Buffer.from(X)}getSQLType(){return"blob"}}function C7(X,$){let{name:Z,config:Y}=w1(X,$);if(Y?.mode==="json")return new B7(Z);if(Y?.mode==="bigint")return new Q7(Z);return new w7(Z)}class v7 extends a{static[O]="SQLiteCustomColumnBuilder";constructor(X,$,Z){super(X,"custom","SQLiteCustomColumn");this.config.fieldConfig=$,this.config.customTypeParams=Z}build(X){return new q7(X,this.config)}}class q7 extends b{static[O]="SQLiteCustomColumn";sqlName;mapTo;mapFrom;constructor(X,$){super(X,$);this.sqlName=$.customTypeParams.dataType($.fieldConfig),this.mapTo=$.customTypeParams.toDriver,this.mapFrom=$.customTypeParams.fromDriver}getSQLType(){return this.sqlName}mapFromDriverValue(X){return typeof this.mapFrom==="function"?this.mapFrom(X):X}mapToDriverValue(X){return typeof this.mapTo==="function"?this.mapTo(X):X}}function h7(X){return($,Z)=>{let{name:Y,config:G}=w1($,Z);return new v7(Y,G,X)}}class y6 extends a{static[O]="SQLiteBaseIntegerBuilder";constructor(X,$,Z){super(X,$,Z);this.config.autoIncrement=!1}primaryKey(X){if(X?.autoIncrement)this.config.autoIncrement=!0;return this.config.hasDefault=!0,super.primaryKey()}}class f6 extends b{static[O]="SQLiteBaseInteger";autoIncrement=this.config.autoIncrement;getSQLType(){return"integer"}}class S7 extends y6{static[O]="SQLiteIntegerBuilder";constructor(X){super(X,"number","SQLiteInteger")}build(X){return new k7(X,this.config)}}class k7 extends f6{static[O]="SQLiteInteger"}class y7 extends y6{static[O]="SQLiteTimestampBuilder";constructor(X,$){super(X,"date","SQLiteTimestamp");this.config.mode=$}defaultNow(){return this.default(A`(cast((julianday('now') - 2440587.5)*86400000 as integer))`)}build(X){return new f7(X,this.config)}}class f7 extends f6{static[O]="SQLiteTimestamp";mode=this.config.mode;mapFromDriverValue(X){if(this.config.mode==="timestamp")return new Date(X*1000);return new Date(X)}mapToDriverValue(X){let $=X.getTime();if(this.config.mode==="timestamp")return Math.floor($/1000);return $}}class g7 extends y6{static[O]="SQLiteBooleanBuilder";constructor(X,$){super(X,"boolean","SQLiteBoolean");this.config.mode=$}build(X){return new p7(X,this.config)}}class p7 extends f6{static[O]="SQLiteBoolean";mode=this.config.mode;mapFromDriverValue(X){return Number(X)===1}mapToDriverValue(X){return X?1:0}}function A2(X,$){let{name:Z,config:Y}=w1(X,$);if(Y?.mode==="timestamp"||Y?.mode==="timestamp_ms")return new y7(Z,Y.mode);if(Y?.mode==="boolean")return new g7(Z,Y.mode);return new S7(Z)}class b7 extends a{static[O]="SQLiteNumericBuilder";constructor(X){super(X,"string","SQLiteNumeric")}build(X){return new d7(X,this.config)}}class d7 extends b{static[O]="SQLiteNumeric";mapFromDriverValue(X){if(typeof X==="string")return X;return String(X)}getSQLType(){return"numeric"}}class m7 extends a{static[O]="SQLiteNumericNumberBuilder";constructor(X){super(X,"number","SQLiteNumericNumber")}build(X){return new u7(X,this.config)}}class u7 extends b{static[O]="SQLiteNumericNumber";mapFromDriverValue(X){if(typeof X==="number")return X;return Number(X)}mapToDriverValue=String;getSQLType(){return"numeric"}}class c7 extends a{static[O]="SQLiteNumericBigIntBuilder";constructor(X){super(X,"bigint","SQLiteNumericBigInt")}build(X){return new i7(X,this.config)}}class i7 extends b{static[O]="SQLiteNumericBigInt";mapFromDriverValue=BigInt;mapToDriverValue=String;getSQLType(){return"numeric"}}function n7(X,$){let{name:Z,config:Y}=w1(X,$),G=Y?.mode;return G==="number"?new m7(Z):G==="bigint"?new c7(Z):new b7(Z)}class l7 extends a{static[O]="SQLiteRealBuilder";constructor(X){super(X,"number","SQLiteReal")}build(X){return new o7(X,this.config)}}class o7 extends b{static[O]="SQLiteReal";getSQLType(){return"real"}}function J0(X){return new l7(X??"")}class s7 extends a{static[O]="SQLiteTextBuilder";constructor(X,$){super(X,"string","SQLiteText");this.config.enumValues=$.enum,this.config.length=$.length}build(X){return new r7(X,this.config)}}class r7 extends b{static[O]="SQLiteText";enumValues=this.config.enumValues;length=this.config.length;constructor(X,$){super(X,$)}getSQLType(){return`text${this.config.length?`(${this.config.length})`:""}`}}class t7 extends a{static[O]="SQLiteTextJsonBuilder";constructor(X){super(X,"json","SQLiteTextJson")}build(X){return new a7(X,this.config)}}class a7 extends b{static[O]="SQLiteTextJson";getSQLType(){return"text"}mapFromDriverValue(X){return JSON.parse(X)}mapToDriverValue(X){return JSON.stringify(X)}}function u(X,$={}){let{name:Z,config:Y}=w1(X,$);if(Y.mode==="json")return new t7(Z);return new s7(Z,Y)}function e7(){return{blob:C7,customType:h7,integer:A2,numeric:n7,real:J0,text:u}}var Y8=Symbol.for("drizzle:SQLiteInlineForeignKeys");class l extends V{static[O]="SQLiteTable";static Symbol=Object.assign({},V.Symbol,{InlineForeignKeys:Y8});[V.Symbol.Columns];[Y8]=[];[V.Symbol.ExtraConfigBuilder]=void 0}function C9(X,$,Z,Y,G=X){let J=new l(X,Y,G),_=typeof $==="function"?$(e7()):$,z=Object.fromEntries(Object.entries(_).map(([W,K])=>{let U=K;U.setName(W);let F=U.build(J);return J[Y8].push(...U.buildForeignKeys(F,J)),[W,F]})),H=Object.assign(J,z);if(H[V.Symbol.Columns]=z,H[V.Symbol.ExtraConfigColumns]=z,Z)H[l.Symbol.ExtraConfigBuilder]=Z;return H}var O2=(X,$,Z)=>{return C9(X,$,Z)};class X5{constructor(X,$){this.name=X,this.unique=$}static[O]="SQLiteIndexBuilderOn";on(...X){return new $5(this.name,X,this.unique)}}class $5{static[O]="SQLiteIndexBuilder";config;constructor(X,$,Z){this.config={name:X,columns:$,unique:Z,where:void 0}}where(X){return this.config.where=X,this}build(X){return new Z5(this.config,X)}}class Z5{static[O]="SQLiteIndex";config;constructor(X,$){this.config={...X,table:$}}}function n1(X){return new X5(X,!1)}function g6(...X){if(X[0].columns)return new G8(X[0].columns,X[0].name);return new G8(X)}class G8{static[O]="SQLitePrimaryKeyBuilder";columns;name;constructor(X,$){this.columns=X,this.name=$}build(X){return new Y5(X,this.columns,this.name)}}class Y5{constructor(X,$,Z){this.table=X,this.columns=$,this.name=Z}static[O]="SQLitePrimaryKey";columns;name;getName(){return this.name??`${this.table[l.Symbol.Name]}_${this.columns.map((X)=>X.name).join("_")}_pk`}}function Q1(X){if(D(X,l))return[`${X[V.Symbol.BaseName]}`];if(D(X,c))return X._.usedTables??[];if(D(X,N))return X.usedTables??[];return[]}class p6 extends G1{constructor(X,$,Z,Y){super();this.table=X,this.session=$,this.dialect=Z,this.config={table:X,withList:Y}}static[O]="SQLiteDelete";config;where(X){return this.config.where=X,this}orderBy(...X){if(typeof X[0]==="function"){let $=X[0](new Proxy(this.config.table[V.Symbol.Columns],new n({sqlAliasedBehavior:"alias",sqlBehavior:"sql"}))),Z=Array.isArray($)?$:[$];this.config.orderBy=Z}else{let $=X;this.config.orderBy=$}return this}limit(X){return this.config.limit=X,this}returning(X=this.table[l.Symbol.Columns]){return this.config.returning=U1(X),this}getSQL(){return this.dialect.buildDeleteQuery(this.config)}toSQL(){let{typings:X,...$}=this.dialect.sqlToQuery(this.getSQL());return $}_prepare(X=!0){return this.session[X?"prepareOneTimeQuery":"prepareQuery"](this.dialect.sqlToQuery(this.getSQL()),this.config.returning,this.config.returning?"all":"run",!0,void 0,{type:"delete",tables:Q1(this.config.table)})}prepare(){return this._prepare(!1)}run=(X)=>{return this._prepare().run(X)};all=(X)=>{return this._prepare().all(X)};get=(X)=>{return this._prepare().get(X)};values=(X)=>{return this._prepare().values(X)};async execute(X){return this._prepare().execute(X)}$dynamic(){return this}}function v9(X){return(X.replace(/['\u2019]/g,"").match(/[\da-z]+|[A-Z]+(?![a-z])|[A-Z][\da-z]+/g)??[]).map((Z)=>Z.toLowerCase()).join("_")}function q9(X){return(X.replace(/['\u2019]/g,"").match(/[\da-z]+|[A-Z]+(?![a-z])|[A-Z][\da-z]+/g)??[]).reduce((Z,Y,G)=>{let J=G===0?Y.toLowerCase():`${Y[0].toUpperCase()}${Y.slice(1)}`;return Z+J},"")}function h9(X){return X}class J8{static[O]="CasingCache";cache={};cachedTables={};convert;constructor(X){this.convert=X==="snake_case"?v9:X==="camelCase"?q9:h9}getColumnCasing(X){if(!X.keyAsName)return X.name;let $=X.table[V.Symbol.Schema]??"public",Z=X.table[V.Symbol.OriginalName],Y=`${$}.${Z}.${X.name}`;if(!this.cache[Y])this.cacheTable(X.table);return this.cache[Y]}cacheTable(X){let $=X[V.Symbol.Schema]??"public",Z=X[V.Symbol.OriginalName],Y=`${$}.${Z}`;if(!this.cachedTables[Y]){for(let G of Object.values(X[V.Symbol.Columns])){let J=`${Y}.${G.name}`;this.cache[J]=this.convert(G.name)}this.cachedTables[Y]=!0}}clearCache(){this.cache={},this.cachedTables={}}}class w2 extends D1{static[O]="SQLiteViewBase"}class _0{static[O]="SQLiteDialect";casing;constructor(X){this.casing=new J8(X?.casing)}escapeName(X){return`"${X}"`}escapeParam(X){return"?"}escapeString(X){return`'${X.replace(/'/g,"''")}'`}buildWithCTE(X){if(!X?.length)return;let $=[A`with `];for(let[Z,Y]of X.entries())if($.push(A`${A.identifier(Y._.alias)} as (${Y._.sql})`),Z<X.length-1)$.push(A`, `);return $.push(A` `),A.join($)}buildDeleteQuery({table:X,where:$,returning:Z,withList:Y,limit:G,orderBy:J}){let _=this.buildWithCTE(Y),z=Z?A` returning ${this.buildSelection(Z,{isSingleTable:!0})}`:void 0,H=$?A` where ${$}`:void 0,W=this.buildOrderBy(J),K=this.buildLimit(G);return A`${_}delete from ${X}${H}${z}${W}${K}`}buildUpdateSet(X,$){let Z=X[V.Symbol.Columns],Y=Object.keys(Z).filter((J)=>$[J]!==void 0||Z[J]?.onUpdateFn!==void 0),G=Y.length;return A.join(Y.flatMap((J,_)=>{let z=Z[J],H=$[J]??A.param(z.onUpdateFn(),z),W=A`${A.identifier(this.casing.getColumnCasing(z))} = ${H}`;if(_<G-1)return[W,A.raw(", ")];return[W]}))}buildUpdateQuery({table:X,set:$,where:Z,returning:Y,withList:G,joins:J,from:_,limit:z,orderBy:H}){let W=this.buildWithCTE(G),K=this.buildUpdateSet(X,$),U=_&&A.join([A.raw(" from "),this.buildFromTable(_)]),F=this.buildJoins(J),M=Y?A` returning ${this.buildSelection(Y,{isSingleTable:!0})}`:void 0,R=Z?A` where ${Z}`:void 0,I=this.buildOrderBy(H),E=this.buildLimit(z);return A`${W}update ${X} set ${K}${U}${F}${R}${M}${I}${E}`}buildSelection(X,{isSingleTable:$=!1}={}){let Z=X.length,Y=X.flatMap(({field:G},J)=>{let _=[];if(D(G,N.Aliased)&&G.isSelectionField)_.push(A.identifier(G.fieldAlias));else if(D(G,N.Aliased)||D(G,N)){let z=D(G,N.Aliased)?G.sql:G;if($)_.push(new N(z.queryChunks.map((H)=>{if(D(H,v))return A.identifier(this.casing.getColumnCasing(H));return H})));else _.push(z);if(D(G,N.Aliased))_.push(A` as ${A.identifier(G.fieldAlias)}`)}else if(D(G,v)){let z=G.table[V.Symbol.Name];if(G.columnType==="SQLiteNumericBigInt")if($)_.push(A`cast(${A.identifier(this.casing.getColumnCasing(G))} as text)`);else _.push(A`cast(${A.identifier(z)}.${A.identifier(this.casing.getColumnCasing(G))} as text)`);else if($)_.push(A.identifier(this.casing.getColumnCasing(G)));else _.push(A`${A.identifier(z)}.${A.identifier(this.casing.getColumnCasing(G))}`)}if(J<Z-1)_.push(A`, `);return _});return A.join(Y)}buildJoins(X){if(!X||X.length===0)return;let $=[];if(X)for(let[Z,Y]of X.entries()){if(Z===0)$.push(A` `);let G=Y.table,J=Y.on?A` on ${Y.on}`:void 0;if(D(G,l)){let _=G[l.Symbol.Name],z=G[l.Symbol.Schema],H=G[l.Symbol.OriginalName],W=_===H?void 0:Y.alias;$.push(A`${A.raw(Y.joinType)} join ${z?A`${A.identifier(z)}.`:void 0}${A.identifier(H)}${W&&A` ${A.identifier(W)}`}${J}`)}else $.push(A`${A.raw(Y.joinType)} join ${G}${J}`);if(Z<X.length-1)$.push(A` `)}return A.join($)}buildLimit(X){return typeof X==="object"||typeof X==="number"&&X>=0?A` limit ${X}`:void 0}buildOrderBy(X){let $=[];if(X){for(let[Z,Y]of X.entries())if($.push(Y),Z<X.length-1)$.push(A`, `)}return $.length>0?A` order by ${A.join($)}`:void 0}buildFromTable(X){if(D(X,V)&&X[V.Symbol.IsAlias])return A`${A`${A.identifier(X[V.Symbol.Schema]??"")}.`.if(X[V.Symbol.Schema])}${A.identifier(X[V.Symbol.OriginalName])} ${A.identifier(X[V.Symbol.Name])}`;return X}buildSelectQuery({withList:X,fields:$,fieldsFlat:Z,where:Y,having:G,table:J,joins:_,orderBy:z,groupBy:H,limit:W,offset:K,distinct:U,setOperators:F}){let M=Z??U1($);for(let M1 of M)if(D(M1.field,v)&&o1(M1.field.table)!==(D(J,c)?J._.alias:D(J,w2)?J[f].name:D(J,N)?void 0:o1(J))&&!((B1)=>_?.some(({alias:X6})=>X6===(B1[V.Symbol.IsAlias]?o1(B1):B1[V.Symbol.BaseName])))(M1.field.table)){let B1=o1(M1.field.table);throw Error(`Your "${M1.path.join("->")}" field references a column "${B1}"."${M1.field.name}", but the table "${B1}" is not part of the query! Did you forget to join it?`)}let R=!_||_.length===0,I=this.buildWithCTE(X),E=U?A` distinct`:void 0,S=this.buildSelection(M,{isSingleTable:R}),y=this.buildFromTable(J),T=this.buildJoins(_),Z1=Y?A` where ${Y}`:void 0,r=G?A` having ${G}`:void 0,P=[];if(H){for(let[M1,B1]of H.entries())if(P.push(B1),M1<H.length-1)P.push(A`, `)}let C=P.length>0?A` group by ${A.join(P)}`:void 0,K1=this.buildOrderBy(z),l1=this.buildLimit(W),W0=K?A` offset ${K}`:void 0,L2=A`${I}select${E} ${S} from ${y}${T}${Z1}${C}${r}${K1}${l1}${W0}`;if(F.length>0)return this.buildSetOperations(L2,F);return L2}buildSetOperations(X,$){let[Z,...Y]=$;if(!Z)throw Error("Cannot pass undefined values to any set operator");if(Y.length===0)return this.buildSetOperationQuery({leftSelect:X,setOperator:Z});return this.buildSetOperations(this.buildSetOperationQuery({leftSelect:X,setOperator:Z}),Y)}buildSetOperationQuery({leftSelect:X,setOperator:{type:$,isAll:Z,rightSelect:Y,limit:G,orderBy:J,offset:_}}){let z=A`${X.getSQL()} `,H=A`${Y.getSQL()}`,W;if(J&&J.length>0){let M=[];for(let R of J)if(D(R,b))M.push(A.identifier(R.name));else if(D(R,N)){for(let I=0;I<R.queryChunks.length;I++){let E=R.queryChunks[I];if(D(E,b))R.queryChunks[I]=A.identifier(this.casing.getColumnCasing(E))}M.push(A`${R}`)}else M.push(A`${R}`);W=A` order by ${A.join(M,A`, `)}`}let K=typeof G==="object"||typeof G==="number"&&G>=0?A` limit ${G}`:void 0,U=A.raw(`${$} ${Z?"all ":""}`),F=_?A` offset ${_}`:void 0;return A`${z}${U}${H}${W}${K}${F}`}buildInsertQuery({table:X,values:$,onConflict:Z,returning:Y,withList:G,select:J}){let _=[],z=X[V.Symbol.Columns],H=Object.entries(z).filter(([R,I])=>!I.shouldDisableInsert()),W=H.map(([,R])=>A.identifier(this.casing.getColumnCasing(R)));if(J){let R=$;if(D(R,N))_.push(R);else _.push(R.getSQL())}else{let R=$;_.push(A.raw("values "));for(let[I,E]of R.entries()){let S=[];for(let[y,T]of H){let Z1=E[y];if(Z1===void 0||D(Z1,H1)&&Z1.value===void 0){let r;if(T.default!==null&&T.default!==void 0)r=D(T.default,N)?T.default:A.param(T.default,T);else if(T.defaultFn!==void 0){let P=T.defaultFn();r=D(P,N)?P:A.param(P,T)}else if(!T.default&&T.onUpdateFn!==void 0){let P=T.onUpdateFn();r=D(P,N)?P:A.param(P,T)}else r=A`null`;S.push(r)}else S.push(Z1)}if(_.push(S),I<R.length-1)_.push(A`, `)}}let K=this.buildWithCTE(G),U=A.join(_),F=Y?A` returning ${this.buildSelection(Y,{isSingleTable:!0})}`:void 0,M=Z?.length?A.join(Z):void 0;return A`${K}insert into ${X} ${W} ${U}${M}${F}`}sqlToQuery(X,$){return X.toQuery({casing:this.casing,escapeName:this.escapeName,escapeParam:this.escapeParam,escapeString:this.escapeString,invokeSource:$})}buildRelationalQuery({fullSchema:X,schema:$,tableNamesMap:Z,table:Y,tableConfig:G,queryConfig:J,tableAlias:_,nestedQueryRelation:z,joinOn:H}){let W=[],K,U,F=[],M,R=[];if(J===!0)W=Object.entries(G.columns).map(([S,y])=>({dbKey:y.name,tsKey:S,field:T1(y,_),relationTableTsKey:void 0,isJson:!1,selection:[]}));else{let E=Object.fromEntries(Object.entries(G.columns).map(([P,C])=>[P,T1(C,_)]));if(J.where){let P=typeof J.where==="function"?J.where(E,RX()):J.where;M=P&&V0(P,_)}let S=[],y=[];if(J.columns){let P=!1;for(let[C,K1]of Object.entries(J.columns)){if(K1===void 0)continue;if(C in G.columns){if(!P&&K1===!0)P=!0;y.push(C)}}if(y.length>0)y=P?y.filter((C)=>J.columns?.[C]===!0):Object.keys(G.columns).filter((C)=>!y.includes(C))}else y=Object.keys(G.columns);for(let P of y){let C=G.columns[P];S.push({tsKey:P,value:C})}let T=[];if(J.with)T=Object.entries(J.with).filter((P)=>!!P[1]).map(([P,C])=>({tsKey:P,queryConfig:C,relation:G.relations[P]}));let Z1;if(J.extras){Z1=typeof J.extras==="function"?J.extras(E,{sql:A}):J.extras;for(let[P,C]of Object.entries(Z1))S.push({tsKey:P,value:A4(C,_)})}for(let{tsKey:P,value:C}of S)W.push({dbKey:D(C,N.Aliased)?C.fieldAlias:G.columns[P].name,tsKey:P,field:D(C,v)?T1(C,_):C,relationTableTsKey:void 0,isJson:!1,selection:[]});let r=typeof J.orderBy==="function"?J.orderBy(E,IX()):J.orderBy??[];if(!Array.isArray(r))r=[r];F=r.map((P)=>{if(D(P,v))return T1(P,_);return V0(P,_)}),K=J.limit,U=J.offset;for(let{tsKey:P,queryConfig:C,relation:K1}of T){let l1=NX($,Z,K1),W0=K2(K1.referencedTable),L2=Z[W0],M1=`${_}_${P}`,B1=V1(...l1.fields.map((U5,V5)=>w(T1(l1.references[V5],M1),T1(U5,_)))),X6=this.buildRelationalQuery({fullSchema:X,schema:$,tableNamesMap:Z,table:X[L2],tableConfig:$[L2],queryConfig:D(K1,r1)?C===!0?{limit:1}:{...C,limit:1}:C,tableAlias:M1,joinOn:B1,nestedQueryRelation:K1}),D5=A`(${X6.sql})`.as(P);W.push({dbKey:P,tsKey:P,field:D5,relationTableTsKey:L2,isJson:!0,selection:X6.selection})}}if(W.length===0)throw new v2({message:`No fields selected for table "${G.tsName}" ("${_}"). You need to have at least one item in "columns", "with" or "extras". If you need to select all columns, omit the "columns" key or set it to undefined.`});let I;if(M=V1(H,M),z){let E=A`json_array(${A.join(W.map(({field:T})=>D(T,b)?A.identifier(this.casing.getColumnCasing(T)):D(T,N.Aliased)?T.sql:T),A`, `)})`;if(D(z,N0))E=A`coalesce(json_group_array(${E}), json_array())`;let S=[{dbKey:"data",tsKey:"data",field:E.as("data"),isJson:!0,relationTableTsKey:G.tsName,selection:W}];if(K!==void 0||U!==void 0||F.length>0)I=this.buildSelectQuery({table:G6(Y,_),fields:{},fieldsFlat:[{path:[],field:A.raw("*")}],where:M,limit:K,offset:U,orderBy:F,setOperators:[]}),M=void 0,K=void 0,U=void 0,F=void 0;else I=G6(Y,_);I=this.buildSelectQuery({table:D(I,l)?I:new c(I,{},_),fields:{},fieldsFlat:S.map(({field:T})=>({path:[],field:D(T,v)?T1(T,_):T})),joins:R,where:M,limit:K,offset:U,orderBy:F,setOperators:[]})}else I=this.buildSelectQuery({table:G6(Y,_),fields:{},fieldsFlat:W.map(({field:E})=>({path:[],field:D(E,v)?T1(E,_):E})),joins:R,where:M,limit:K,offset:U,orderBy:F,setOperators:[]});return{tableTsKey:G.tsName,sql:I,selection:W}}}class _8 extends _0{static[O]="SQLiteSyncDialect";migrate(X,$,Z){let Y=Z===void 0?"__drizzle_migrations":typeof Z==="string"?"__drizzle_migrations":Z.migrationsTable??"__drizzle_migrations",G=A`
			CREATE TABLE IF NOT EXISTS ${A.identifier(Y)} (
				id SERIAL PRIMARY KEY,
				hash text NOT NULL,
				created_at numeric
			)
		`;$.run(G);let _=$.values(A`SELECT id, hash, created_at FROM ${A.identifier(Y)} ORDER BY created_at DESC LIMIT 1`)[0]??void 0;$.run(A`BEGIN`);try{for(let z of X)if(!_||Number(_[2])<z.folderMillis){for(let H of z.sql)$.run(A.raw(H));$.run(A`INSERT INTO ${A.identifier(Y)} ("hash", "created_at") VALUES(${z.hash}, ${z.folderMillis})`)}$.run(A`COMMIT`)}catch(z){throw $.run(A`ROLLBACK`),z}}}class z8 extends _0{static[O]="SQLiteAsyncDialect";async migrate(X,$,Z){let Y=Z===void 0?"__drizzle_migrations":typeof Z==="string"?"__drizzle_migrations":Z.migrationsTable??"__drizzle_migrations",G=A`
			CREATE TABLE IF NOT EXISTS ${A.identifier(Y)} (
				id SERIAL PRIMARY KEY,
				hash text NOT NULL,
				created_at numeric
			)
		`;await $.run(G);let _=(await $.values(A`SELECT id, hash, created_at FROM ${A.identifier(Y)} ORDER BY created_at DESC LIMIT 1`))[0]??void 0;await $.transaction(async(z)=>{for(let H of X)if(!_||Number(_[2])<H.folderMillis){for(let W of H.sql)await z.run(A.raw(W));await z.run(A`INSERT INTO ${A.identifier(Y)} ("hash", "created_at") VALUES(${H.hash}, ${H.folderMillis})`)}})}}class H8{static[O]="TypedQueryBuilder";getSelectedFields(){return this._.selectedFields}}class j1{static[O]="SQLiteSelectBuilder";fields;session;dialect;withList;distinct;constructor(X){this.fields=X.fields,this.session=X.session,this.dialect=X.dialect,this.withList=X.withList,this.distinct=X.distinct}from(X){let $=!!this.fields,Z;if(this.fields)Z=this.fields;else if(D(X,c))Z=Object.fromEntries(Object.keys(X._.selectedFields).map((Y)=>[Y,X[Y]]));else if(D(X,w2))Z=X[f].selectedFields;else if(D(X,N))Z={};else Z=n8(X);return new W8({table:X,fields:Z,isPartialSelect:$,session:this.session,dialect:this.dialect,withList:this.withList,distinct:this.distinct})}}class G5 extends H8{static[O]="SQLiteSelectQueryBuilder";_;config;joinsNotNullableMap;tableName;isPartialSelect;session;dialect;cacheConfig=void 0;usedTables=new Set;constructor({table:X,fields:$,isPartialSelect:Z,session:Y,dialect:G,withList:J,distinct:_}){super();this.config={withList:J,table:X,fields:{...$},distinct:_,setOperators:[]},this.isPartialSelect=Z,this.session=Y,this.dialect=G,this._={selectedFields:$,config:this.config},this.tableName=I0(X),this.joinsNotNullableMap=typeof this.tableName==="string"?{[this.tableName]:!0}:{};for(let z of Q1(X))this.usedTables.add(z)}getUsedTables(){return[...this.usedTables]}createJoin(X){return($,Z)=>{let Y=this.tableName,G=I0($);for(let J of Q1($))this.usedTables.add(J);if(typeof G==="string"&&this.config.joins?.some((J)=>J.alias===G))throw Error(`Alias "${G}" is already used in this query`);if(!this.isPartialSelect){if(Object.keys(this.joinsNotNullableMap).length===1&&typeof Y==="string")this.config.fields={[Y]:this.config.fields};if(typeof G==="string"&&!D($,N)){let J=D($,c)?$._.selectedFields:D($,D1)?$[f].selectedFields:$[V.Symbol.Columns];this.config.fields[G]=J}}if(typeof Z==="function")Z=Z(new Proxy(this.config.fields,new n({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})));if(!this.config.joins)this.config.joins=[];if(this.config.joins.push({on:Z,table:$,joinType:X,alias:G}),typeof G==="string")switch(X){case"left":{this.joinsNotNullableMap[G]=!1;break}case"right":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([J])=>[J,!1])),this.joinsNotNullableMap[G]=!0;break}case"cross":case"inner":{this.joinsNotNullableMap[G]=!0;break}case"full":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([J])=>[J,!1])),this.joinsNotNullableMap[G]=!1;break}}return this}}leftJoin=this.createJoin("left");rightJoin=this.createJoin("right");innerJoin=this.createJoin("inner");fullJoin=this.createJoin("full");crossJoin=this.createJoin("cross");createSetOperator(X,$){return(Z)=>{let Y=typeof Z==="function"?Z(S9()):Z;if(!R0(this.getSelectedFields(),Y.getSelectedFields()))throw Error("Set operator error (union / intersect / except): selected fields are not the same or are in a different order");return this.config.setOperators.push({type:X,isAll:$,rightSelect:Y}),this}}union=this.createSetOperator("union",!1);unionAll=this.createSetOperator("union",!0);intersect=this.createSetOperator("intersect",!1);except=this.createSetOperator("except",!1);addSetOperators(X){return this.config.setOperators.push(...X),this}where(X){if(typeof X==="function")X=X(new Proxy(this.config.fields,new n({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})));return this.config.where=X,this}having(X){if(typeof X==="function")X=X(new Proxy(this.config.fields,new n({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})));return this.config.having=X,this}groupBy(...X){if(typeof X[0]==="function"){let $=X[0](new Proxy(this.config.fields,new n({sqlAliasedBehavior:"alias",sqlBehavior:"sql"})));this.config.groupBy=Array.isArray($)?$:[$]}else this.config.groupBy=X;return this}orderBy(...X){if(typeof X[0]==="function"){let $=X[0](new Proxy(this.config.fields,new n({sqlAliasedBehavior:"alias",sqlBehavior:"sql"}))),Z=Array.isArray($)?$:[$];if(this.config.setOperators.length>0)this.config.setOperators.at(-1).orderBy=Z;else this.config.orderBy=Z}else{let $=X;if(this.config.setOperators.length>0)this.config.setOperators.at(-1).orderBy=$;else this.config.orderBy=$}return this}limit(X){if(this.config.setOperators.length>0)this.config.setOperators.at(-1).limit=X;else this.config.limit=X;return this}offset(X){if(this.config.setOperators.length>0)this.config.setOperators.at(-1).offset=X;else this.config.offset=X;return this}getSQL(){return this.dialect.buildSelectQuery(this.config)}toSQL(){let{typings:X,...$}=this.dialect.sqlToQuery(this.getSQL());return $}as(X){let $=[];if($.push(...Q1(this.config.table)),this.config.joins)for(let Z of this.config.joins)$.push(...Q1(Z.table));return new Proxy(new c(this.getSQL(),this.config.fields,X,!1,[...new Set($)]),new n({alias:X,sqlAliasedBehavior:"alias",sqlBehavior:"error"}))}getSelectedFields(){return new Proxy(this.config.fields,new n({alias:this.tableName,sqlAliasedBehavior:"alias",sqlBehavior:"error"}))}$dynamic(){return this}}class W8 extends G5{static[O]="SQLiteSelect";_prepare(X=!0){if(!this.session)throw Error("Cannot execute a query on a query builder. Please use a database instance instead.");let $=U1(this.config.fields),Z=this.session[X?"prepareOneTimeQuery":"prepareQuery"](this.dialect.sqlToQuery(this.getSQL()),$,"all",!0,void 0,{type:"select",tables:[...this.usedTables]},this.cacheConfig);return Z.joinsNotNullableMap=this.joinsNotNullableMap,Z}$withCache(X){return this.cacheConfig=X===void 0?{config:{},enable:!0,autoInvalidate:!0}:X===!1?{enable:!1}:{enable:!0,autoInvalidate:!0,...X},this}prepare(){return this._prepare(!1)}run=(X)=>{return this._prepare().run(X)};all=(X)=>{return this._prepare().all(X)};get=(X)=>{return this._prepare().get(X)};values=(X)=>{return this._prepare().values(X)};async execute(){return this.all()}}i8(W8,[G1]);function b6(X,$){return(Z,Y,...G)=>{let J=[Y,...G].map((_)=>({type:X,isAll:$,rightSelect:_}));for(let _ of J)if(!R0(Z.getSelectedFields(),_.rightSelect.getSelectedFields()))throw Error("Set operator error (union / intersect / except): selected fields are not the same or are in a different order");return Z.addSetOperators(J)}}var S9=()=>({union:k9,unionAll:y9,intersect:f9,except:g9}),k9=b6("union",!1),y9=b6("union",!0),f9=b6("intersect",!1),g9=b6("except",!1);class o0{static[O]="SQLiteQueryBuilder";dialect;dialectConfig;constructor(X){this.dialect=D(X,_0)?X:void 0,this.dialectConfig=D(X,_0)?void 0:X}$with=(X,$)=>{let Z=this;return{as:(G)=>{if(typeof G==="function")G=G(Z);return new Proxy(new O0(G.getSQL(),$??("getSelectedFields"in G?G.getSelectedFields()??{}:{}),X,!0),new n({alias:X,sqlAliasedBehavior:"alias",sqlBehavior:"error"}))}}};with(...X){let $=this;function Z(G){return new j1({fields:G??void 0,session:void 0,dialect:$.getDialect(),withList:X})}function Y(G){return new j1({fields:G??void 0,session:void 0,dialect:$.getDialect(),withList:X,distinct:!0})}return{select:Z,selectDistinct:Y}}select(X){return new j1({fields:X??void 0,session:void 0,dialect:this.getDialect()})}selectDistinct(X){return new j1({fields:X??void 0,session:void 0,dialect:this.getDialect(),distinct:!0})}getDialect(){if(!this.dialect)this.dialect=new _8(this.dialectConfig);return this.dialect}}class d6{constructor(X,$,Z,Y){this.table=X,this.session=$,this.dialect=Z,this.withList=Y}static[O]="SQLiteInsertBuilder";values(X){if(X=Array.isArray(X)?X:[X],X.length===0)throw Error("values() must be called with at least one value");let $=X.map((Z)=>{let Y={},G=this.table[V.Symbol.Columns];for(let J of Object.keys(Z)){let _=Z[J];Y[J]=D(_,N)?_:new H1(_,G[J])}return Y});return new A8(this.table,$,this.session,this.dialect,this.withList)}select(X){let $=typeof X==="function"?X(new o0):X;if(!D($,N)&&!R0(this.table[Z6],$._.selectedFields))throw Error("Insert select error: selected fields are not the same or are in a different order compared to the table definition");return new A8(this.table,$,this.session,this.dialect,this.withList,!0)}}class A8 extends G1{constructor(X,$,Z,Y,G,J){super();this.session=Z,this.dialect=Y,this.config={table:X,values:$,withList:G,select:J}}static[O]="SQLiteInsert";config;returning(X=this.config.table[l.Symbol.Columns]){return this.config.returning=U1(X),this}onConflictDoNothing(X={}){if(!this.config.onConflict)this.config.onConflict=[];if(X.target===void 0)this.config.onConflict.push(A` on conflict do nothing`);else{let $=Array.isArray(X.target)?A`${X.target}`:A`${[X.target]}`,Z=X.where?A` where ${X.where}`:A``;this.config.onConflict.push(A` on conflict ${$} do nothing${Z}`)}return this}onConflictDoUpdate(X){if(X.where&&(X.targetWhere||X.setWhere))throw Error('You cannot use both "where" and "targetWhere"/"setWhere" at the same time - "where" is deprecated, use "targetWhere" or "setWhere" instead.');if(!this.config.onConflict)this.config.onConflict=[];let $=X.where?A` where ${X.where}`:void 0,Z=X.targetWhere?A` where ${X.targetWhere}`:void 0,Y=X.setWhere?A` where ${X.setWhere}`:void 0,G=Array.isArray(X.target)?A`${X.target}`:A`${[X.target]}`,J=this.dialect.buildUpdateSet(this.config.table,J6(this.config.table,X.set));return this.config.onConflict.push(A` on conflict ${G}${Z} do update set ${J}${$}${Y}`),this}getSQL(){return this.dialect.buildInsertQuery(this.config)}toSQL(){let{typings:X,...$}=this.dialect.sqlToQuery(this.getSQL());return $}_prepare(X=!0){return this.session[X?"prepareOneTimeQuery":"prepareQuery"](this.dialect.sqlToQuery(this.getSQL()),this.config.returning,this.config.returning?"all":"run",!0,void 0,{type:"insert",tables:Q1(this.config.table)})}prepare(){return this._prepare(!1)}run=(X)=>{return this._prepare().run(X)};all=(X)=>{return this._prepare().all(X)};get=(X)=>{return this._prepare().get(X)};values=(X)=>{return this._prepare().values(X)};async execute(){return this.config.returning?this.all():this.run()}$dynamic(){return this}}class m6{constructor(X,$,Z,Y){this.table=X,this.session=$,this.dialect=Z,this.withList=Y}static[O]="SQLiteUpdateBuilder";set(X){return new J5(this.table,J6(this.table,X),this.session,this.dialect,this.withList)}}class J5 extends G1{constructor(X,$,Z,Y,G){super();this.session=Z,this.dialect=Y,this.config={set:$,table:X,withList:G,joins:[]}}static[O]="SQLiteUpdate";config;from(X){return this.config.from=X,this}createJoin(X){return($,Z)=>{let Y=I0($);if(typeof Y==="string"&&this.config.joins.some((G)=>G.alias===Y))throw Error(`Alias "${Y}" is already used in this query`);if(typeof Z==="function"){let G=this.config.from?D($,l)?$[V.Symbol.Columns]:D($,c)?$._.selectedFields:D($,w2)?$[f].selectedFields:void 0:void 0;Z=Z(new Proxy(this.config.table[V.Symbol.Columns],new n({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})),G&&new Proxy(G,new n({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})))}return this.config.joins.push({on:Z,table:$,joinType:X,alias:Y}),this}}leftJoin=this.createJoin("left");rightJoin=this.createJoin("right");innerJoin=this.createJoin("inner");fullJoin=this.createJoin("full");where(X){return this.config.where=X,this}orderBy(...X){if(typeof X[0]==="function"){let $=X[0](new Proxy(this.config.table[V.Symbol.Columns],new n({sqlAliasedBehavior:"alias",sqlBehavior:"sql"}))),Z=Array.isArray($)?$:[$];this.config.orderBy=Z}else{let $=X;this.config.orderBy=$}return this}limit(X){return this.config.limit=X,this}returning(X=this.config.table[l.Symbol.Columns]){return this.config.returning=U1(X),this}getSQL(){return this.dialect.buildUpdateQuery(this.config)}toSQL(){let{typings:X,...$}=this.dialect.sqlToQuery(this.getSQL());return $}_prepare(X=!0){return this.session[X?"prepareOneTimeQuery":"prepareQuery"](this.dialect.sqlToQuery(this.getSQL()),this.config.returning,this.config.returning?"all":"run",!0,void 0,{type:"insert",tables:Q1(this.config.table)})}prepare(){return this._prepare(!1)}run=(X)=>{return this._prepare().run(X)};all=(X)=>{return this._prepare().all(X)};get=(X)=>{return this._prepare().get(X)};values=(X)=>{return this._prepare().values(X)};async execute(){return this.config.returning?this.all():this.run()}$dynamic(){return this}}class s0 extends N{constructor(X){super(s0.buildEmbeddedCount(X.source,X.filters).queryChunks);this.params=X,this.session=X.session,this.sql=s0.buildCount(X.source,X.filters)}sql;static[O]="SQLiteCountBuilderAsync";[Symbol.toStringTag]="SQLiteCountBuilderAsync";session;static buildEmbeddedCount(X,$){return A`(select count(*) from ${X}${A.raw(" where ").if($)}${$})`}static buildCount(X,$){return A`select count(*) from ${X}${A.raw(" where ").if($)}${$}`}then(X,$){return Promise.resolve(this.session.count(this.sql)).then(X,$)}catch(X){return this.then(void 0,X)}finally(X){return this.then(($)=>{return X?.(),$},($)=>{throw X?.(),$})}}class K8{constructor(X,$,Z,Y,G,J,_,z){this.mode=X,this.fullSchema=$,this.schema=Z,this.tableNamesMap=Y,this.table=G,this.tableConfig=J,this.dialect=_,this.session=z}static[O]="SQLiteAsyncRelationalQueryBuilder";findMany(X){return this.mode==="sync"?new O8(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,X?X:{},"many"):new u6(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,X?X:{},"many")}findFirst(X){return this.mode==="sync"?new O8(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,X?{...X,limit:1}:{limit:1},"first"):new u6(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,X?{...X,limit:1}:{limit:1},"first")}}class u6 extends G1{constructor(X,$,Z,Y,G,J,_,z,H){super();this.fullSchema=X,this.schema=$,this.tableNamesMap=Z,this.table=Y,this.tableConfig=G,this.dialect=J,this.session=_,this.config=z,this.mode=H}static[O]="SQLiteAsyncRelationalQuery";mode;getSQL(){return this.dialect.buildRelationalQuery({fullSchema:this.fullSchema,schema:this.schema,tableNamesMap:this.tableNamesMap,table:this.table,tableConfig:this.tableConfig,queryConfig:this.config,tableAlias:this.tableConfig.tsName}).sql}_prepare(X=!1){let{query:$,builtQuery:Z}=this._toSQL();return this.session[X?"prepareOneTimeQuery":"prepareQuery"](Z,void 0,this.mode==="first"?"get":"all",!0,(Y,G)=>{let J=Y.map((_)=>_6(this.schema,this.tableConfig,_,$.selection,G));if(this.mode==="first")return J[0];return J})}prepare(){return this._prepare(!1)}_toSQL(){let X=this.dialect.buildRelationalQuery({fullSchema:this.fullSchema,schema:this.schema,tableNamesMap:this.tableNamesMap,table:this.table,tableConfig:this.tableConfig,queryConfig:this.config,tableAlias:this.tableConfig.tsName}),$=this.dialect.sqlToQuery(X.sql);return{query:X,builtQuery:$}}toSQL(){return this._toSQL().builtQuery}executeRaw(){if(this.mode==="first")return this._prepare(!1).get();return this._prepare(!1).all()}async execute(){return this.executeRaw()}}class O8 extends u6{static[O]="SQLiteSyncRelationalQuery";sync(){return this.executeRaw()}}class z0 extends G1{constructor(X,$,Z,Y,G){super();this.execute=X,this.getSQL=$,this.dialect=Y,this.mapBatchResult=G,this.config={action:Z}}static[O]="SQLiteRaw";config;getQuery(){return{...this.dialect.sqlToQuery(this.getSQL()),method:this.config.action}}mapResult(X,$){return $?this.mapBatchResult(X):X}_prepare(){return this}isResponseInArrayMode(){return!1}}class r0{constructor(X,$,Z,Y){this.resultKind=X,this.dialect=$,this.session=Z,this._=Y?{schema:Y.schema,fullSchema:Y.fullSchema,tableNamesMap:Y.tableNamesMap}:{schema:void 0,fullSchema:{},tableNamesMap:{}},this.query={};let G=this.query;if(this._.schema)for(let[J,_]of Object.entries(this._.schema))G[J]=new K8(X,Y.fullSchema,this._.schema,this._.tableNamesMap,Y.fullSchema[J],_,$,Z);this.$cache={invalidate:async(J)=>{}}}static[O]="BaseSQLiteDatabase";query;$with=(X,$)=>{let Z=this;return{as:(G)=>{if(typeof G==="function")G=G(new o0(Z.dialect));return new Proxy(new O0(G.getSQL(),$??("getSelectedFields"in G?G.getSelectedFields()??{}:{}),X,!0),new n({alias:X,sqlAliasedBehavior:"alias",sqlBehavior:"error"}))}}};$count(X,$){return new s0({source:X,filters:$,session:this.session})}with(...X){let $=this;function Z(z){return new j1({fields:z??void 0,session:$.session,dialect:$.dialect,withList:X})}function Y(z){return new j1({fields:z??void 0,session:$.session,dialect:$.dialect,withList:X,distinct:!0})}function G(z){return new m6(z,$.session,$.dialect,X)}function J(z){return new d6(z,$.session,$.dialect,X)}function _(z){return new p6(z,$.session,$.dialect,X)}return{select:Z,selectDistinct:Y,update:G,insert:J,delete:_}}select(X){return new j1({fields:X??void 0,session:this.session,dialect:this.dialect})}selectDistinct(X){return new j1({fields:X??void 0,session:this.session,dialect:this.dialect,distinct:!0})}update(X){return new m6(X,this.session,this.dialect)}$cache;insert(X){return new d6(X,this.session,this.dialect)}delete(X){return new p6(X,this.session,this.dialect)}run(X){let $=typeof X==="string"?A.raw(X):X.getSQL();if(this.resultKind==="async")return new z0(async()=>this.session.run($),()=>$,"run",this.dialect,this.session.extractRawRunValueFromBatchResult.bind(this.session));return this.session.run($)}all(X){let $=typeof X==="string"?A.raw(X):X.getSQL();if(this.resultKind==="async")return new z0(async()=>this.session.all($),()=>$,"all",this.dialect,this.session.extractRawAllValueFromBatchResult.bind(this.session));return this.session.all($)}get(X){let $=typeof X==="string"?A.raw(X):X.getSQL();if(this.resultKind==="async")return new z0(async()=>this.session.get($),()=>$,"get",this.dialect,this.session.extractRawGetValueFromBatchResult.bind(this.session));return this.session.get($)}values(X){let $=typeof X==="string"?A.raw(X):X.getSQL();if(this.resultKind==="async")return new z0(async()=>this.session.values($),()=>$,"values",this.dialect,this.session.extractRawValuesValueFromBatchResult.bind(this.session));return this.session.values($)}transaction(X,$){return this.session.transaction(X,$)}}class _5{static[O]="Cache"}class t0 extends _5{strategy(){return"all"}static[O]="NoopCache";async get(X){return}async put(X,$,Z,Y){}async onMutate(X){}}async function D8(X,$){let Z=`${X}-${JSON.stringify($)}`,G=new TextEncoder().encode(Z),J=await crypto.subtle.digest("SHA-256",G);return[...new Uint8Array(J)].map((H)=>H.toString(16).padStart(2,"0")).join("")}class z5 extends G1{constructor(X){super();this.resultCb=X}static[O]="ExecuteResultSync";async execute(){return this.resultCb()}sync(){return this.resultCb()}}class U8{constructor(X,$,Z,Y,G,J){if(this.mode=X,this.executeMethod=$,this.query=Z,this.cache=Y,this.queryMetadata=G,this.cacheConfig=J,Y&&Y.strategy()==="all"&&J===void 0)this.cacheConfig={enable:!0,autoInvalidate:!0};if(!this.cacheConfig?.enable)this.cacheConfig=void 0}static[O]="PreparedQuery";joinsNotNullableMap;async queryWithCache(X,$,Z){if(this.cache===void 0||D(this.cache,t0)||this.queryMetadata===void 0)try{return await Z()}catch(Y){throw new f1(X,$,Y)}if(this.cacheConfig&&!this.cacheConfig.enable)try{return await Z()}catch(Y){throw new f1(X,$,Y)}if((this.queryMetadata.type==="insert"||this.queryMetadata.type==="update"||this.queryMetadata.type==="delete")&&this.queryMetadata.tables.length>0)try{let[Y]=await Promise.all([Z(),this.cache.onMutate({tables:this.queryMetadata.tables})]);return Y}catch(Y){throw new f1(X,$,Y)}if(!this.cacheConfig)try{return await Z()}catch(Y){throw new f1(X,$,Y)}if(this.queryMetadata.type==="select"){let Y=await this.cache.get(this.cacheConfig.tag??await D8(X,$),this.queryMetadata.tables,this.cacheConfig.tag!==void 0,this.cacheConfig.autoInvalidate);if(Y===void 0){let G;try{G=await Z()}catch(J){throw new f1(X,$,J)}return await this.cache.put(this.cacheConfig.tag??await D8(X,$),G,this.cacheConfig.autoInvalidate?this.queryMetadata.tables:[],this.cacheConfig.tag!==void 0,this.cacheConfig.config),G}return Y}try{return await Z()}catch(Y){throw new f1(X,$,Y)}}getQuery(){return this.query}mapRunResult(X,$){return X}mapAllResult(X,$){throw Error("Not implemented")}mapGetResult(X,$){throw Error("Not implemented")}execute(X){if(this.mode==="async")return this[this.executeMethod](X);return new z5(()=>this[this.executeMethod](X))}mapResult(X,$){switch(this.executeMethod){case"run":return this.mapRunResult(X,$);case"all":return this.mapAllResult(X,$);case"get":return this.mapGetResult(X,$)}}}class V8{constructor(X){this.dialect=X}static[O]="SQLiteSession";prepareOneTimeQuery(X,$,Z,Y,G,J,_){return this.prepareQuery(X,$,Z,Y,G,J,_)}run(X){let $=this.dialect.sqlToQuery(X);try{return this.prepareOneTimeQuery($,void 0,"run",!1).run()}catch(Z){throw new v2({cause:Z,message:`Failed to run the query '${$.sql}'`})}}extractRawRunValueFromBatchResult(X){return X}all(X){return this.prepareOneTimeQuery(this.dialect.sqlToQuery(X),void 0,"run",!1).all()}extractRawAllValueFromBatchResult(X){throw Error("Not implemented")}get(X){return this.prepareOneTimeQuery(this.dialect.sqlToQuery(X),void 0,"run",!1).get()}extractRawGetValueFromBatchResult(X){throw Error("Not implemented")}values(X){return this.prepareOneTimeQuery(this.dialect.sqlToQuery(X),void 0,"run",!1).values()}async count(X){return(await this.values(X))[0][0]}extractRawValuesValueFromBatchResult(X){throw Error("Not implemented")}}class R8 extends r0{constructor(X,$,Z,Y,G=0){super(X,$,Z,Y);this.schema=Y,this.nestedIndex=G}static[O]="SQLiteTransaction";rollback(){throw new O4}}class i6 extends V8{constructor(X,$,Z,Y,G){super($);this.client=X,this.schema=Z,this.options=Y,this.tx=G,this.logger=Y.logger??new D4,this.cache=Y.cache??new t0}static[O]="LibSQLSession";logger;cache;prepareQuery(X,$,Z,Y,G,J,_){return new W5(this.client,X,this.logger,this.cache,J,_,$,this.tx,Z,Y,G)}async batch(X){let $=[],Z=[];for(let G of X){let J=G._prepare(),_=J.getQuery();$.push(J),Z.push({sql:_.sql,args:_.params})}return(await this.client.batch(Z)).map((G,J)=>$[J].mapResult(G,!0))}async migrate(X){let $=[],Z=[];for(let G of X){let J=G._prepare(),_=J.getQuery();$.push(J),Z.push({sql:_.sql,args:_.params})}return(await this.client.migrate(Z)).map((G,J)=>$[J].mapResult(G,!0))}async transaction(X,$){let Z=await this.client.transaction(),Y=new i6(this.client,this.dialect,this.schema,this.options,Z),G=new I8("async",this.dialect,Y,this.schema);try{let J=await X(G);return await Z.commit(),J}catch(J){throw await Z.rollback(),J}}extractRawAllValueFromBatchResult(X){return X.rows}extractRawGetValueFromBatchResult(X){return X.rows[0]}extractRawValuesValueFromBatchResult(X){return X.rows}}class I8 extends R8{static[O]="LibSQLTransaction";async transaction(X){let $=`sp${this.nestedIndex}`,Z=new I8("async",this.dialect,this.session,this.schema,this.nestedIndex+1);await this.session.run(A.raw(`savepoint ${$}`));try{let Y=await X(Z);return await this.session.run(A.raw(`release savepoint ${$}`)),Y}catch(Y){throw await this.session.run(A.raw(`rollback to savepoint ${$}`)),Y}}}class W5 extends U8{constructor(X,$,Z,Y,G,J,_,z,H,W,K){super("async",H,$,Y,G,J);this.client=X,this.logger=Z,this.fields=_,this.tx=z,this._isResponseInArrayMode=W,this.customResultMapper=K,this.customResultMapper=K,this.fields=_}static[O]="LibSQLPreparedQuery";async run(X){let $=D0(this.query.params,X??{});return this.logger.logQuery(this.query.sql,$),await this.queryWithCache(this.query.sql,$,async()=>{let Z={sql:this.query.sql,args:$};return this.tx?this.tx.execute(Z):this.client.execute(Z)})}async all(X){let{fields:$,logger:Z,query:Y,tx:G,client:J,customResultMapper:_}=this;if(!$&&!_){let H=D0(Y.params,X??{});return Z.logQuery(Y.sql,H),await this.queryWithCache(Y.sql,H,async()=>{let W={sql:Y.sql,args:H};return(G?G.execute(W):J.execute(W)).then(({rows:K})=>this.mapAllResult(K))})}let z=await this.values(X);return this.mapAllResult(z)}mapAllResult(X,$){if($)X=X.rows;if(!this.fields&&!this.customResultMapper)return X.map((Z)=>H5(Z));if(this.customResultMapper)return this.customResultMapper(X,c6);return X.map((Z)=>{return U4(this.fields,Array.prototype.slice.call(Z).map((Y)=>c6(Y)),this.joinsNotNullableMap)})}async get(X){let{fields:$,logger:Z,query:Y,tx:G,client:J,customResultMapper:_}=this;if(!$&&!_){let H=D0(Y.params,X??{});return Z.logQuery(Y.sql,H),await this.queryWithCache(Y.sql,H,async()=>{let W={sql:Y.sql,args:H};return(G?G.execute(W):J.execute(W)).then(({rows:K})=>this.mapGetResult(K))})}let z=await this.values(X);return this.mapGetResult(z)}mapGetResult(X,$){if($)X=X.rows;let Z=X[0];if(!this.fields&&!this.customResultMapper)return H5(Z);if(!Z)return;if(this.customResultMapper)return this.customResultMapper(X,c6);return U4(this.fields,Array.prototype.slice.call(Z).map((Y)=>c6(Y)),this.joinsNotNullableMap)}async values(X){let $=D0(this.query.params,X??{});return this.logger.logQuery(this.query.sql,$),await this.queryWithCache(this.query.sql,$,async()=>{let Z={sql:this.query.sql,args:$};return(this.tx?this.tx.execute(Z):this.client.execute(Z)).then(({rows:Y})=>Y)})}isResponseInArrayMode(){return this._isResponseInArrayMode}}function H5(X){return Object.keys(X).reduce(($,Z)=>{if(Object.prototype.propertyIsEnumerable.call(X,Z))$[Z]=X[Z];return $},{})}function c6(X){if(typeof ArrayBuffer<"u"&&X instanceof ArrayBuffer){if(typeof Buffer<"u"){if(!(X instanceof Buffer))return Buffer.from(X);return X}if(typeof TextDecoder<"u")return new TextDecoder().decode(X);throw Error("TextDecoder is not available. Please provide either Buffer or TextDecoder polyfill.")}return X}class A5 extends r0{static[O]="LibSQLDatabase";async batch(X){return this.session.batch(X)}}function H0(X,$={}){let Z=new z8({casing:$.casing}),Y;if($.logger===!0)Y=new K4;else if($.logger!==!1)Y=$.logger;let G;if($.schema){let z=FX($.schema,MX);G={fullSchema:$.schema,schema:z.tables,tableNamesMap:z.tableNamesMap}}let J=new i6(X,Z,G,{logger:Y,cache:$.cache},void 0),_=new A5("async",Z,J,G);if(_.$client=X,_.$cache=$.cache,_.$cache)_.$cache.invalidate=$.cache?.onMutate;return _}function n6(...X){if(typeof X[0]==="string"){let $=G0({url:X[0]});return H0($,X[1])}if(l8(X[0])){let{connection:$,client:Z,...Y}=X[0];if(Z)return H0(Z,Y);let G=typeof $==="string"?G0({url:$}):G0($);return H0(G,Y)}return H0(X[0],X[1])}((X)=>{function $(Z){return H0({},Z)}X.mock=$})(n6||(n6={}));class e0{client;db;dbName;constructor(X,$){this.dbName=X;try{let Z=a0.join(process.cwd(),".sylphx-flow");if(!l6.existsSync(Z))l6.mkdirSync(Z,{recursive:!0});let Y=a0.join(Z,`${X}.db`);this.client=G0({url:`file:${Y}`}),this.db=n6(this.client,{schema:$})}catch(Z){throw new N4(`Failed to initialize ${X} database connection`,{url:`file:${a0.join(process.cwd(),".sylphx-flow",`${X}.db`)}`},Z)}}async close(){}getDatabasePath(){return a0.join(process.cwd(),".sylphx-flow",`${this.dbName}.db`)}async createTable(X){try{await this.client.execute(X)}catch($){throw new e(`Failed to create table for ${this.dbName}`,`${this.dbName}.createTable`,$)}}async createIndex(X){try{await this.client.execute(X)}catch($){throw new e(`Failed to create index for ${this.dbName}`,`${this.dbName}.createIndex`,$)}}async tableExists(X){try{return(await this.client.execute(`
        SELECT name FROM sqlite_master 
        WHERE type='table' AND name='${X}'
      `)).rows.length>0}catch($){throw new e(`Failed to check if table ${X} exists`,`${this.dbName}.tableExists`,$)}}}var F8={};O5(F8,{tfidfTerms:()=>N1,tfidfIdf:()=>k1,tfidfDocuments:()=>S1,codebaseMetadata:()=>O1,codebaseFiles:()=>$1});var $1=O2("codebase_files_table",{path:u("path").primaryKey(),mtime:A2("mtime").notNull(),hash:u("hash").notNull(),content:u("content"),language:u("language"),size:A2("size"),indexedAt:u("indexed_at").notNull()},(X)=>[n1("idx_codebase_files_mtime").on(X.mtime),n1("idx_codebase_files_hash").on(X.hash)]),O1=O2("codebase_metadata_table",{key:u("key").primaryKey(),value:u("value").notNull()}),N1=O2("tfidf_terms_table",{filePath:u("file_path").notNull().references(()=>$1.path,{onDelete:"cascade"}),term:u("term").notNull(),frequency:J0("frequency").notNull()},(X)=>[g6({columns:[X.filePath,X.term]}),n1("idx_tfidf_terms_term").on(X.term),n1("idx_tfidf_terms_file").on(X.filePath)]),S1=O2("tfidf_documents_table",{filePath:u("file_path").primaryKey().references(()=>$1.path,{onDelete:"cascade"}),magnitude:J0("magnitude").notNull(),termCount:A2("term_count").notNull(),rawTerms:u("raw_terms").notNull()}),k1=O2("tfidf_idf_table",{term:u("term").primaryKey(),idfValue:J0("idf_value").notNull()});class M8 extends e0{constructor(){super("cache",F8)}async initialize(){try{if((await this.getMigrationStatus()).isMigrated){console.error("[INFO] Cache database tables already exist");return}await this.createTables(),console.error("[INFO] Cache database tables created")}catch(X){throw new e("Failed to initialize cache database","cache.initialize",X)}}async createTables(){await this.createTable(`
      CREATE TABLE IF NOT EXISTS codebase_files_table (
        path TEXT PRIMARY KEY,
        mtime INTEGER NOT NULL,
        hash TEXT NOT NULL,
        content TEXT,
        language TEXT,
        size INTEGER,
        indexed_at TEXT NOT NULL
      )
    `),await this.createTable(`
      CREATE TABLE IF NOT EXISTS codebase_metadata_table (
        key TEXT PRIMARY KEY,
        value TEXT NOT NULL
      )
    `),await this.createTable(`
      CREATE TABLE IF NOT EXISTS tfidf_documents_table (
        file_path TEXT PRIMARY KEY,
        magnitude REAL NOT NULL,
        term_count INTEGER NOT NULL,
        raw_terms TEXT NOT NULL,
        FOREIGN KEY (file_path) REFERENCES codebase_files_table(path) ON DELETE CASCADE
      )
    `),await this.createTable(`
      CREATE TABLE IF NOT EXISTS tfidf_idf_table (
        term TEXT PRIMARY KEY,
        idf_value REAL NOT NULL
      )
    `),await this.createTable(`
      CREATE TABLE IF NOT EXISTS tfidf_terms_table (
        file_path TEXT NOT NULL,
        term TEXT NOT NULL,
        frequency REAL NOT NULL,
        PRIMARY KEY (file_path, term),
        FOREIGN KEY (file_path) REFERENCES codebase_files_table(path) ON DELETE CASCADE
      )
    `),await this.createIndex(`
      CREATE INDEX IF NOT EXISTS idx_codebase_files_mtime ON codebase_files_table (mtime)
    `),await this.createIndex(`
      CREATE INDEX IF NOT EXISTS idx_codebase_files_hash ON codebase_files_table (hash)
    `),await this.createIndex(`
      CREATE INDEX IF NOT EXISTS idx_tfidf_terms_term ON tfidf_terms_table (term)
    `),await this.createIndex(`
      CREATE INDEX IF NOT EXISTS idx_tfidf_terms_file ON tfidf_terms_table (file_path)
    `)}async getMigrationStatus(){try{let X=["codebase_files_table","tfidf_terms_table","tfidf_documents_table"],$=0;for(let Z of X)if(await this.tableExists(Z))$++;return{isMigrated:$>=2,migrationCount:$}}catch(X){throw new e("Failed to check cache database migration status","cache.getMigrationStatus",X)}}async clearCache(){try{await this.client.execute("DELETE FROM tfidf_terms_table"),await this.client.execute("DELETE FROM tfidf_documents_table"),await this.client.execute("DELETE FROM tfidf_idf_table"),await this.client.execute("DELETE FROM codebase_files_table"),await this.client.execute("DELETE FROM codebase_metadata_table"),console.error("[INFO] Cache database cleared")}catch(X){throw new e("Failed to clear cache database","cache.clearCache",X)}}async healthCheck(){try{await this.client.execute("SELECT 1");let X=await this.getMigrationStatus(),$=await this.client.execute(`
        SELECT count(*) as count FROM codebase_files_table
      `);return{healthy:!0,details:{tablesExist:X.isMigrated,tableCount:X.migrationCount,cachedFiles:$.rows[0]?.count||0}}}catch(X){return{healthy:!1,error:X.message}}}async close(){}getDatabasePath(){let X=N8.join(process.cwd(),".sylphx-flow");return N8.join(X,"cache.db")}}class E8{cacheDb;cache;constructor(){this.cacheDb=new M8,this.cache=this.cacheDb.db}async initialize(){await this.cacheDb.initialize()}async setCodebaseFile(X){return k(`set codebase file: ${X.path}`,async()=>{await this.cache.insert($1).values(X).onConflictDoUpdate({target:$1.path,set:{mtime:X.mtime,hash:X.hash,content:X.content,language:X.language,size:X.size,indexedAt:X.indexedAt}})})}async getCodebaseFile(X){return k(`get codebase file: ${X}`,async()=>{let $=await this.cache.select().from($1).where(w($1.path,X)).limit(1);if($.length===0)return null;let Z=$[0];return{path:Z.path,mtime:Z.mtime,hash:Z.hash,content:Z.content||void 0,language:Z.language||void 0,size:Z.size||void 0,indexedAt:Z.indexedAt}})}async getAllCodebaseFiles(){return k("get all codebase files",async()=>{return(await this.cache.select().from($1).orderBy(U2($1.mtime))).map(($)=>({path:$.path,mtime:$.mtime,hash:$.hash,content:$.content||void 0,language:$.language||void 0,size:$.size||void 0,indexedAt:$.indexedAt}))})}async deleteCodebaseFile(X){return k(`delete codebase file: ${X}`,async()=>{let $=await this.cache.delete($1).where(w($1.path,X));return(await this.cache.select().from($1).where(w($1.path,X)).limit(1)).length===0})}async clearCodebaseFiles(){return k("clear codebase files",async()=>{await this.cache.delete($1)})}async setMetadata(X,$){return k(`set metadata: ${X}`,async()=>{await this.cache.insert(O1).values({key:X,value:$}).onConflictDoUpdate({target:O1.key,set:{value:$}})})}async getMetadata(X){return k(`get metadata: ${X}`,async()=>{let $=await this.cache.select().from(O1).where(w(O1.key,X)).limit(1);return $.length>0?$[0].value:null})}async getAllMetadata(){return k("get all metadata",async()=>{let X=await this.cache.select().from(O1),$={};for(let Z of X)$[Z.key]=Z.value;return $})}async deleteMetadata(X){return k(`delete metadata: ${X}`,async()=>{let $=await this.cache.delete(O1).where(w(O1.key,X));return(await this.cache.select().from(O1).where(w(O1.key,X)).limit(1)).length===0})}async setTfidfTerms(X){return k("set TF-IDF terms",async()=>{let $=[...new Set(X.map((Z)=>Z.filePath))];for(let Z of $)await this.cache.delete(N1).where(w(N1.filePath,Z));if(X.length>0)await this.cache.insert(N1).values(X)})}async getTfidfTerms(X){return k(`get TF-IDF terms for file: ${X}`,async()=>{return(await this.cache.select().from(N1).where(w(N1.filePath,X))).map((Z)=>({filePath:Z.filePath,term:Z.term,frequency:Z.frequency}))})}async getTfidfTermsByTerm(X){return k(`get TF-IDF terms by term: ${X}`,async()=>{return(await this.cache.select().from(N1).where(w(N1.term,X))).map((Z)=>({filePath:Z.filePath,term:Z.term,frequency:Z.frequency}))})}async clearTfidfTerms(){return k("clear TF-IDF terms",async()=>{await this.cache.delete(N1)})}async setTfidfDocument(X){return k(`set TF-IDF document: ${X.filePath}`,async()=>{await this.cache.insert(S1).values(X).onConflictDoUpdate({target:S1.filePath,set:{magnitude:X.magnitude,termCount:X.termCount,rawTerms:X.rawTerms}})})}async getTfidfDocument(X){return k(`get TF-IDF document: ${X}`,async()=>{let $=await this.cache.select().from(S1).where(w(S1.filePath,X)).limit(1);if($.length===0)return null;let Z=$[0];return{filePath:Z.filePath,magnitude:Z.magnitude,termCount:Z.termCount,rawTerms:Z.rawTerms}})}async getAllTfidfDocuments(){return k("get all TF-IDF documents",async()=>{return(await this.cache.select().from(S1)).map(($)=>({filePath:$.filePath,magnitude:$.magnitude,termCount:$.termCount,rawTerms:$.rawTerms}))})}async clearTfidfDocuments(){return k("clear TF-IDF documents",async()=>{await this.cache.delete(S1)})}async setTfidfIdf(X){return k(`set TF-IDF IDF: ${X.term}`,async()=>{await this.cache.insert(k1).values(X).onConflictDoUpdate({target:k1.term,set:{idfValue:X.idfValue}})})}async getTfidfIdf(X){return k(`get TF-IDF IDF: ${X}`,async()=>{let $=await this.cache.select().from(k1).where(w(k1.term,X)).limit(1);if($.length===0)return null;let Z=$[0];return{term:Z.term,idfValue:Z.idfValue}})}async getAllTfidfIdf(){return k("get all TF-IDF IDF values",async()=>{return(await this.cache.select().from(k1)).map(($)=>({term:$.term,idfValue:$.idfValue}))})}async clearTfidfIdf(){return k("clear TF-IDF IDF values",async()=>{await this.cache.delete(k1)})}async getStats(){return k("get cache statistics",async()=>{let[X,$,Z,Y,G]=await Promise.all([this.cache.select({count:t1()}).from($1),this.cache.select({count:t1()}).from(O1),this.cache.select({count:t1()}).from(N1),this.cache.select({count:t1()}).from(S1),this.cache.select({count:t1()}).from(k1)]);return{codebaseFiles:X[0]?.count||0,metadataEntries:$[0]?.count||0,tfidfTerms:Z[0]?.count||0,tfidfDocuments:Y[0]?.count||0,tfidfIdfValues:G[0]?.count||0}})}async clearAll(){return k("clear all cache data",async()=>{await Promise.all([this.cache.delete($1),this.cache.delete(O1),this.cache.delete(N1),this.cache.delete(S1),this.cache.delete(k1)])})}}import*as o6 from"node:path";var x8={};O5(x8,{memory:()=>B});var B=O2("memory_table",{key:u("key").notNull(),namespace:u("namespace").notNull().default("default"),value:u("value").notNull(),timestamp:A2("timestamp").notNull(),created_at:u("created_at").notNull(),updated_at:u("updated_at").notNull()},(X)=>[g6({columns:[X.key,X.namespace]}),n1("idx_memory_namespace").on(X.namespace),n1("idx_memory_timestamp").on(X.timestamp),n1("idx_memory_key").on(X.key)]);class P8 extends e0{constructor(){super("memory",x8)}async initialize(){try{if((await this.getMigrationStatus()).isMigrated){console.error("[INFO] Memory database tables already exist");return}let $=o6.join(process.cwd(),"drizzle","memory");await this.createTables(),console.error("[INFO] Memory database tables created")}catch(X){throw new e("Failed to initialize memory database","memory.initialize",X)}}async createTables(){await this.createTable(`
        CREATE TABLE IF NOT EXISTS memory_table (
          key TEXT NOT NULL,
          namespace TEXT NOT NULL DEFAULT 'default',
          value TEXT NOT NULL,
          timestamp INTEGER NOT NULL,
          created_at TEXT NOT NULL,
          updated_at TEXT NOT NULL,
          PRIMARY KEY (key, namespace)
        )
      `),await this.createIndex(`
        CREATE INDEX IF NOT EXISTS idx_memory_namespace ON memory_table (namespace)
      `),await this.createIndex(`
        CREATE INDEX IF NOT EXISTS idx_memory_timestamp ON memory_table (timestamp)
      `),await this.createIndex(`
        CREATE INDEX IF NOT EXISTS idx_memory_key ON memory_table (key)
      `)}async getMigrationStatus(){try{let X=await this.tableExists("memory_table");return{isMigrated:X,migrationCount:X?1:0}}catch(X){throw new e("Failed to check memory database migration status","memory.getMigrationStatus",X)}}async healthCheck(){try{await this.client.execute("SELECT 1");let X=await this.getMigrationStatus(),$=await this.client.execute(`
        SELECT count(*) as count FROM memory_table
      `);return{healthy:!0,details:{tablesExist:X.isMigrated,memoryEntries:$.rows[0]?.count||0}}}catch(X){return{healthy:!1,error:X.message}}}async close(){}getDatabasePath(){let X=o6.join(process.cwd(),".sylphx-flow");return o6.join(X,"memory.db")}}class Q8{memoryDb;memory;constructor(){this.memoryDb=new P8,this.memory=this.memoryDb.db}async initialize(){await this.memoryDb.initialize()}safeSerialize(X){try{return JSON.stringify(X)}catch($){throw Error(`Failed to serialize value: ${$.message}`)}}safeDeserialize(X){try{return JSON.parse(X)}catch($){throw Error(`Failed to deserialize value: ${$.message}`)}}async set(X,$,Z="default"){let Y=`Failed to set memory entry: ${Z}:${X}`;try{let G=new Date().toISOString(),J=Date.now(),_=this.safeSerialize($);if((await this.memory.select().from(B).where(V1(w(B.key,X),w(B.namespace,Z))).limit(1)).length>0)await this.memory.update(B).set({value:_,timestamp:J,updated_at:G}).where(V1(w(B.key,X),w(B.namespace,Z)));else await this.memory.insert(B).values({key:X,namespace:Z,value:_,timestamp:J,created_at:G,updated_at:G})}catch(G){throw Error(`${Y}: ${G.message}`)}}async get(X,$="default"){let Z=`Failed to get memory entry: ${$}:${X}`;try{let Y=await this.memory.select().from(B).where(V1(w(B.key,X),w(B.namespace,$))).limit(1);if(Y.length===0)return null;let G=Y[0];return{key:G.key,namespace:G.namespace,value:this.safeDeserialize(G.value),timestamp:G.timestamp,created_at:G.created_at,updated_at:G.updated_at}}catch(Y){throw Error(`${Z}: ${Y.message}`)}}async getAll(X){try{let Z=this.memory.select().from(B);if(X&&X!=="all")Z=Z.where(w(B.namespace,X));return(await Z.orderBy(U2(B.timestamp))).map((G)=>({key:G.key,namespace:G.namespace,value:this.safeDeserialize(G.value),timestamp:G.timestamp,created_at:G.created_at,updated_at:G.updated_at}))}catch(Z){throw Error(`Failed to get all memory entries: ${Z.message}`)}}async search(X,$){let Z=`Failed to search memory entries: ${X}`;try{let Y=this.memory.select().from(B).where(F0(D2(B.key,`%${X}%`),D2(B.value,`%${X}%`)));if($&&$!=="all")Y=Y.where(V1(w(B.namespace,$),F0(D2(B.key,`%${X}%`),D2(B.value,`%${X}%`))));return(await Y.orderBy(U2(B.timestamp))).map((J)=>({key:J.key,namespace:J.namespace,value:this.safeDeserialize(J.value),timestamp:J.timestamp,created_at:J.created_at,updated_at:J.updated_at}))}catch(Y){throw Error(`${Z}: ${Y.message}`)}}async delete(X,$="default"){let Z=`Failed to delete memory entry: ${$}:${X}`;try{let Y=await this.memory.delete(B).where(V1(w(B.key,X),w(B.namespace,$)));return(await this.memory.select().from(B).where(V1(w(B.key,X),w(B.namespace,$))).limit(1)).length===0}catch(Y){throw Error(`${Z}: ${Y.message}`)}}async clear(X="default"){let $=`Failed to clear memory namespace: ${X}`;try{await this.memory.delete(B).where(w(B.namespace,X))}catch(Z){throw Error(`${$}: ${Z.message}`)}}async getStats(X){try{let Z=this.memory.select({count:t1()}).from(B);if(X&&X!=="all")Z=Z.where(w(B.namespace,X));let G=(await Z)[0]?.count||0,_=(await this.memory.selectDistinct({namespace:B.namespace}).from(B)).map((z)=>z.namespace);return{totalEntries:G,namespaces:_}}catch(Z){throw Error(`Failed to get memory statistics: ${Z.message}`)}}}class j8{memoryStorage;cacheStorage;constructor(){this.memoryStorage=new Q8,this.cacheStorage=new E8}async initialize(){await Promise.all([this.memoryStorage.initialize(),this.cacheStorage.initialize()])}async set(X,$,Z="default"){return this.memoryStorage.set(X,$,Z)}async get(X,$="default"){return this.memoryStorage.get(X,$)}async getAll(X){return this.memoryStorage.getAll(X)}async search(X,$){return this.memoryStorage.search(X,$)}async delete(X,$="default"){return this.memoryStorage.delete(X,$)}async clear(X="default"){return this.memoryStorage.clear(X)}async getStats(X){return this.memoryStorage.getStats(X)}async setCodebaseFile(X,$,Z,Y,G,J){let _=new Date().toISOString();return this.cacheStorage.setCodebaseFile({path:X,mtime:$,hash:Z,content:Y,language:G,size:J,indexedAt:_})}async getCodebaseFile(X){return this.cacheStorage.getCodebaseFile(X)}async getAllCodebaseFiles(){return this.cacheStorage.getAllCodebaseFiles()}async deleteCodebaseFile(X){return this.cacheStorage.deleteCodebaseFile(X)}async clearCodebaseFiles(){return this.cacheStorage.clearCodebaseFiles()}async setMetadata(X,$){return this.cacheStorage.setMetadata(X,$)}async getMetadata(X){return this.cacheStorage.getMetadata(X)}async getAllMetadata(){return this.cacheStorage.getAllMetadata()}async deleteMetadata(X){return this.cacheStorage.deleteMetadata(X)}async setTfidfTerms(X){return this.cacheStorage.setTfidfTerms(X)}async getTfidfTerms(X){return this.cacheStorage.getTfidfTerms(X)}async getTfidfTermsByTerm(X){return this.cacheStorage.getTfidfTermsByTerm(X)}async clearTfidfTerms(){return this.cacheStorage.clearTfidfTerms()}async setTfidfDocument(X,$,Z,Y){return this.cacheStorage.setTfidfDocument({filePath:X,magnitude:$,termCount:Z,rawTerms:Y})}async getTFIDFDocument(X){return this.cacheStorage.getTfidfDocument(X)}async getAllTfidfDocuments(){return this.cacheStorage.getAllTfidfDocuments()}async clearTfidfDocuments(){return this.cacheStorage.clearTfidfDocuments()}async setTfidfIdf(X,$){return this.cacheStorage.setTfidfIdf({term:X,idfValue:$})}async getTfidfIdf(X){return this.cacheStorage.getTfidfIdf(X)}async getAllTfidfIdf(){return this.cacheStorage.getAllTfidfIdf()}async clearTfidfIdf(){return this.cacheStorage.clearTfidfIdf()}async getCacheStats(){return this.cacheStorage.getStats()}async clearAllCache(){return this.cacheStorage.clearAll()}async getAllStats(){let[X,$]=await Promise.all([this.memoryStorage.getStats(),this.cacheStorage.getStats()]);return{memory:X,cache:$}}async clearAll(){await Promise.all([this.memoryStorage.clear("default"),this.cacheStorage.clearAll()])}async getCodebaseIndexStats(){let X=await this.cacheStorage.getAllMetadata();return{indexedAt:X.indexedAt,totalFiles:Number.parseInt(X.totalFiles||"0"),totalTerms:Number.parseInt(X.totalTerms||"0")}}async getIDFValues(){return this.cacheStorage.getAllTfidfIdf()}async upsertTFIDFDocument(X,$){return this.cacheStorage.setTfidfDocument({filePath:X,magnitude:$.magnitude,termCount:$.termCount,rawTerms:JSON.stringify($.rawTerms)})}async upsertCodebaseFile(X){return this.cacheStorage.setCodebaseFile({...X,indexedAt:X.indexedAt||new Date().toISOString()})}async setIDFValues(X){let $=Object.entries(X).map(([Z,Y])=>this.cacheStorage.setTfidfIdf({term:Z,idfValue:Y}));await Promise.all($)}async clearCodebaseIndex(){await Promise.all([this.cacheStorage.clearCodebaseFiles(),this.cacheStorage.clearTfidfTerms(),this.cacheStorage.clearTfidfDocuments(),this.cacheStorage.clearTfidfIdf()])}async getCodebaseMetadata(X){return this.cacheStorage.getMetadata(X)}async setCodebaseMetadata(X,$){return this.cacheStorage.setMetadata(X,$)}async setTFIDFTerms(X,$){let Z=Object.entries($).map(([Y,G])=>({filePath:X,term:Y,frequency:G}));return this.cacheStorage.setTfidfTerms(Z)}}class K5{memoryStorage;knowledgeIndexer=Y4();embeddingProvider;constructor(){this.memoryStorage=new j8}async initialize(){if(await this.memoryStorage.initialize(),!this.embeddingProvider)this.embeddingProvider=await(await import("./embeddings-gq1xjrz4.js")).getDefaultEmbeddingProvider();this.knowledgeIndexer=Y4(this.embeddingProvider)}async getStatus(){let X=await this.memoryStorage.getAllCodebaseFiles(),$=await this.memoryStorage.getCodebaseIndexStats(),Z=this.knowledgeIndexer.getStatus(),Y=!1,G=0;try{let J=await this.knowledgeIndexer.loadIndex();Y=!0,G=J.totalDocuments}catch{}return{codebase:{indexed:X.length>0,fileCount:X.length,indexedAt:$.indexedAt},knowledge:{indexed:Y,documentCount:G,isIndexing:Z.isIndexing,progress:Z.progress}}}async searchCodebase(X,$={}){let{limit:Z=10,include_content:Y=!0,file_extensions:G,path_filter:J,exclude_paths:_,min_score:z=0.1}=$,H=await this.memoryStorage.getAllCodebaseFiles();if(H.length===0)throw Error('Codebase not indexed yet. Run "sylphx search reindex" first.');let W=H;if(G?.length)W=W.filter((M)=>G.some((R)=>M.path.endsWith(R)));if(J)W=W.filter((M)=>M.path.includes(J));if(_?.length)W=W.filter((M)=>!_.some((R)=>M.path.includes(R)));if(W.length===0)return{results:[],totalIndexed:H.length,query:X};let K=await this.buildSearchIndex(W);if(!K)throw Error("No searchable content found");let U=await a6(X,K,{limit:Z,minScore:z}),F=[];for(let M of U){let R=M.uri?.replace("file://","")||"Unknown",I="";if(Y){let E=await this.memoryStorage.getCodebaseFile(R);if(E?.content){if(I=E.content.substring(0,500),E.content.length>500)I+="..."}}F.push({uri:M.uri,score:M.score||0,title:R.split("/").pop()||R,content:Y?I:void 0})}return{results:F,totalIndexed:H.length,query:X}}async searchKnowledge(X,$={}){let{limit:Z=10,include_content:Y=!0}=$;try{let G=await this.knowledgeIndexer.loadIndex();return{results:(await a6(X,G,{limit:Z})).map((z)=>({uri:z.uri,score:z.score||0,title:z.uri?.split("/").pop()||"Unknown",content:Y?"":void 0})),totalIndexed:G.totalDocuments,query:X}}catch{throw Error("Knowledge base not indexed yet")}}async buildSearchIndex(X){try{let $=[];for(let G of X){let J=await this.memoryStorage.getTFIDFDocument(G.path);if(J){let _=J.rawTerms||{},z=new Map,H=new Map;for(let[W,K]of Object.entries(_))z.set(W,K),H.set(W,K);$.push({uri:`file://${G.path}`,terms:z,rawTerms:H,magnitude:J.magnitude})}}if($.length===0)return null;let Z=await this.memoryStorage.getIDFValues(),Y=new Map;for(let G of Z)if(G.term&&G.idfValue!==void 0)Y.set(G.term,G.idfValue);return{documents:$,idf:Y,totalDocuments:$.length,metadata:{generatedAt:new Date().toISOString(),version:"1.0.0"}}}catch($){return console.error("[ERROR] Failed to build search index:",$),null}}formatResultsForCLI(X,$,Z){if(X.length===0)return`\uD83D\uDCED No results found for "${$}"

**Total indexed files:** ${Z}`;let Y=`✓ Found ${X.length} result(s) for "${$}":

`,G=X.map((J,_)=>{let z=`${_+1}. **${J.title}** (Score: ${J.score.toFixed(3)})`;if(J.uri.startsWith("file://")){let H=J.uri.replace("file://","");z+=`
   \uD83D\uDCC1 Path: \`${H}\``}else if(J.uri.startsWith("knowledge://"))z+=`
   \uD83D\uDCDA Source: ${J.uri}`;else z+=`
   \uD83D\uDD17 URI: ${J.uri}`;if(J.content)z+=`
   \`\`\`
${J.content}
\`\`\``;return z}).join(`

`);return Y+G}formatResultsForMCP(X,$,Z){let Y=`Found ${X.length} result(s) for "${$}":

`,G=X.map((J,_)=>{let z=`${_+1}. **${J.title}** (Score: ${J.score.toFixed(3)})`;if(J.uri.startsWith("file://")){let H=J.uri.replace("file://","");z+=`
   \uD83D\uDCC1 Path: \`${H}\``}else if(J.uri.startsWith("knowledge://"))z+=`
   \uD83D\uDCDA URI: ${J.uri}`;else z+=`
   \uD83D\uDD17 URI: ${J.uri}`;if(J.content)z+=`
\`\`\`
${J.content}
\`\`\``;return z}).join(`

`);return{content:[{type:"text",text:Y+G}]}}async getAvailableKnowledgeURIs(){try{return(await this.knowledgeIndexer.loadIndex()).documents.map(($)=>$.uri)}catch{return[]}}}var QU=new K5;
export{A as b,w as c,V1 as d,D2 as e,U2 as f,t1 as g,e as h,w5 as i,N4 as j,k,G0 as l,A2 as m,J0 as n,u as o,O2 as p,n1 as q,g6 as r,n6 as s,j8 as t,C8 as u,QU as v};
