import{createRequire as g}from"node:module";var M=Object.create;var{getPrototypeOf:V,defineProperty:Q,getOwnPropertyNames:S}=Object;var b=Object.prototype.hasOwnProperty;var y=(A,E,B)=>{B=A!=null?M(V(A)):{};let H=E||!A||!A.__esModule?Q(B,"default",{value:A,enumerable:!0}):B;for(let J of S(A))if(!b.call(H,J))Q(H,J,{get:()=>A[J],enumerable:!0});return H};var k=(A,E)=>()=>(E||A((E={exports:{}}).exports,E),E.exports);var p=(A,E)=>{for(var B in E)Q(A,B,{get:E[B],enumerable:!0,configurable:!0,set:(H)=>E[B]=()=>H})};var T=g(import.meta.url);class W{options;technicalTerms;stopWords;contextModel;ngramFrequency;static PRECOMPILED_PATTERNS={camelCase:/\b[a-z]+[A-Z][a-zA-Z0-9]*\b/g,snakeCase:/\b[a-z][a-z0-9]*_[a-z0-9_]*\b/g,kebabCase:/\b[a-z][a-z0-9]*-[a-z0-9-]*\b/g,pascalCase:/\b[A-Z][a-zA-Z0-9]*[A-Z][a-zA-Z0-9]*\b/g,version:/\bv?(?:\d+\.)+\d+(?:-[a-zA-Z0-9]+)?\b/g,technical:/\b[A-Z]{2,}\b/g,numbers:/\b\d+(?:\.\d+)?[kmg]?b?\b/gi,filePath:/\b(?:\/|[a-zA-Z]:\\)[^\s<>:"|?*]+\b/g,identifiers:/\b[a-zA-Z_][a-zA-Z0-9_]*\b/g,methodCalls:/\b([a-zA-Z_][a-zA-Z0-9_]*)\s*\(/g,urls:/https?:\/\/[^\s<>"{}|\\^`\[\]]+/g,email:/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g,unicode:/[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]/gu};constructor(A={}){this.options={language:"en",preserveCase:!1,extractCamelCase:!0,extractTechnicalTerms:!0,useNgrams:!0,extractCompoundWords:!0,useContextualScoring:!0,codeAware:!0,minTokenLength:1,maxTokenLength:100,...A},this.initialize()}initialize(){this.technicalTerms=new Set(["function","class","const","let","var","import","export","default","async","await","promise","callback","interface","type","enum","react","vue","angular","component","hook","state","props","lifecycle","api","http","https","json","xml","yaml","config","env","database","query","index","cache","server","client","get","set","is","has","can","should","will","dir","file","path"]),this.stopWords=new Set(["the","be","to","of","and","a","in","that","have","i","it","for","not","on","with","he","as","you","do","at","this","but","his","by","from","over","was","will","with","this","but","they","have","had","what","when","where","who","which","why","how","is","are","as","at","be","by","for","from","has","he","in","is","it","its","of","on","that","the","to","was","will","with"]),this.contextModel=new Map,this.ngramFrequency=new Map,this.buildContextModel(),this.loadPretrainedNGrams()}tokenize(A){if(!A||A.trim().length===0)return[];let E=[],B=0;if(this.options.codeAware)E.push(...this.extractCodeTokens(A));if(E.push(...this.extractWordTokens(A)),this.options.extractTechnicalTerms)E.push(...this.extractTechnicalTokens(A));if(this.options.useNgrams)E.push(...this.extractNGrams(A));if(this.options.extractCompoundWords)E.push(...this.extractCompoundWords(A));return this.postProcessTokens(E)}extractCodeTokens(A){let E=[],B=[{regex:W.PRECOMPILED_PATTERNS.camelCase,type:"identifier"},{regex:W.PRECOMPILED_PATTERNS.snakeCase,type:"identifier"},{regex:W.PRECOMPILED_PATTERNS.pascalCase,type:"identifier"},{regex:W.PRECOMPILED_PATTERNS.version,type:"version"},{regex:W.PRECOMPILED_PATTERNS.methodCalls,type:"method"},{regex:W.PRECOMPILED_PATTERNS.urls,type:"url"},{regex:W.PRECOMPILED_PATTERNS.email,type:"email"}];if(this.options.extractTechnicalTerms)B.push({regex:W.PRECOMPILED_PATTERNS.technical,type:"technical"});for(let{regex:H,type:J}of B){let K;H.lastIndex=0;while((K=H.exec(A))!==null){let O=K[1]||K[0];if(O.length>=this.options.minTokenLength){let U=this.processCodeToken(O,K.index,J);E.push(...U)}}}return E}processCodeToken(A,E,B){let H=[];if(B==="identifier"&&/[a-z][A-Z]/.test(A)&&!this.options.preserveCase){let J=A.split(/(?=[A-Z])/);for(let K of J){if(K.length>=this.options.minTokenLength)H.push(this.createToken(K,"identifier",E));E+=K.length}}else if(B==="identifier"&&A.includes("_")&&!this.options.preserveCase){let J=A.split("_");for(let K of J){if(K.length>=this.options.minTokenLength)H.push(this.createToken(K,"identifier",E));E+=K.length+1}}else H.push(this.createToken(A,B,E));return H}extractWordTokens(A){let E=[],B=A.match(/\b[a-zA-Z]+\b/g)||[];for(let H of B)if(H.length>=this.options.minTokenLength&&H.length<=this.options.maxTokenLength&&!this.stopWords.has(H.toLowerCase()))E.push(this.createToken(H,"word",A.indexOf(H)));return E}extractTechnicalTokens(A){let E=[];for(let B of this.technicalTerms){let H=new RegExp(`\\b${B}\\b`,"gi"),J;while((J=H.exec(A))!==null)E.push(this.createToken(J[0],"technical",J.index))}return E}extractNGrams(A){let E=[],B=A.toLowerCase().split(/\s+/).filter((H)=>H.length>2);for(let H=2;H<=3;H++)for(let J=0;J<=B.length-H;J++){let K=B.slice(J,J+H).join(""),U=(this.ngramFrequency.get(K)||0)>0.1,$=B.slice(J,J+H).some((Y)=>this.technicalTerms.has(Y));if(U||$){let Y=A.toLowerCase().indexOf(K);E.push(this.createToken(K,"ngram",Y))}}return E}extractCompoundWords(A){let E=[],B=[/\b([a-z]+)([A-Z][a-z]+)\b/g,/\b(get|set|is|has|can|should|will)([A-Z][a-z]+)\b/gi];for(let H of B){let J;while((J=H.exec(A))!==null){let K=J[0],O=J.index;E.push(this.createToken(K.toLowerCase(),"compound",O))}}return E}createToken(A,E,B){let H=this.options.preserveCase?A:A.toLowerCase(),J={hasNumbers:/\d/.test(H),hasSymbols:/[^a-zA-Z0-9]/.test(H),caseType:this.detectCaseType(A),frequency:this.getWordFrequency(H),confidence:this.calculateConfidence(H,E)},K=this.calculateTokenScore(H,E,J);return{text:H,type:E,score:K,position:B,length:A.length,features:J}}detectCaseType(A){if(A===A.toUpperCase())return"upper";if(A===A.toLowerCase())return"lower";if(A.includes("_"))return"snake";if(/[A-Z]/.test(A)&&/[a-z]/.test(A))return"camel";return"mixed"}calculateConfidence(A,E){let B=0.5;if(A.length>=4&&A.length<=12)B+=0.2;if(E==="technical"||E==="identifier")B+=0.3;if(E==="keyword")B+=0.2;if(this.technicalTerms.has(A.toLowerCase()))B+=0.2;return Math.min(1,B)}calculateTokenScore(A,E,B){let H=0.5;if(A.length>6)H+=0.1;if(A.length>10)H+=0.1;if(E==="technical")H+=0.3;if(E==="identifier")H+=0.2;if(E==="version"||E==="url")H+=0.2;if(B.hasNumbers)H+=0.1;if(B.hasSymbols&&E!=="url")H+=0.1;if(B.frequency<10)H+=0.2;return Math.min(1,H)}getWordFrequency(A){return Math.floor(Math.random()*100)}postProcessTokens(A){let E=new Map;for(let B of A){let H=E.get(B.text);if(!H||B.score>H.score)E.set(B.text,B)}return Array.from(E.values()).sort((B,H)=>{if(H.score!==B.score)return H.score-B.score;return B.position-H.position}).filter((B)=>B.score>0.1)}buildContextModel(){let A={function:["(",")","{"],class:["{","constructor"],import:["from","as"],const:["=",";"],get:["(",")"],set:["(",")"],is:["(",")"],has:["(",")"]};for(let[E,B]of Object.entries(A))this.contextModel.set(E,B)}loadPretrainedNGrams(){let A={getuser:0.8,setstate:0.7,useeffect:0.9,componentdidmount:0.8,onclick:0.9};for(let[E,B]of Object.entries(A))this.ngramFrequency.set(E,B)}}async function f(A,E){try{let B=await A.getAllCodebaseFiles();if(E){if(E.file_extensions&&E.file_extensions.length>0)B=B.filter((O)=>E.file_extensions?.some((U)=>O.path.endsWith(U)));if(E.path_filter)B=B.filter((O)=>O.path.includes(E.path_filter));if(E.exclude_paths&&E.exclude_paths.length>0)B=B.filter((O)=>!E.exclude_paths?.some((U)=>O.path.includes(U)))}if(B.length===0)return null;let H=[];for(let O of B){let U=await A.getTFIDFDocument(O.path);if(U){let $=U.rawTerms||{},Y=new Map,L=new Map;for(let[Z,C]of Object.entries($))Y.set(Z,C),L.set(Z,C);H.push({uri:`file://${O.path}`,terms:Y,rawTerms:L,magnitude:U.magnitude})}}if(H.length===0)return null;let J=await A.getIDFValues(),K=new Map;for(let[O,U]of Object.entries(J))K.set(O,U);return{documents:H,idf:K,totalDocuments:H.length,metadata:{generatedAt:new Date().toISOString(),version:"1.0.0"}}}catch(B){return console.error("[ERROR] Failed to build search index from database:",B),null}}function j(A){let E=Array.from(A.values()).reduce((H,J)=>H+J,0),B=new Map;for(let[H,J]of A.entries())B.set(H,J/E);return B}function w(A,E){let B=new Map;for(let J of A){let K=new Set(J.keys());for(let O of K)B.set(O,(B.get(O)||0)+1)}let H=new Map;for(let[J,K]of B.entries())H.set(J,Math.log(E/K));return H}function I(A,E){let B=new Map;for(let[H,J]of A.entries()){let K=E.get(H)||0;B.set(H,J*K)}return B}function v(A){let E=0;for(let B of A.values())E+=B*B;return Math.sqrt(E)}function D(A){let B=new W({language:"en",extractCamelCase:!0,extractTechnicalTerms:!0,useNgrams:!0,extractCompoundWords:!0,useContextualScoring:!0,codeAware:!0}).tokenize(A),H=new Map;for(let J of B){let K=J.text.toLowerCase(),O=H.get(K)||0;H.set(K,O+J.score)}return H}function F(A){let B=new W({language:"en",extractCamelCase:!0,extractTechnicalTerms:!0,useNgrams:!1,extractCompoundWords:!1,useContextualScoring:!1,codeAware:!0}).tokenize(A),H=new Map;for(let J of B){let K=J.text.toLowerCase();if(!H.has(K)||J.score>0.8)H.set(K,J.text)}return Array.from(H.values())}function d(A){let E=A.map((J)=>({uri:J.uri,terms:D(J.content)})),B=w(E.map((J)=>J.terms),A.length);return{documents:E.map((J)=>{let K=j(J.terms),O=I(K,B),U=v(O);return{uri:J.uri,terms:O,rawTerms:J.terms,magnitude:U}}),idf:B,totalDocuments:A.length,metadata:{generatedAt:new Date().toISOString(),version:"2.0.0"}}}function h(A,E){let B=0;for(let[J,K]of A.entries()){let O=E.terms.get(J)||0;B+=K*O}let H=v(A);if(H===0||E.magnitude===0)return 0;return B/(H*E.magnitude)}function z(A,E){let B=D(A),H=j(B);return I(H,E)}function a(A,E,B={}){let{limit:H=10,minScore:J=0,boostFactors:K={}}=B,{exactMatch:O=1.5,phraseMatch:U=2,technicalMatch:$=1.8,identifierMatch:Y=1.3}=K,L=z(A,E.idf),Z=F(A).map((X)=>X.toLowerCase());return E.documents.map((X)=>{let _=h(L,X),N=[];for(let R of Z)if(X.rawTerms.has(R)){let G=O;if(P(R))G=Math.max(G,$);if(q(R))G=Math.max(G,Y);_*=G,N.push(R)}if(N.length===Z.length&&Z.length>1)_*=U;if(Z.length>3&&N.length>=Z.length*0.7)_*=1.2;return{uri:X.uri,score:_,matchedTerms:N}}).filter((X)=>X.score>=J).sort((X,_)=>_.score-X.score).slice(0,H)}function P(A){return[/\b[A-Z]{2,}\b/,/\b[A-Z][a-z]+(?:[A-Z][a-z]+)+\b/,/\b[a-z]+[A-Z][a-z]*\b/,/\b\w+(?:Dir|Config|File|Path|Data|Service|Manager|Handler)\b/,/\b(?:get|set|is|has|can|should|will|do)[A-Z]\w*\b/,/\b(?:http|https|json|xml|yaml|sql|api|url|uri)\b/].some((B)=>B.test(A))}function q(A){return/^[a-zA-Z][a-zA-Z0-9_]*$/.test(A)&&A.length>1}function c(A){let E={documents:A.documents.map((B)=>({uri:B.uri,terms:Array.from(B.terms.entries()),rawTerms:Array.from(B.rawTerms.entries()),magnitude:B.magnitude})),idf:Array.from(A.idf.entries()),totalDocuments:A.totalDocuments,metadata:A.metadata};return JSON.stringify(E,null,2)}function i(A){let E=JSON.parse(A);return{documents:E.documents.map((B)=>({uri:B.uri,terms:new Map(B.terms),rawTerms:new Map(B.rawTerms),magnitude:B.magnitude})),idf:new Map(E.idf),totalDocuments:E.totalDocuments,metadata:E.metadata}}export{c as serializeIndex,a as searchDocuments,z as processQuery,i as deserializeIndex,h as calculateCosineSimilarity,f as buildSearchIndexFromDB,d as buildSearchIndex};
export{y as a,k as b,p as c,T as d,d as e,a as f};
