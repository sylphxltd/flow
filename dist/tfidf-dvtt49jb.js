import{createRequire as S}from"node:module";var w=Object.create;var{getPrototypeOf:z,defineProperty:Q,getOwnPropertyNames:V}=Object;var b=Object.prototype.hasOwnProperty;var T=(B,G,E)=>{E=B!=null?w(z(B)):{};let H=G||!B||!B.__esModule?Q(E,"default",{value:B,enumerable:!0}):E;for(let J of V(B))if(!b.call(H,J))Q(H,J,{get:()=>B[J],enumerable:!0});return H};var f=(B,G)=>()=>(G||B((G={exports:{}}).exports,G),G.exports);var l=(B,G)=>{for(var E in G)Q(B,E,{get:G[E],enumerable:!0,configurable:!0,set:(H)=>G[E]=()=>H})};var u=S(import.meta.url);class j{initialized=!1;constructor(B={}){}async initialize(){if(this.initialized)return;await new Promise((B)=>setTimeout(B,10)),this.initialized=!0}async tokenize(B){if(!this.initialized)await this.initialize();let G=Date.now();try{let E=this.extractCodeTokens(B),H=this.calculateScores(E,B),J=Date.now()-G;return{tokens:H,metadata:{totalTokens:H.length,vocabSize:32000,processingTime:J,averageConfidence:this.calculateAverageConfidence(H)},raw:{inputIds:H.map((K)=>K.id),decodedText:B}}}catch(E){throw Error(`Tokenization failed: ${E.message}`)}}extractCodeTokens(B){let G=[],E=0,H=B.replace(/[{}()\[\];,<\.>]/g," $& ").split(/\s+/).filter((N)=>N.length>0&&N.length<=50),J=1000;for(let N=0;N<Math.min(H.length,J);N++){let O=H[N];G.push({text:O,id:E++,score:0.5,confidence:0.9,relevance:"medium"})}let K=this.extractTechnicalTerms(B);for(let N of K.slice(0,100)){let O=G.find((X)=>X.text.toLowerCase()===N.toLowerCase());if(O)O.score=Math.min(O.score+0.3,1),O.confidence=Math.min(O.confidence+0.1,1),O.relevance=this.determineRelevance(O.score);else if(G.length<J)G.push({text:N,id:E++,score:0.8,confidence:0.95,relevance:"high"})}return G}extractTechnicalTerms(B){let G=[],E=[/\b[A-Z]{2,}\b/g,/\b[a-z]+[A-Z][a-zA-Z]*\b/g,/\b[a-z]+_[a-z_]+\b/g,/\bv?\d+\.\d+\.\d+(-[a-zA-Z0-9]+)?\b/g,/\b(?:\/|[a-zA-Z]:\\\\)[^\s<>:"|?*]*\b/g,/https?:\/\/[^\s<>"]+/g,/\b(async|await|function|class|const|let|var|import|export|return|throw|try|catch|finally|interface|type|enum|Promise|Array|Object|String|Number|Boolean)\b/g];for(let H of E){let J=B.match(H);if(J)G.push(...J)}return[...new Set(G)]}calculateScores(B,G){let E=[];for(let H of B){let J=H.score;if(this.isTechnicalTerm(H.text))J+=0.2;if(H.text.length>6)J+=0.1;if(H.text.length>10)J+=0.1;let K=this.calculateTokenFrequency(H.text,G);if(K===1)J+=0.2;else if(K>=5)J-=0.1;if(this.isStructuralToken(H.text))J+=0.15;E.push({...H,score:Math.min(J,1),relevance:this.determineRelevance(J)})}return E.sort((H,J)=>J.score-H.score)}isTechnicalTerm(B){return/^[A-Z]{2,}$/.test(B)||/^[a-z]+[A-Z]/.test(B)||/^[a-z]+_[a-z_]+$/.test(B)||/^v?\d+\.\d+\.\d+/.test(B)||/^(async|await|function|class|const|let|var|import|export|return|throw|try|catch|finally|interface|type|enum)$/.test(B)}isStructuralToken(B){return/^[\{\}\(\)\[\];,<\.>]$/.test(B)}calculateTokenFrequency(B,G){let E=new RegExp(this.escapeRegExp(B),"g"),H=G.match(E);return H?H.length:0}escapeRegExp(B){return B.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}determineRelevance(B){if(B>=0.8)return"high";if(B>=0.5)return"medium";return"low"}calculateAverageConfidence(B){if(B.length===0)return 0;return B.reduce((E,H)=>E+H.confidence,0)/B.length}async getTopTokens(B,G=20,E=0.3){return(await this.tokenize(B)).tokens.filter((J)=>J.score>=E).slice(0,G)}async getTechnicalTokens(B){return(await this.tokenize(B)).tokens.filter((E)=>this.isTechnicalTerm(E.text)||E.relevance==="high")}async decode(B){if(!this.initialized)throw Error("Tokenizer not initialized. Call initialize() first.");return B.map((G)=>`token_${G}`).join(" ")}async encode(B){if(!this.initialized)throw Error("Tokenizer not initialized. Call initialize() first.");return B.split("").map((G,E)=>G.charCodeAt(0)+E)}}async function i(B,G){try{let E=await B.getAllCodebaseFiles();if(G){if(G.file_extensions&&G.file_extensions.length>0)E=E.filter((N)=>G.file_extensions?.some((O)=>N.path.endsWith(O)));if(G.path_filter)E=E.filter((N)=>N.path.includes(G.path_filter));if(G.exclude_paths&&G.exclude_paths.length>0)E=E.filter((N)=>!G.exclude_paths?.some((O)=>N.path.includes(O)))}if(E.length===0)return null;let H=[];for(let N of E){let O=await B.getTFIDFDocument(N.path);if(O){let X=O.rawTerms||{},_=new Map,$=new Map;for(let[W,C]of Object.entries(X))_.set(W,C),$.set(W,C);H.push({uri:`file://${N.path}`,terms:_,rawTerms:$,magnitude:O.magnitude})}}if(H.length===0)return null;let J=await B.getIDFValues(),K=new Map;for(let[N,O]of Object.entries(J))K.set(N,O);return{documents:H,idf:K,totalDocuments:H.length,metadata:{generatedAt:new Date().toISOString(),version:"1.0.0"}}}catch(E){return console.error("[ERROR] Failed to build search index from database:",E),null}}function v(B){let G=Array.from(B.values()).reduce((H,J)=>H+J,0),E=new Map;for(let[H,J]of B.entries())E.set(H,J/G);return E}function h(B,G){let E=new Map;for(let J of B){let K=new Set(J.keys());for(let N of K)E.set(N,(E.get(N)||0)+1)}let H=new Map;for(let[J,K]of E.entries())H.set(J,Math.log(G/K));return H}function D(B,G){let E=new Map;for(let[H,J]of B.entries()){let K=G.get(H)||0;E.set(H,J*K)}return E}function M(B){let G=0;for(let E of B.values())G+=E*E;return Math.sqrt(G)}var R=null,P=!1;async function p(){if(!R)R=new j({modelPath:"./models/starcoder2"});if(!P){let B=console.log;console.log=()=>{};try{await R.initialize(),P=!0}finally{console.log=B}}return R}async function I(B){let E=await(await p()).tokenize(B),H=new Map;for(let J of E.tokens){let K=J.text.toLowerCase(),N=H.get(K)||0;H.set(K,N+J.score)}return H}async function F(B){let E=await(await p()).tokenize(B),H=new Map;for(let J of E.tokens){let K=J.text.toLowerCase();if(!H.has(K)||J.score>0.8)H.set(K,J.text)}return Array.from(H.values())}async function s(B){console.log("\uD83D\uDD24 Building search index with advanced tokenizer...");let G=B.map(async(K)=>({uri:K.uri,terms:await I(K.content)})),E=await Promise.all(G),H=h(E.map((K)=>K.terms),B.length),J=E.map((K)=>{let N=v(K.terms),O=D(N,H),X=M(O);return{uri:K.uri,terms:O,rawTerms:K.terms,magnitude:X}});return console.log(`âœ… Search index built with ${J.length} documents, ${H.size} unique terms`),{documents:J,idf:H,totalDocuments:B.length,metadata:{generatedAt:new Date().toISOString(),version:"5.0.0",tokenizer:"AdvancedCodeTokenizer",features:["Industry-leading code understanding","Advanced technical term recognition","Optimized for code search","Simple and effective approach","No unnecessary complexity"]}}}function g(B,G){let E=0;for(let[J,K]of B.entries()){let N=G.terms.get(J)||0;E+=K*N}let H=M(B);if(H===0||G.magnitude===0)return 0;return E/(H*G.magnitude)}async function x(B,G){let E=await I(B),H=v(E);return D(H,G)}async function c(B,G,E={}){let{limit:H=10,minScore:J=0,boostFactors:K={}}=E,{exactMatch:N=1.5,phraseMatch:O=2,technicalMatch:X=1.8,identifierMatch:_=1.3}=K,$=await x(B,G.idf),W=(await F(B)).map((U)=>U.toLowerCase());return G.documents.map((U)=>{let Y=g($,U),A=[];for(let L of W)if(U.rawTerms.has(L)){let Z=N;if(y(L))Z=Math.max(Z,X);if(q(L))Z=Math.max(Z,_);Y*=Z,A.push(L)}if(A.length===W.length&&W.length>1)Y*=O;if(W.length>3&&A.length>=W.length*0.7)Y*=1.2;return{uri:U.uri,score:Y,matchedTerms:A}}).filter((U)=>U.score>=J).sort((U,Y)=>Y.score-U.score).slice(0,H)}function y(B){return[/\b[A-Z]{2,}\b/,/\b[A-Z][a-z]+(?:[A-Z][a-z]+)+\b/,/\b[a-z]+[A-Z][a-z]*\b/,/\b\w+(?:Dir|Config|File|Path|Data|Service|Manager|Handler)\b/,/\b(?:get|set|is|has|can|should|will|do)[A-Z]\w*\b/,/\b(?:http|https|json|xml|yaml|sql|api|url|uri)\b/].some((E)=>E.test(B))}function q(B){return/^[a-zA-Z][a-zA-Z0-9_]*$/.test(B)&&B.length>1}function n(B){let G={documents:B.documents.map((E)=>({uri:E.uri,terms:Array.from(E.terms.entries()),rawTerms:Array.from(E.rawTerms.entries()),magnitude:E.magnitude})),idf:Array.from(B.idf.entries()),totalDocuments:B.totalDocuments,metadata:B.metadata};return JSON.stringify(G,null,2)}function r(B){let G=JSON.parse(B);return{documents:G.documents.map((E)=>({uri:E.uri,terms:new Map(E.terms),rawTerms:new Map(E.rawTerms),magnitude:E.magnitude})),idf:new Map(G.idf),totalDocuments:G.totalDocuments,metadata:G.metadata}}export{n as serializeIndex,c as searchDocuments,x as processQuery,r as deserializeIndex,g as calculateCosineSimilarity,i as buildSearchIndexFromDB,s as buildSearchIndex};
export{T as a,f as b,l as c,u as d,s as e,c as f};
